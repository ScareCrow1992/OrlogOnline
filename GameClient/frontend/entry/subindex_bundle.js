import*as e from"three";import*as t from"cannon";import*as i from"gsap";import*as s from"three/addons/geometries/RoundedBoxGeometry.js";import*as o from"three/addons/controls/OrbitControls.js";import*as r from"three/addons/curves/CurveExtras.js";import*as a from"three/addons/geometries/TextGeometry.js";import*as n from"three/addons/loaders/GLTFLoader.js";import*as h from"three/addons/loaders/SVGLoader.js";import*as l from"three/addons/loaders/FontLoader.js";import*as c from"three/addons/postprocessing/EffectComposer.js";import*as d from"three/addons/postprocessing/RenderPass.js";import*as u from"three/addons/postprocessing/ShaderPass.js";import*as m from"three/addons/postprocessing/OutlinePass.js";import*as p from"three/addons/shaders/FXAAShader.js";import*as _ from"three/addons/shaders/GammaCorrectionShader.js";import*as g from"three/addons/postprocessing/UnrealBloomPass.js";import*as f from"three/addons/postprocessing/AfterimagePass.js";var x={d:(e,t)=>{for(var i in t)x.o(t,i)&&!x.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const y=(v={ACESFilmicToneMapping:()=>e.ACESFilmicToneMapping,AdditiveBlending:()=>e.AdditiveBlending,Audio:()=>e.Audio,AudioListener:()=>e.AudioListener,AudioLoader:()=>e.AudioLoader,BoxGeometry:()=>e.BoxGeometry,BufferAttribute:()=>e.BufferAttribute,BufferGeometry:()=>e.BufferGeometry,CanvasTexture:()=>e.CanvasTexture,CatmullRomCurve3:()=>e.CatmullRomCurve3,CineonToneMapping:()=>e.CineonToneMapping,Color:()=>e.Color,CubeTextureLoader:()=>e.CubeTextureLoader,CylinderGeometry:()=>e.CylinderGeometry,DirectionalLight:()=>e.DirectionalLight,DoubleSide:()=>e.DoubleSide,Euler:()=>e.Euler,ExtrudeGeometry:()=>e.ExtrudeGeometry,Group:()=>e.Group,InstancedBufferAttribute:()=>e.InstancedBufferAttribute,InstancedMesh:()=>e.InstancedMesh,Layers:()=>e.Layers,LinearSRGBColorSpace:()=>e.LinearSRGBColorSpace,LinearToneMapping:()=>e.LinearToneMapping,MathUtils:()=>e.MathUtils,Matrix3:()=>e.Matrix3,Matrix4:()=>e.Matrix4,Mesh:()=>e.Mesh,MeshBasicMaterial:()=>e.MeshBasicMaterial,MeshStandardMaterial:()=>e.MeshStandardMaterial,NoToneMapping:()=>e.NoToneMapping,NormalBlending:()=>e.NormalBlending,Object3D:()=>e.Object3D,PCFSoftShadowMap:()=>e.PCFSoftShadowMap,PerspectiveCamera:()=>e.PerspectiveCamera,PlaneGeometry:()=>e.PlaneGeometry,Points:()=>e.Points,PointsMaterial:()=>e.PointsMaterial,Quaternion:()=>e.Quaternion,Raycaster:()=>e.Raycaster,ReinhardToneMapping:()=>e.ReinhardToneMapping,RepeatWrapping:()=>e.RepeatWrapping,RingGeometry:()=>e.RingGeometry,Scene:()=>e.Scene,ShaderMaterial:()=>e.ShaderMaterial,ShapeGeometry:()=>e.ShapeGeometry,Sprite:()=>e.Sprite,SpriteMaterial:()=>e.SpriteMaterial,TextureLoader:()=>e.TextureLoader,TorusGeometry:()=>e.TorusGeometry,TubeGeometry:()=>e.TubeGeometry,Vector2:()=>e.Vector2,Vector3:()=>e.Vector3,Vector4:()=>e.Vector4,WebGLRenderer:()=>e.WebGLRenderer,sRGBEncoding:()=>e.sRGBEncoding},w={},x.d(w,v),w);var v,w;x.d({},{});const b=(e=>{var t={};return x.d(t,e),t})({default:()=>i.default,gsap:()=>i.gsap});class k{constructor(){this.callbacks={},this.callbacks.base={}}reset(){this.callbacks={},this.callbacks.base={}}on(e,t){return void 0===e||""===e?(console.warn("wrong names"),!1):void 0===t?(console.warn("wrong callback"),!1):(this.resolveNames(e).forEach((e=>{const i=this.resolveName(e);this.callbacks[i.namespace]instanceof Object||(this.callbacks[i.namespace]={}),this.callbacks[i.namespace][i.value]instanceof Array||(this.callbacks[i.namespace][i.value]=[]),this.callbacks[i.namespace][i.value].push(t)})),this)}off(e){return void 0===e||""===e?(console.warn("wrong name"),!1):(this.resolveNames(e).forEach((e=>{const t=this.resolveName(e);if("base"!==t.namespace&&""===t.value)delete this.callbacks[t.namespace];else if("base"===t.namespace)for(const e in this.callbacks)this.callbacks[e]instanceof Object&&this.callbacks[e][t.value]instanceof Array&&(delete this.callbacks[e][t.value],0===Object.keys(this.callbacks[e]).length&&delete this.callbacks[e]);else this.callbacks[t.namespace]instanceof Object&&this.callbacks[t.namespace][t.value]instanceof Array&&(delete this.callbacks[t.namespace][t.value],0===Object.keys(this.callbacks[t.namespace]).length&&delete this.callbacks[t.namespace])})),this)}trigger(e,t){if(void 0===e||""===e)return console.warn("wrong name"),!1;let i=null,s=null;const o=t instanceof Array?t:[];let r=this.resolveNames(e);if(r=this.resolveName(r[0]),"base"===r.namespace)for(const e in this.callbacks)this.callbacks[e]instanceof Object&&this.callbacks[e][r.value]instanceof Array&&this.callbacks[e][r.value].forEach((function(e){s=e.apply(this,o),void 0===i&&(i=s)}));else if(this.callbacks[r.namespace]instanceof Object){if(""===r.value)return console.warn("wrong name"),this;this.callbacks[r.namespace][r.value].forEach((function(e){s=e.apply(this,o),void 0===i&&(i=s)}))}return i}resolveNames(e){let t=e;return t=t.replace(/[^a-zA-Z0-9 ,/.]/g,""),t=t.replace(/[,/]+/g," "),t=t.split(" "),t}resolveName(e){const t={},i=e.split(".");return t.original=e,t.value=i[0],t.namespace="base",i.length>1&&""!==i[1]&&(t.namespace=i[1]),t}}class M{constructor(e){this.experience=new Nt,this.world=this.experience.world,this.scene=this.experience.scene,this.resources=this.experience.resources,this.materialManager=this.experience.material,this.geometryManager=this.experience.geometry,this.debug=this.experience.debug,this.modelDictionary=this.experience.modelDictionary,this.setMesh(e),this.target=null,this.modelname=e}setMesh(e){this.mesh=this.modelDictionary.CreateModel(e)}SetPosition(e){this.mesh.position.copy(e)}GetPosition(){return this.mesh.position}SetOpacity(e){this.mesh.material.opacity=e}Action(e,t){let i=this.mesh.Action(this,e,t),s=new k,o=new Promise((e=>{s.on("trigger",(()=>{e((()=>(null!=this.target&&this.target.Damaged(this.modelname),this.mesh.effects&&this.mesh.effects.Explode(),this.mesh.Action_End&&this.mesh.Action_End(this,t,this.experience.sound),this.AnimationDisappearance())))}))}));return i.then((()=>{s.trigger("trigger")})),o}Throw(e){let t=b.default.timeline();return this.mesh.lookAt(e),this.AnimationAppearance(.5,t),this.mesh.AnimationShooting(this.mesh,e,t,this.experience.sound),t}GetTarget(e,t){return"axe"==this.modelname||"arrow"==this.modelname||"mjolnir"==this.modelname?this.target=e.GetLastHealthStone():this.target=null,this.mesh.GetTarget(e,t)}AnimationAppearance(e=.5,t=b.default.timeline(),i=.5){let s=this.mesh.position.y-i;return t.from(this.mesh.position,{delay:.2,duration:e,ease:"none",y:s,onStart:()=>{"steal"==this.modelname&&this.experience.sound.Play_StealToken()}}).to(this.mesh.material,{duration:e,ease:"none",opacity:1},"<")}AnimationShooting(e=.3,t,i=b.default.timeline()){return this.mesh.AnimationShooting(this.mesh,t,i,this.experience.sound)}AnimationDisappearance(e=.45){this.mesh.active_=!1,this.mesh.effects&&this.mesh.effects.Destroy();let t=this.mesh.position.y-10;return b.default.timeline().to(this.mesh.material,{duration:e,ease:"none",opacity:0}).to(this.mesh.position,{delay:0,duration:0,ease:"none",y:t})}Destroy(){null!=this.mesh.material&&this.mesh.material.dispose(),this.scene.remove(this.mesh)}Blink(){let e=b.default.timeline();this.mesh.material.opacity=0,e.to(this.mesh,{duration:.05,onStart:()=>{this.mesh.layers.enable(1)}});for(let t=0;t<3;t++)e.to(this.mesh.material,{ease:"none",duration:.2,opacity:1}),e.to(this.mesh.material,{ease:"none",duration:.2,opacity:0});return e.to(this.mesh.material,{ease:"none",duration:.2,opacity:1}),e.to(this.mesh,{duration:.05,onStart:()=>{this.mesh.layers.disable(1)}}),e}MoveTo(e){return b.default.to(this.mesh.position,{duration:.5,ease:"none",x:e.x,y:e.y,z:e.z})}getID(){return this.mesh.id}}class S{constructor(e){this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.materialManager=this.experience.material,this.geometryManager=this.experience.geometry,this.debug=this.experience.debug,this.weaponName=e,this.anim=b.default.timeline(),this.setModel(e)}setModel(e){this.model=new M(e)}SetPosition(e){this.model.SetPosition(e)}GetPosition(){return this.model.GetPosition()}SetOpacity(e){this.model.SetOpacity(e)}Instantiate(){}Action(e,t){return this.model.Action(e,t)}GetTarget(e,t){return this.model.GetTarget(e,t)}AnimationDisappearance(){this.model.AnimationDisappearance()}AnimationShooting(e=.5,t){}Destroy(){this.model.Destroy()}}class T{constructor(e,t=16776960,i){this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.debug=this.experience.debug,this.materialManager=this.experience.material,this.godfavor_Weapon=i,this.weaponName=e,this.color=new y.Color(t),this.weaponMark,this.setMark(e),this.weapon=null}GameOver(){}setMark(e){this.weaponMark=new y.Mesh(new y.PlaneGeometry,this.materialManager.items[`${e}Mark`].clone()),this.weaponMark.layers.enable(1),this.weaponMark.layers.toggle(1)}InstantiateWeapon(){this.godfavor_Weapon?this.weapon=new S(this.godfavor_Weapon):this.weapon=new S(this.weaponName),this.weapon.SetOpacity(0);let e=new y.Vector3;return this.weaponMark.getWorldPosition(e),e.y+=.5,this.weapon.SetPosition(e),this.weapon}TurnOnLight(){b.default.timeline().to(this.weaponMark.material.color,{duration:.4,r:this.color.r,g:this.color.g,b:this.color.b,onStart:()=>{this.weaponMark.renderOrder=3,this.weaponMark.material.depthTest=!1,this.weaponMark.layers.toggle(1)}}).to(this.weaponMark.material.color,{delay:.4,duration:.4,r:0,g:0,b:0,onComplete:()=>{this.weaponMark.renderOrder=0,this.weaponMark.material.depthTest=!0,this.weaponMark.layers.toggle(1)}})}Highlighting_Mark(e,t){let i=b.default.timeline(),s=new y.Color(e);return this.weaponMark.layers.toggle(1),i.to(this.weaponMark.material.color,{duration:t/2,r:s.r,g:s.g,b:s.b,ease:"none"}).to(this.weaponMark.material.color,{duration:t/2,r:0,g:0,b:0,ease:"none",onComplete:()=>{this.weaponMark.layers.toggle(1)}}),i}DisappearAnimation(e,t){let i=b.default.timeline();return this.weaponMark.layers.toggle(1),i.to(this.weaponMark.material.color,{duration:2*t/3,r:e.r,g:e.g,b:e.b,ease:"none"}).to(this.weaponMark.material,{duration:t/3,opacity:0,ease:"none",onComplete:()=>{this.weaponMark.layers.disable(1),this.SetPosition(0,0,-.5)}}),i}EngravedAnimation(){let e=b.default.timeline();return this.SetOpacity(0),this.SetColor(this.color),this.weaponMark.layers.toggle(1),e.to(this.weaponMark.material,{duration:.5,opacity:1,ease:"none"}).to(this.weaponMark.material.color,{duration:.5,r:0,g:0,b:0,ease:"none",onComplete:()=>{this.weaponMark.layers.toggle(1)}}),e}SetPosition(e,t,i){this.weaponMark.position.set(e,t,i)}SetOpacity(e){this.weaponMark.material.opacity=e}SetColor(e){this.weaponMark.material.color.copy(e)}Reset(){this.SetPosition(0,0,.02),this.weaponMark.material.color.set(0,0,0),this.weaponMark.material.opacity=1}destroy(){this.weaponMark.material.dispose()}}class D{constructor(e,t){this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.debug=this.experience.debug,this.materialManager=this.experience.material,this.itemPrefab,this.weaponType=e.weapon,this.isToken=e.token,this.weaponMeshes=[],this.tokenMesh=null,this.faceDir=t,this.setDiceMark(e,t),1==this.isToken&&this.setTokenMesh(),this.diceMark,this.godFavorDiceMarks=[],this.isGodFavorOn=!1}get position(){return this.obj.position}GameOver(){this.TokenMark_Hightlight_Off(),this.diceMark.GameOver()}setDiceMark(e,t){this.obj=new y.Object3D,this.obj.lookAt(this.faceDir),this.obj.position.copy(this.faceDir),this.obj.position.multiplyScalar(.5),this.diceMark=new T(e.weapon),this.obj.add(this.diceMark.weaponMark)}setTokenMesh(){let e;e=new y.Mesh(new y.PlaneGeometry,this.materialManager.items.tokenMark.clone()),e.material.onBeforeCompile=e=>{e.vertexShader=e.vertexShader.replace("#include <common>","\n                #include <common>\n                varying vec4 vPoint;\n                float uOffset = 0.46;\n                float uWeight = 1.41;\n                "),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n                #include <begin_vertex>\n                vPoint = modelViewMatrix * vec4(position, 1.0);\n                vPoint.x -= modelViewMatrix[3][0];\n                vPoint.y -= modelViewMatrix[3][1];\n                vPoint.z -= modelViewMatrix[3][2];\n\n                vPoint.x *= uWeight;\n                vPoint.y *= uWeight;\n                vPoint.z *= uWeight;\n\n                vPoint.x += uOffset;\n                vPoint.y += uOffset;\n                vPoint.z += uOffset;\n                "),e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n                varying vec4 vPoint;\n\n                vec3 yellow_ = vec3(0.9, 0.4, 0.0156);\n                vec3 black_ = vec3(0.24, 0.05, 0.000);\n                "),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","\n                #include <color_fragment>\n\n                float mixf = vPoint.y;\n                diffuseColor.xyz = mix(black_, yellow_, mixf);\n                ")},e.lookAt(this.faceDir),e.position.copy(this.faceDir),e.position.multiplyScalar(.501),e.scale.set(.9,.9,.9),this.tokenMesh=e}TokenMark_Hightlight_On(){1==this.isToken&&this.tokenMesh.layers.enable(1)}TokenMark_Hightlight_Off(){1==this.isToken&&this.tokenMesh.layers.disable(1)}getMarks(){return this.isGodFavorOn?this.godFavorDiceMarks:[this.diceMark]}Highlighting_Mark(e,t){return this.diceMark.Highlighting_Mark(e,t)}DecreaseDiceMark(e,t){let i;if(console.log(arguments),0==this.isGodFavorOn)return i=this.diceMark.DisappearAnimation(t,1),this.isGodFavorOn=!0,this.godFavorDiceMarks=[],[i,()=>{this.ResetDiceMark()}];{let i=this.godFavorDiceMarks.length-e,s=function(e){let t=[];const i=.1*(e-1)/2;for(let s=0;s<e;s++){let e=new y.Object3D,o=.1*s-i;e.translateX(o),e.translateY(-o),e.updateMatrix(),t.push(e.matrix.clone())}return t}(i);return this.ConvertToGodfavorMarks(i,this.weaponType,t,s)}}ConvertToGodfavorMarks(e,t,i,s){1==this.isGodFavorOn&&this.ResetDiceMark(),this.diceMark.SetPosition(0,0,-.5),null===t&&(t=this.weaponType),this.isGodFavorOn=!0,this.godFavorDiceMarks=[];let o=[];for(let r=0;r<e;r++){let e=new T(this.weaponType,i,t);this.godFavorDiceMarks.push(e),this.obj.add(e.weaponMark),console.log(r,s[r]),e.weaponMark.applyMatrix4(s[r]),e.weaponMark.material.depthTest=!1,e.weaponMark.renderOrder=4;let a=e.EngravedAnimation();o.push(a)}return[Promise.all(o),()=>{this.ResetDiceMark()}]}ResetDiceMark(){this.isGodFavorOn=!1,this.godFavorDiceMarks.forEach((e=>{e.destroy(),this.obj.remove(e.weaponMark)})),this.diceMark.Reset(),this.godFavorDiceMarks=[]}Disappear(){this.ResetDiceMark(),this.diceMark.destroy(),this.obj.remove(this.diceMark.weaponMark),null!=this.tokenMesh&&(this.tokenMesh.material.dispose(),this.obj.remove(this.tokenMesh))}_DBG_setFaceColor(e){this.diceMark.weaponMark.material.color.copy(e)}}const A=(e=>{var t={};return x.d(t,e),t})({RoundedBoxGeometry:()=>s.RoundedBoxGeometry});class C{constructor(e,t){this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.debug=this.experience.debug,this.materialManager=this.experience.material,this.geometryManager=this.experience.geometry,this.soundManager=this.experience.sound,this.diceType=t,this.setData(),this.setGeometry(),this.setTextures(),this.setMaterial(),this.setDiceFaces(e),this.setMesh(),this.up=this.getUpVector(),this.org_color=new y.Color(16777215),"token"===this.diceType&&this.org_color.setRGB(.02,.02,.02),this.resetDiceMaterialColor(),this.canPlayAnimation=!1,this.transformLog,this.rollAnimationFrame,this.rollAccumulatedTime,this.rotationMatrix=null,this.landing=!1;let i=new y.Vector3(1,0,0),s=new y.Vector3(-1,0,0);i.cross(s)}GameOver(){Object.keys(this.diceFaces).forEach((e=>{this.diceFaces[e].GameOver()}))}setData(){this.state="tray",this.positionInTray={},this.directories=["right","left","top","bottom","front","back"],this.faceNormals={right:new y.Vector3(1,0,0),left:new y.Vector3(-1,0,0),top:new y.Vector3(0,1,0),bottom:new y.Vector3(0,-1,0),front:new y.Vector3(0,0,1),back:new y.Vector3(0,0,-1)},this.upFaceRotation={right:new y.Euler(0,-Math.PI/2,Math.PI/2,"XYZ"),left:new y.Euler(Math.PI,Math.PI/2,Math.PI/2,"XYZ"),top:new y.Euler(0,0,0,"XYZ"),bottom:new y.Euler(Math.PI,0,0,"XYZ"),front:new y.Euler(-Math.PI/2,0,0,"XYZ"),back:new y.Euler(Math.PI/2,0,Math.PI/2,"XYZ")},this.faceQuaternion={right:new y.Quaternion(-.5,-.5,.5,.5),left:new y.Quaternion(.5,-.5,.5,-.5),top:new y.Quaternion(0,0,0,1),bottom:new y.Quaternion(1,0,0,0),front:new y.Quaternion(-Math.sqrt(2)/2,0,0,Math.sqrt(2)/2),back:new y.Quaternion(0,-Math.sqrt(2)/2,Math.sqrt(2)/2,0)},this.diceFaces={}}setGeometry(){switch(this.diceType){case"weapon":this.geometry=new A.RoundedBoxGeometry(.99,.99,.99,16,.15);break;case"token":this.geometry=this.geometryManager.getGeometry("spheredCube")}}setTextures(){this.textures=[],this.textures.push(this.resources.items.diceArrowTexture),this.textures.push(this.resources.items.diceAxeTexture),this.textures.push(this.resources.items.diceHelmetTexture),this.textures.push(this.resources.items.diceShieldTexture),this.textures.push(this.resources.items.diceGodFavorTexture),this.textures.push(this.resources.items.diceStealTexture),this.textures.forEach((e=>{e.encoding=y.sRGBEncoding})),this.textureDiffuse=this.resources.items.leather_white_diff,this.textureArm=this.resources.items.leather_white_arm,this.textureNormal=this.resources.items.leather_white_nor,["textureArm","textureDiffuse","textureNormal"].forEach((e=>{this[`${e}`].encoding=y.sRGBEncoding,this[`${e}`].repeat.set(.1,.1),this[`${e}`].wrapS=y.RepeatWrapping,this[`${e}`].wrapT=y.RepeatWrapping}))}setMaterial(){this.material=new y.MeshStandardMaterial({map:this.textureDiffuse,metalnessMap:this.textureArm,roughnessMap:this.textureArm,aoMap:this.textureArm,envMapIntensity:1.5,roughness:.3,metalness:.7}),this.material.flatshading=!1}setDiceFaces(e){Object.keys(e).forEach((t=>{this.diceFaces[`${t}`]=new D(e[`${t}`],this.faceNormals[`${t}`])}))}setMesh(){this.dice=new y.Mesh(this.geometry,this.material),this.dice.receiveShadow=!0,this.dice.castShadow=!0,this.mesh=new y.Group,this.mesh.add(this.dice),Object.keys(this.diceFaces).forEach((e=>{let t=this.diceFaces[`${e}`];this.mesh.add(t.obj),1==t.isToken&&this.mesh.add(t.tokenMesh)})),this.scene.add(this.mesh)}getMarks(){return[...this.diceFaces[`${this.up}`].getMarks()]}getObjectUpDir(e){let t=new y.Matrix3;t.setFromMatrix4(e.matrix),t.invert();let i=new y.Vector3(0,1,0).applyMatrix3(t),s=9999,o="";return Object.keys(this.faceNormals).forEach((e=>{const t=i.angleTo(this.faceNormals[`${e}`]);t<s&&(s=t,o=e)})),console.log(o),o}setPosition(e){this.mesh.position.copy(e)}setPositionX(e){this.mesh.position.x=e}setRotationForUp(e){this.up=e;let t=this.faceQuaternion[`${e}`];this.mesh.quaternion.copy(t)}rotateOnWorldAxis(e,t){this.mesh.rotateOnWorldAxis(e,t)}getUpFace(){return this.diceFaces[`${this.up}`]}getWeapon(){return this.diceFaces[`${this.up}`].weaponType}getPosition(){return this.mesh.position}getFaces(){return this.diceFaces}getUpFace(){return this.diceFaces[`${this.up}`]}Highlighting_Mark(e,t){return this.getUpFace().Highlighting_Mark(e,t)}ConvertDiceMark(e,t,i,s){return this.getUpFace().ConvertToGodfavorMarks(e,t,i,s)}DecreaseDiceMark(e,t){return this.getUpFace().DecreaseDiceMark(e,t)}WeaponDecrease(e){this.getUpFace().WeaponDecrease(e)}getUpVector(){let e=new y.Matrix3;e.setFromMatrix4(this.mesh.matrix),e.invert();let t=new y.Vector3(0,1,0).applyMatrix3(e),i=9999,s="";return Object.keys(this.faceNormals).forEach((e=>{const o=t.angleTo(this.faceNormals[`${e}`]);o<i&&(i=o,s=e)})),s}TokenMark_Hightlight_On(){this.getUpFace().TokenMark_Hightlight_On()}TokenMark_Hightlight_Off(){this.getUpFace().TokenMark_Hightlight_Off()}getUpDir(){return this.up}isToken(){return this.diceFaces[`${this.up}`].isToken}getID(){return this.dice.id}_DBG_setFaceColor(){this.directories.forEach(((e,t)=>{let i=this.diceFaces[`${e}`],s=t/6,o=new y.Color;o.setHSL(s,1,.5),i._DBG_setFaceColor(o)}))}_DBG_resetFaceColor(){this.directories.forEach(((e,t)=>{let i=this.diceFaces[`${e}`],s=new y.Color;s.setHSL(0,0,0),i._DBG_setFaceColor(s)}))}StopAnimation(){this.canPlayAnimation=!1}setDiceMaterialColor(e){this.dice.material.color.copy(e)}resetDiceMaterialColor(){this.dice.material.color.copy(this.org_color)}fly(e,t,i,s=0){this.StopAnimation();let o=b.default.timeline();o.add(b.default.to(this.mesh.position,{delay:s,duration:t,ease:"none",x:e.x,y:e.y,z:e.z,onStart:()=>{this.experience.sound.Play_DiceMove()}})),o.add(b.default.timeline({defaults:{duration:t/2}}).to(this.mesh.position,{ease:"sine.out",y:i}).to(this.mesh.position,{ease:"sine.in",y:e.y}),"<");let r=this.faceQuaternion[`${this.up}`],a=new y.Object3D;return a.quaternion.copy(r),a.rotateOnWorldAxis(new y.Vector3(0,1,0),(Math.random()-.5)*(2/3)),o.add(b.default.timeline({defaults:{duration:t}}).to(this.mesh.rotation,{ease:"none",x:a.rotation.x,y:a.rotation.y,z:a.rotation.z}),"<"),o}Move(e,t){this.StopAnimation();let i=Math.random()/3.5;b.default.to(this.mesh.position,{duration:t,delay:i,ease:"none",x:this.mesh.position.x,y:e.y,z:e.z})}StableTheLastFrame(e,t){}CalculateRotationMatrix(e,t){let i=t[t.length-1],s=this.faceNormals[`${e}`].clone();this.mesh.quaternion.copy(i.quaternion),this.mesh.position.copy(i.position),this.mesh.updateMatrix();let o=new y.Matrix3;o.setFromMatrix4(this.mesh.matrix);let r=new y.Vector3(0,1,0),a=s.applyMatrix3(o);this.angleBetween=a.angleTo(r),this.rotationAxisGlobal=a.clone(),this.rotationAxisGlobal.cross(r),this.rotationAxisGlobal.normalize();let n=new y.Matrix4;return n.makeRotationAxis(this.rotationAxisGlobal,this.angleBetween),n}GetLastUpDir(e){let t=e[e.length-1];return this.mesh.quaternion.copy(t.quaternion),this.mesh.position.copy(t.position),this.mesh.updateMatrix(),this.getUpVector()}Withdraw(e){this.experience.sound.Play_DiceTake(),this.Move(e,.3)}Roll(e,t,i){b.default.timeline().to(this,{duration:.66,onStart:()=>{this.Withdraw(i)}}).to(this,{onStart:()=>{this.Roll_(e,t)}});let s=b.default.timeline();return s.add(b.default.to(this,{duration:.66+1.2})),this.landing=!1,s}Roll_(e,t){this.up=e,this.fromDir=this.faceNormals[`${e}`].clone(),this.toDir=this.faceNormals[`${this.GetLastUpDir(t)}`].clone(),this.transformLog=t,this.canPlayAnimation=!0,this.rollAnimationFrame=0,this.rollAccumulatedTime=0}SetStableAfterRoll(){let e=new y.Vector3(0,1,0),t=this.faceNormals[`${this.up}`].clone(),i=new y.Matrix3;if(this.mesh.updateMatrix(),i.setFromMatrix4(this.mesh.matrix),t.applyMatrix3(i),t.y>.9)return;let s=t.angleTo(e);t.cross(e);let o=new y.Object3D;o.position.copy(this.mesh.position),o.quaternion.copy(this.mesh.quaternion),o.rotateOnWorldAxis(t,s),b.default.to(this,{duration:.15,ease:"none",onUpdate:()=>{this.mesh.quaternion.slerp(o.quaternion,.25)}}),b.default.to(this.mesh.position,{duration:.15,ease:"none",y:.499999})}Disappear(){this.isDisappeared=!0,Object.keys(this.diceFaces).forEach((e=>{let t=this.diceFaces[`${e}`];t.Disappear(),this.mesh.remove(t.obj)})),this.scene.remove(this.mesh)}update(e){if(1==this.canPlayAnimation){let t=Math.floor(this.rollAccumulatedTime/7),i=this.transformLog[t];this.mesh.position.copy(i.position),this.mesh.quaternion.copy(i.quaternion),this.mesh.updateMatrix();let s=this.fromDir.clone(),o=this.toDir.clone(),r=new y.Matrix3;r.setFromMatrix4(this.mesh.matrix);let a=s.clone(),n=o.clone();a.applyMatrix3(r),n.applyMatrix3(r);let h=a.angleTo(n),l=a.cross(n);if(l.length()<.001){let e=new y.Vector3;e.set(o.y,o.z,o.x);let t=e.clone();t.applyMatrix3(r),l=t.cross(n)}t>78&&t<120&&this.experience.sound.Play_GroupRoll(),this.mesh.rotateOnWorldAxis(l,h),this.rollAccumulatedTime+=e,this.rollAnimationFrame=Math.floor(this.rollAccumulatedTime/7),this.rollAnimationFrame=Math.min(this.rollAnimationFrame,268),this.rollAnimationFrame>=this.transformLog.length-5&&(this.canPlayAnimation=!1)}}}const P=new y.BoxGeometry(1,1,1),F=[new y.MeshStandardMaterial({color:"red"}),new y.MeshStandardMaterial({color:"yellow"}),new y.MeshStandardMaterial({color:"blue"}),new y.MeshStandardMaterial({color:"green"}),new y.MeshStandardMaterial({color:"purple"}),new y.MeshStandardMaterial({color:"white"})],G=new CANNON.Material("default"),O=(new CANNON.Material("wall"),new CANNON.Material("floor")),B=new CANNON.ContactMaterial(G,G,{friction:0,restitution:0}),I=new CANNON.ContactMaterial(G,O,{friction:.05,restitution:.2}),E=(e,t,i,s=1)=>{const o=new y.Mesh(P,F);o.scale.set(e,t,i);const r=new CANNON.Box(new CANNON.Vec3(.5*e,.5*t,.5*i)),a=new CANNON.Body({mass:s,position:new CANNON.Vec3(0,5,0),shape:r,material:G});return o.position.copy(a.position),{mesh:o,body:a}};class V{constructor(){this.experience=new Nt,this.physicsWorld=new CANNON.World,this.scene=this.experience.scene,this.debug=this.experience.debug,this.diceBodies=[],this.pillarBodies=[],this.fenceBodies=[],this.setPhysicsWorld()}setPhysicsWorld(){this.physicsConfig={spawn_height:11,spawn_distance:13.8,force:640,torque:80,torque_radius:1,magnet:8.4,decay_weight:2.7,gap:1.225,normalFaces:{0:"top",1:"top",2:"top",3:"top",4:"top",5:"top"}},this.physicsWorld=new CANNON.World,this.physicsWorld.addContactMaterial(B),this.physicsWorld.addContactMaterial(I),this.physicsWorld.defaultContactMaterial=B,this.physicsWorld.gravity.set(0,-9.82,0);const e=new CANNON.Plane,t=new CANNON.Body;t.material=O,t.mass=0,t.quaternion.setFromAxisAngle(new CANNON.Vec3(-1,0,0),.5*Math.PI),t.addShape(e),this.physicsWorld.addBody(t);for(let e=0;e<8;e++){let e=E(1,1,1);this.diceBodies.push(e);let t=E(.8,3,.8,0);t.body.position.set(e.body.position.x,e.body.position.y+2.7,e.body.position.z),this.pillarBodies.push(t)}let i=1;for(let e=0;e<2;e++){for(let e=0;e<32;e++){let t=e*(Math.PI/16),s={x:2.8*Math.cos(t),y:.25+1.5*Math.cos(t+i*Math.PI/2),z:2.8*Math.sin(t)+6*i},o=E(.2,4.5,.4,0);this.fenceBodies.push(o),o.body.position.copy(s),o.body.quaternion.setFromAxisAngle(new CANNON.Vec3(0,1,0),-t),this.physicsWorld.addBody(o.body),o.mesh.position.copy(o.body.position),o.mesh.quaternion.copy(o.body.quaternion)}i*=-1}}SimulationUpdate(e,t){this.physicsWorld.step(1/60);let i=[];this.physicsWorld.contacts.forEach((e=>{let t=e.getImpactVelocityAlongNormal();t=Math.abs(t),t>.5&&(e.bi.impact_=t,e.bj.impact_=t)}));for(let s=0;s<e;s++){let e=this.diceBodies[s].body,o=this.BodyUpdate(e,t);i.push(o);let r=this.pillarBodies[s];r.body.position.set(e.position.x,e.position.y+2.7,e.position.z),r.mesh.position.copy(r.body.position)}return i}BodyUpdate(e,t){let i={};return e.position.y>2&&e.applyForce(new CANNON.Vec3(0,0,t*this.physicsConfig.magnet),e.position),i.position=e.position.clone(),i.quaternion=e.quaternion.clone(),i.impact=e.impact_,e.impact_=0,i}GetDiceLog(e,t,i){let s=new Array(e);for(let t=0;t<e;t++)s[t]=[];this.physicsWorld.gravity.set(0,-9.82,0);for(let o=0;o<t;o++)o>.8*t&&this.physicsWorld.gravity.set(0,-9.82*(1+30*Math.exp(80*(o/t-1))),0),this.SimulationUpdate(e,i).forEach(((e,t)=>{s[t].push(e)}));return s}_SetPhysicsWorld(e){for(let t=0;t<e;t++)this.physicsWorld.addBody(this.diceBodies[t].body)}_ResetPhysicsWorld(e){for(let t=0;t<e;t++)this.physicsWorld.removeBody(this.diceBodies[t].body)}_PrepareSimulation(e,t){let i=[],s=2*Math.PI*Math.random();for(let e=0;e<6;e++){let e=new CANNON.Vec3((Math.cos(s)+Math.sin(s))*this.physicsConfig.gap,this.physicsConfig.spawn_height,(-Math.sin(s)+Math.cos(s))*this.physicsConfig.gap+(this.physicsConfig.spawn_distance-.825)*t);i.push(e),s+=Math.PI/3}i=function(e){let t,i=e.length;for(;0!=i;)t=Math.floor(Math.random()*i),i--,[e[i],e[t]]=[e[t],e[i]];return e}(i);let o=0;for(let t=0;t<e;t++){let e=this.diceBodies[t].body;this._InitializeBody(e,i[o++])}}_InitializeBody(e,t){e.position.setZero(),e.previousPosition.setZero(),e.interpolatedPosition.setZero(),e.initPosition.setZero(),e.quaternion.set(0,0,0,1),e.initQuaternion.set(0,0,0,1),e.interpolatedQuaternion.set(0,0,0,1),e.velocity.setZero(),e.initVelocity.setZero(),e.angularVelocity.setZero(),e.initAngularVelocity.setZero(),e.force.setZero(),e.torque.setZero(),e.sleepState=0,e.timeLastSleepy=0,e._wakeUpAfterNarrowphase=!1,e.position.copy(t),e.isCollision=!1}_ApplyForce(e,t){for(let i=0;i<e;i++){let e=this.diceBodies[i].body;this._ApplyForce_Body(e,t)}}_ApplyForce_Body(e,t){e.applyForce(new CANNON.Vec3(0,0,-1*t*this.physicsConfig.force),e.position);let i=2*Math.random()*Math.PI;e.applyForce(new CANNON.Vec3(0,-this.physicsConfig.torque,0),new CANNON.Vec3(this.physicsConfig.torque_radius*Math.cos(i)+e.position.x,e.position.y,this.physicsConfig.torque_radius*Math.sin(i)+e.position.z))}_DiceRollSimulation(e,t){this._SetPhysicsWorld(e),this._PrepareSimulation(e,t),this._ApplyForce(e,t);let i=this.GetDiceLog(e,270,t);return this._ResetPhysicsWorld(e),i}CheckRollResult(e,t){for(let i=0;i<e;i++){let e=this.diceBodies[i].body.position,s=new CANNON.Vec3(0,0,6*t);if(e.distanceSquared(s)>2.55*2.55)return!1;if(e.y>.5)return!1}return!0}DiceRollSimulation(e,t){return new Promise((i=>{for(;;){let s=this._DiceRollSimulation(e,t);if(this.CheckRollResult(e,t))return i(s)}}))}_DBG_RollDices(){this._SetPhysicsWorld(6),this._PrepareSimulation(6,1),this._ApplyForce(6,1),this.dbg_update=!0,setTimeout((()=>{this.dbg_update=!1,this._ResetPhysicsWorld(6)}),1700)}setDebug(){this.debug.active&&(this.diceBodies.forEach((e=>{this.scene.add(e.mesh)})),this.fenceBodies.forEach((e=>{this.scene.add(e.mesh)})),this.debugFolder=this.debug.ui.addFolder("physics"),this.debugFolder.add(this.physicsConfig.normalFaces,"0",["right","left","top","bottom","front","back"]),this.debugFolder.add(this.physicsConfig.normalFaces,"1",["right","left","top","bottom","front","back"]),this.debugFolder.add(this.physicsConfig.normalFaces,"2",["right","left","top","bottom","front","back"]),this.debugFolder.add(this.physicsConfig.normalFaces,"3",["right","left","top","bottom","front","back"]),this.debugFolder.add(this.physicsConfig.normalFaces,"4",["right","left","top","bottom","front","back"]),this.debugFolder.add(this.physicsConfig.normalFaces,"5",["right","left","top","bottom","front","back"]),this.debugFolder.add(this,"_DBG_RollDices"),this.debugFolder.add(this.physicsConfig,"spawn_height",0,15,.05),this.debugFolder.add(this.physicsConfig,"spawn_distance",0,15,.05),this.debugFolder.add(this.physicsConfig,"force",100,1e3,5),this.debugFolder.add(this.physicsConfig,"torque",0,200,1),this.debugFolder.add(this.physicsConfig,"torque_radius",0,10,.1),this.debugFolder.add(this.physicsConfig,"magnet",0,10,.001),this.debugFolder.add(this.physicsConfig,"decay_weight",0,100,.1),this.debugFolder.add(this.physicsConfig,"gap",0,5,.001))}update(){this.debug.active,this.isPlay,this.dbg_update&&(this.SimulationUpdate(6,1),this.diceBodies.forEach(((e,t)=>{e.mesh.position.copy(e.body.position),e.mesh.quaternion.copy(e.body.quaternion);let i=this.pillarBodies[t];i.body.position.set(e.body.position.x,e.body.position.y+2.7,e.body.position.z),i.mesh.position.copy(i.body.position)})))}}var R=lil.GUI;class z{constructor(){this.active,window.location.hash.split("&").forEach((e=>{"#debug"===e&&(this.active=!0)})),this.active&&(this.ui=new R)}}class $ extends k{constructor(){super(),this.width=window.innerWidth,this.height=window.innerHeight,this.pixelRatio=Math.min(window.devicePixelRatio,2),this.is_resized=!0,this.Check_Resized(),window.addEventListener("resize",(()=>{this.is_resized=!0})),setInterval((()=>{this.Check_Resized()}),5e3)}Check_Resized(){1==this.is_resized&&(this.is_resized=!1,this.width=window.innerWidth,this.height=window.innerHeight,this.window_ratio=this.width/this.height,this.pixelRatio=Math.min(window.devicePixelRatio,1.5),window.innerWidth<1e3&&(this.pixelRatio=.8),this.trigger("resize"))}}class j{constructor(e){this.experience=new Nt,this.resources=this.experience.resources,this.camera=this.experience.camera.instance,this.emitter=e,this.time=-1,this.state=!1,this.last_time=-1}SetTimer(e,t=!0){this.time=e,t&&this.StartTimer()}StartTimer(){this.state=!0}StopTimer(){this.state=!1,this.experience.world.clock.DisplayNumber(" "),this.last_time=-1}AddExtraTime(e){this.time+=e}update(e){if(this.state){this.time-=e;let t=Math.ceil(this.time/1e3);this.last_time!==t&&(this.last_time=t,this.experience.world.clock.DisplayNumber(this.last_time)),this.time<=0&&(this.emitter.trigger("timeover"),this.StopTimer())}}}class U extends k{constructor(){super(),this.experience=new Nt,this.world=this.experience.world,this.camera=this.experience.camera,this.resources=this.experience.resources,this.start=Date.now(),this.current=this.start,this.elapsed=0,this.delta=16,this.global_gsap_timeline=0,this.resources_on=!1,document.addEventListener("visibilitychange",(()=>{switch(document.visibilityState){case"visible":clearInterval(this.blur_interval),b.gsap.ticker.add(b.gsap.updateRoot);let e=b.gsap.globalTimeline.endTime();b.gsap.globalTimeline.time(e),b.gsap.globalTimeline.progress(1);break;case"hidden":b.gsap.ticker.remove(b.gsap.updateRoot),this.global_gsap_timeline=b.gsap.globalTimeline.time(),this.blur_interval=setInterval((()=>{this.tick_blur()}),100)}})),this.emitter=new k,this.timer=new j(this.emitter),this.resources.on("ready",(()=>{this.resources_on=!0,window.requestAnimationFrame((()=>{this.tick()}))})),this.SetTimerTrigger()}GetProgressedValue(e,t,i){return(e*t+i)/e}SetTimer(e,t=!1){this.timer.SetTimer(e,t)}StartTimer(){this.timer.StartTimer()}StopTimer(){this.timer.StopTimer()}SetTimerTrigger(){this.emitter.on("timeover",(()=>{this.trigger("timeover")}))}AddExtraTime(e){this.timer.AddExtraTime(e)}Frame(){const e=Date.now();this.delta=e-this.current,this.current=e,this.elapsed=this.current-this.start,this.world.update(this.delta),this.camera.update(),this.trigger("tick",[this.delta]),this.timer.update(this.delta)}tick(){this.Frame(),window.requestAnimationFrame((()=>{this.tick()}))}tick_blur(){if(!1===this.resources_on)return;let e=(Date.now()-this.current)/1e3;this.global_gsap_timeline+=e,b.gsap.updateRoot(this.global_gsap_timeline,e),this.Frame()}TweenUpdate(e,t){let i=Date.now()-this.current;i/=1e3;let s=(e.time()+i)/e.duration();s>1&&(s=1),e.progress(s).play()}GameOver(){this.timer.StopTimer()}}const L=(e=>{var t={};return x.d(t,e),t})({OrbitControls:()=>o.OrbitControls});class H{constructor(){this.experience=new Nt,this.sizes=this.experience.sizes,this.scene=this.experience.scene,this.canvas=this.experience.canvas,this.debug=this.experience.debug,this.setInstance(),this.setControls(),this.setDebug(),this.resetCamera(),this.standard_ratio=1920/1080,this.standard_angle=2*Math.atan(1/this.standard_ratio),this.standard_angle=this.standard_angle*(180/Math.PI),this.resize()}setInstance(){this.instance=new y.PerspectiveCamera(38,this.sizes.width/this.sizes.height,.1,50),this.instance.position.set(0,24.4,14.6),this.length_=Math.hypot(24.4,14.6),this.scene.add(this.instance)}setControls(){this.controls=new L.OrbitControls(this.instance,this.canvas),this.controls.enableDamping=!0,this.controls.enabled=!1}get ui_scale_weight(){return window.innerWidth/1920}resize(){let e=this.standard_ratio,t=this.sizes.window_ratio;if(e>t){let e=2*Math.atan(1/t);e*=180/Math.PI,this.instance.fov=39.5+.5*(e-this.standard_angle)}else this.instance.fov=39.5;this.instance.aspect=t,this.instance.updateProjectionMatrix()}update(){this.controls.update()}resetCamera(){this.instance.position.set(0,24.4,14.6),this.length_=Math.hypot(24.4,14.6),this.controls.target=new y.Vector3(0,0,1)}IsometricView(){let e=0,t=24.4,i=14.6;return b.gsap.to(this.instance.position,{duration:.7,ease:"Power2.easeOut",x:e,y:t,z:i})}Topview(){let e=0,t=26,i=7;return this.length_=Math.hypot(t,i),b.gsap.timeline().to(this.instance.position,{duration:.7,ease:"Power2.easeOut",x:e,y:t,z:i})}_DBG_WideView(){let e={x:0,y:20.92*1.5,z:18.96};return this.length_=Math.hypot(e.y,e.z),b.gsap.timeline().to(this.instance.position,{duration:.7,ease:"Power2.easeOut",x:e.x,y:e.y,z:e.z})}setDebug(){this.debug.active&&(this.debugFolder=this.debug.ui.addFolder("camera"),this.debugFolder.add(this.instance,"near").name("near").min(0).max(10).step(.001).listen(),this.debugFolder.add(this.instance,"far").name("far").min(0).max(500).step(.001).listen(),this.debugFolder.add(this.instance.position,"x").name("camera X").min(-10).max(10).step(.001).listen(),this.debugFolder.add(this.instance.position,"x").name("camera X").min(-10).max(10).step(.001).listen(),this.debugFolder.add(this.instance.position,"y").name("camera Y").min(-10).max(10).step(.001).listen(),this.debugFolder.add(this.instance.position,"z").name("camera Z").min(-10).max(10).step(.001).listen(),this.debugFolder.add(this,"resetCamera").listen())}}class N{constructor(){this.experience=new Nt,this.canvas=this.experience.canvas,this.sizes=this.experience.sizes,this.scene=this.experience.scene,this.camera=this.experience.camera,this.setInstance(),this.postProcessor=this.experience.postProcessor,this.debug=this.experience.debug,this.setDebug()}setInstance(){this.instance=new y.WebGLRenderer({canvas:this.canvas,antialias:!0}),this.instance.physicallyCorrectLights=!0,this.instance.toneMapping=y.CineonToneMapping,this.instance.toneMappingExposure=Math.pow(1,5),this.instance.shadowMap.enabled=!0,this.instance.shadowMap.type=y.PCFSoftShadowMap,this.instance.setClearColor("#000000"),this.instance.setSize(this.sizes.width,this.sizes.height),this.instance.setPixelRatio(Math.min(this.sizes.pixelRatio,1.5))}resize(){this.instance.setSize(this.sizes.width,this.sizes.height),this.instance.setPixelRatio(Math.min(this.sizes.pixelRatio,1.5))}update(){this.instance.render(this.scene,this.camera.instance)}setDebug(){this.debug.active&&(this.debugFolder=this.debug.ui.addFolder("renderer"),this.debugFolder.add(this.instance,"toneMapping",{No:y.NoToneMapping,Linear:y.LinearToneMapping,Reinhard:y.ReinhardToneMapping,Cineon:y.CineonToneMapping,ACESFilmic:y.ACESFilmicToneMapping}))}}class W{constructor(){this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.debug=this.experience.debug,this.debug.active&&(this.debugFolder=this.debug.ui.addFolder("environment")),this.setSunLight(),this.setEnvironmentMap()}setSunLight(){this.sunLight=new y.DirectionalLight("#ffffff",2),this.sunLight.castShadow=!0,this.sunLight.shadow.camera.near=1,this.sunLight.shadow.camera.far=30,this.sunLight.shadow.camera.top=20,this.sunLight.shadow.camera.bottom=-20,this.sunLight.shadow.camera.right=20,this.sunLight.shadow.camera.left=-20,this.sunLight.shadow.mapSize.set(1024,1024),this.sunLight.shadow.normalBias=.05,this.sunLight.position.set(3.89,7.96,-3.23),this.scene.add(this.sunLight),this.debug.active&&(this.debugFolder.addColor(this.sunLight,"color"),this.debugFolder.add(this.sunLight,"intensity").name("sunLightIntensity").min(0).max(10).step(.001),this.debugFolder.add(this.sunLight.position,"x").name("sunLightX").min(-10).max(10).step(.001),this.debugFolder.add(this.sunLight.position,"y").name("sunLightY").min(-10).max(10).step(.001),this.debugFolder.add(this.sunLight.position,"z").name("sunLightZ").min(-10).max(10).step(.001))}setEnvironmentMap(){this.environmentMap={},this.environmentMap.intensity=1,this.environmentMap.texture=this.resources.items.environmentMapTexture,this.environmentMap.texture.encoding=y.sRGBEncoding,this.scene.environment=this.environmentMap.texture,this.environmentMap.updateMaterials=()=>{this.scene.traverse((e=>{e instanceof y.Mesh&&e.material instanceof y.MeshStandardMaterial?(e.material.envMap=this.environmentMap.texture,e.material.envMapIntensity=this.environmentMap.intensity,e.material.needsUpdate=!0):e instanceof y.Mesh&&Array.isArray(e.material)&&e.material.forEach((e=>{e instanceof y.MeshStandardMaterial&&(e.envMap=this.environmentMap.texture,e.envMapIntensity=this.environmentMap.intensity,e.needsUpdate=!0)}))}))},this.environmentMap.updateMaterials(),this.debug.active&&this.debugFolder.add(this.environmentMap,"intensity").name("envMapIntensity").min(0).max(4).step(.001).onChange(this.environmentMap.updateMaterials)}}class q{constructor(e,t="weapon"){this.experience=new Nt,this.diceType=t,this.mesh=new C(e,t),this.debug=this.experience.debug,this.setDebug(),this.isReadyToAction=!1,this.positionForUndo=new y.Vector3,this.state="tray"}GameOver(){this.mesh.GameOver()}InitialGame(){this.state="tray"}Hover_On(){this.experience.sound.Play_DiceHover()}Hover_Off(){}ResetRound(){this.isReadyToAction=!1,this.state="tray"}MoveToAction(e,t){let i;return i=this.isReadyToAction?this.mesh.fly(e,.5,.5,.5):this.mesh.fly(e,.7,3+.7*t,.5),this.isReadyToAction=!0,i}DiceToActionEnd(e){return this.mesh.fly(e,.4,4,.3)}DiceToWaiting(e){return this.state="waiting",this.mesh.fly(e,.4,3,.2)}clicked(){this.Choise()}GetDiceState(){return this.state}WeaponDecrease(e){this.mesh.WeaponDecrease(e)}ChooseDice(e,t){switch(this.positionForUndo.copy(this.mesh.getPosition()),t){case"roll":return this.state="chosen",this.mesh.fly(e,.3,3);case"godfavor":return this.state="levitation",this.mesh.fly(e,.3,3)}}CancleDice(e){switch(e){case"roll":this.state="tray";break;case"godfavor":this.state="waiting"}return this.mesh.fly(this.positionForUndo,.3,3)}Withdraw(e){this.mesh.Withdraw(e)}Roll(e,t,i){return this.isReadyToAction=!1,this.positionForUndo.copy(t[t.length-1].position),this.mesh.Roll(e,t,i)}TokenMark_Hightlight_On(){this.mesh.TokenMark_Hightlight_On()}TokenMark_Hightlight_Off(){this.mesh.TokenMark_Hightlight_Off()}PhysicsRoll(){this.mesh.PhysicsRoll()}active(){this.debug.active&&this.debugFolder.show()}deactive(){this.debug.active&&this.debugFolder.hide()}Highlighting_Mark(e,t){return this.mesh.Highlighting_Mark(e,t)}ConvertDiceMark(e,t,i,s){return this.mesh.ConvertDiceMark(e,t,i,s)}DecreaseDiceMark(e,t){return this.mesh.DecreaseDiceMark(e,t)}setRotationForUp(e){this.mesh.setRotationForUp(e)}Organize(e){let t=this.mesh.getPosition().clone();t.z=13.25*e,this.setPosition(t)}Setup(e){let t=this.mesh.getPosition().clone();t.z=9.25*e,this.setPosition(t)}setPosition(e){this.mesh.setPosition(e)}getWeapon(){return this.mesh.getWeapon()}getPosition(){return this.mesh.getPosition()}getMarks(){return[...this.mesh.getMarks()]}getUpFace(){return this.mesh.getUpFace()}getUpDir(){return this.mesh.getUpVector()}getFaces(){return this.mesh.getFaces()}isToken(){return this.mesh.isToken()}getID(){return this.mesh.getID()}_DBG_setFaceColor(){this.mesh._DBG_setFaceColor()}_DBG_resetFaceColor(){this.mesh._DBG_resetFaceColor()}setDiceMaterialColor(e){this.mesh.setDiceMaterialColor(e)}resetDiceMaterialColor(){this.mesh.resetDiceMaterialColor()}setDebug(){this.debug.active&&(this.dummy=5,this.debugFolder=this.debug.ui.addFolder(`dice ${this.mesh.id}`),this.debugFolder.add(this,"dummy",{"+x : ":()=>{this.setRotationForUp("right")},"-x : ":()=>{this.setRotationForUp("left")},"+y : ":()=>{this.setRotationForUp("top")},"-y : ":()=>{this.setRotationForUp("bottom")},"+z : ":()=>{this.setRotationForUp("front")},"-z : ":()=>{this.setRotationForUp("back")}}).onChange((e=>{e()})),this.debugFolder.hide())}Disappear(){this.mesh.Disappear()}update(e){this.mesh.update(e)}}const X={Lerp:function(e,t,i){return e+i*(t-e)},CircLerp:function(e,t,i){return e+(t-e)*Math.sqrt(i)},Cos:function(e,t,i){let s=t-e;return Math.cos(s*i*(Math.PI/2))},None:function(e,t,i){return t}},Y=new y.Object3D;class Q{constructor(e,t){this.experience=new Nt,this.parent=t,this.param=e,this.time_remaing=0,this.bursted=!1,this.active_=!0,this.age=0,this.Init()}get instance(){return this.particle_mesh}get world_matrix(){let e=this.parent.matrix.clone(),t=this.particle_mesh.matrix.clone();return e.multiply(t),e}Init(){let e=this.param.particle_life_time+this.param.particle_life_time_random,t=this.param.create_interval_time-this.param.create_interval_time_random;"burst"==this.param.fire_type?this.param.count_limit=this.param.burst_cnt:"stream"==this.param.fire_type?this.param.count_limit=Math.ceil(e/t):this.param.count_limit=0;let i=new Float32Array(this.param.count_limit);for(let e=0;e<this.param.count_limit;e++)i[e]=0;this.param.particle_geometry.setAttribute("alpha",new y.InstancedBufferAttribute(i,1,!0,1)),this.particle_mesh=new y.InstancedMesh(this.param.particle_geometry,this.param.particle_material,this.param.count_limit),this.particle_mesh.position.copy(this.param.origin_position),this.particle_mesh.layers.enable(1),this.particle_mesh.material.needsUpdate=!0;for(let e=0;e<this.param.count_limit;e++)this.particle_mesh.setColorAt(e,this.param.colors[0]);this.particles_matrix=new Array(this.param.count_limit).fill(this.world_matrix),this.particles_info=new Array(this.param.count_limit);for(let e=0;e<this.param.count_limit;e++)this.particles_info[e]=new Z(this.param);this.particle_queue=Array.from(Array(this.param.count_limit).keys())}Burst(){if("stream"!==this.param.fire_type){for(let e=0;e<this.param.count_limit;e++)this.Begin_Particle();this.bursted=!0}}Inactive(){this.active_=!1}Begin_Particle(){if(0==this.active_)return;if(null!=this.param.mainbody_lifetime&&this.age>this.param.mainbody_lifetime)return;let e=this.particle_queue.pop();void 0!==e&&this.particles_info[e].begin_(this.world_matrix)}End_Particle(e){this.particles_info[e].end_(),this.particle_queue.push(e)}Init_Trail(){}Get_Max_Life(){return this.param.particle_life_time+this.param.particle_life_time_random}setLifeAt(e,t){const i=this.particle_mesh.geometry.attributes.alpha.array,s=this.param.opacity_interpolation;i[e]=s?X[`${s}`](0,1,t):X.Cos(0,1,t)}Update(e){if(this.age+=e,this.instance.updateMatrix(),"stream"===this.param.fire_type&&(this.time_remaing-=e,this.time_remaing<=0&&(this.time_remaing=this.param.create_interval_time+Math.random()*this.param.create_interval_time_random,this.Begin_Particle())),"stream"===this.param.fire_type||"burst"===this.param.fire_type&&1==this.bursted){for(let t=0;t<this.param.count_limit;t++){let i=this.particles_info[t];if(1==i.alive)if(this.param.gravity&&(this.param.gravity_=this.param.gravity.clone(),this.param.gravity_.multiplyScalar(e/1e3)),0==i.update_(e))this.End_Particle(t);else{let e=i.matrix_,s=i.color_,o=i.life_;this.particle_mesh.setColorAt(t,s),this.setLifeAt(t,o);let r=this.world_matrix;r.invert(),r.multiply(e),this.particle_mesh.setMatrixAt(t,r)}}this.particle_mesh.instanceMatrix.needsUpdate=!0,null!=this.particle_mesh.instanceColor&&(this.particle_mesh.instanceColor.needsUpdate=!0),this.particle_mesh.geometry.attributes.alpha.needsUpdate=!0}}Destroy(){this.particle_mesh.dispose()}}class Z{constructor(e){this.param=e,this.org_life_time,this.life_time=0,this.replay_cnt=0,this.origin_matrix=new y.Matrix4,this.direction=new y.Vector3,this.speed=0,this.alive=!1,this.position=new y.Vector3,this.quaternion=new y.Quaternion,this.scale=new y.Vector3,this.color=new y.Color}get life_(){return(this.org_life_time-this.life_time)/this.org_life_time}get matrix_(){let e=new y.Matrix4;return e.compose(this.position,this.quaternion,this.scale),e}get color_(){let e=this.life_,t=1/(this.param.colors.length-1),i=Math.floor(e/t),s=(e-i*t)*(this.param.colors.length-1);return this.color.lerpColors(this.param.colors[i],this.param.colors[i+1],s),this.color}update_(e){if(!1===this.alive)return null;const t=this.param.speed_interpolation;this.speed=t?X[`${t}`](this.param.speed,this.param.speed_end,this.life_):X.CircLerp(this.param.speed,this.param.speed_end,this.life_);let i=this.direction.clone();return i.multiplyScalar(this.speed*(e/1e3)),this.param.gravity&&i.add(this.param.gravity_),this.position.add(i),this.life_time-=e,!(this.life_time<=0)}begin_(e){this.particle_life_time=this.param.particle_life_time+this.param.create_interval_time_random*Math.random(),this.org_life_time=this.param.particle_life_time+this.param.particle_life_time_random*Math.random(),this.life_time=this.org_life_time,this.replay_cnt++,this.origin_matrix.copy(e),this.speed=this.param.speed+this.param.speed_random*Math.random(),this.alive=!0,e.decompose(this.position,this.quaternion,this.scale),this.direction.set(0,0,1),this.direction.applyQuaternion(this.quaternion);let t=new y.Vector3;if(t.randomDirection(),this.param.direction_scale&&(t.multiply(this.param.direction_scale),t.normalize()),null==this.param.direction_theta)this.direction.copy(t);else{const e=this.param.direction_theta/Math.PI;this.direction.lerp(t,e)}0==this.param.direction_heritaged&&(Y.lookAt(this.direction),this.quaternion.copy(Y.quaternion)),t.randomDirection();const i=this.param.rotation_angle_random/Math.PI;t.lerp(this.direction,1-i),Y.lookAt(t),this.quaternion.copy(Y.quaternion),1==this.param.regen_area_type&&this.position.copy(this.Get_Regen_Position())}end_(){this.alive=!1}Get_Regen_Position(){const e=this.param.regen_area,t=e.attributes.position.array,i=(e.index,e.attributes.position.count),s=3*Math.floor(Math.random()*i),o=[new y.Vector3(t[s],t[s+1],t[s+2]),new y.Vector3(t[s+3],t[s+4],t[s+5]),new y.Vector3(t[s+6],t[s+7],t[s+8])];let r=new y.Vector3((o[0].x+o[1].x+o[2].x)/3,(o[0].y+o[1].y+o[2].y)/3,(o[0].z+o[1].z+o[2].z)/3);const a=new y.Vector3;a.randomDirection(),o[0].sub(r),o[1].sub(r),o[2].sub(r);const n=[new y.Vector3,new y.Vector3,new y.Vector3];n[0].copy(a),n[1].copy(a),n[2].copy(a),n[0].projectOnVector(o[0]),n[1].projectOnVector(o[1]),n[2].projectOnVector(o[2]);const h=new y.Vector3;h.set(n[0].x+n[1].x+n[2].x,n[0].y+n[1].y+n[2].y,n[0].z+n[1].z+n[2].z),h.multiplyScalar(.1),h.add(r);let l=new y.Matrix4;return l.copy(this.origin_matrix),l.multiply((new y.Matrix4).setPosition(h)),h.set(l.elements[12],l.elements[13],l.elements[14]),h}}class J{constructor(e,t){this.experience=new Nt,this.param=e,this.parent=t,this.time_remaing=0,this.scene=this.experience.scene,this.resources=this.experience.resources,this.material_manager=this.experience.material,this.Init()}get instance(){return this.sprite_mesh}Init(){this.resources.items.particle_muzzle_01.encoding=y.sRGBEncoding,this.resources.items.perlin_noise;let e=this.material_manager.referenceMaterial(this.param.name),t=new y.PlaneGeometry(1.5,2.25,7,7);this.sprite_mesh=new y.Mesh(t,e),this.sprite_mesh.rotateX(-Math.PI/2),this.sprite_mesh.translateY(1),this.sprite_mesh.updateMatrix(),this.sprite_mesh.layers.enable(1);let i=this.sprite_mesh.geometry.attributes.position.array,s=this.sprite_mesh.geometry.attributes.position.count,o=1/7;for(let e=0;e<s;e+=8)i[3*e]*=o,i[3*(e+1)]*=o,i[3*(e+2)]*=o,i[3*(e+3)]*=o,i[3*(e+4)]*=o,i[3*(e+5)]*=o,i[3*(e+6)]*=o,i[3*(e+7)]*=o,o+=1/7;this.Update()}Destroy(){}Inactive(){this.parent.remove(this.instance)}Update(e){const t=this.parent.matrix.elements,i=new y.Vector3(t[0],t[1],t[2]),s=new y.Vector3(t[4],t[5],t[6]),o=new y.Vector3(-t[8],-t[9],-t[10]),r=this.parent.position.clone(),a=(new y.Vector3(0,1,0),this.experience.camera.instance.position.clone());a.sub(r),a.projectOnVector(i);const n=this.experience.camera.instance.position.clone();n.sub(r),n.projectOnVector(s);let h=a.clone();h.add(n),h.add(r),this.sprite_mesh.up=o,this.sprite_mesh.lookAt(h)}}class K{constructor(e,t){this.instance=new y.Object3D,this.instance.renderOrder=10,this.attached_item=null,this.experience=new Nt,this.particle_scatters=[],e.forEach((e=>{let t=new Q(e,this.instance);this.particle_scatters.push(t),this.instance.attach(t.instance)})),this.trail_effects=[],t.forEach((e=>{let t=new J(e,this.instance);this.trail_effects.push(t),this.instance.attach(t.instance)})),this.update_Filter={particle:new Array(e.length).fill(!0),trail:new Array(t.length).fill(!0)},this.experience.scene.add(this.instance)}get position(){return this.instance.position}Destroy(){this.particle_scatters.forEach((e=>{e.Destroy()})),this.trail_effects.forEach((e=>{e.Destroy()})),this.instance.clear(),this.experience.scene.remove(this.instance)}Aim_Fire(e,t){this.particle_scatters[e].Aim_Fire(t)}Burst(e){this.particle_scatters[e].Burst()}Update(e){this.instance.updateMatrix(),this.particle_scatters.forEach(((t,i)=>{t.Update(e)})),this.trail_effects.forEach(((t,i)=>{t.Update(e)}))}SetUpdateFilter(e,t){this.update_Filter[`${e}`]=t}Inactive(e,t){"particle"==e?this.particle_scatters[t].Inactive():"trail"==e&&this.trail_effects[t].Inactive()}Get_Max_Life(){let e=-2e8;return this.particle_scatters.forEach((t=>{let i=t.Get_Max_Life();e=Math.max(e,i)})),e}}let ee=new y.CylinderGeometry(1,1,1);ee.rotateX(Math.PI/2);class te{constructor(){this.experience=new Nt,this.scene=this.experience.scene,this.world=this.experience.world,this.material_manager=this.experience.material,this.Init()}get instance(){return this.effect_obj.instance}get id(){return this.effect_obj.instance.id}Init(){this.particle_params=[{fire_type:"stream",burst_cnt:null,particle_geometry:new y.TorusGeometry(.125/3,.075/3,5,16),particle_material:this.material_manager.referenceMaterial("shootingStar-particle"),particle_texture:"none",mainbody_lifetime:null,colors:[new y.Color("#ffff00"),new y.Color("#ffff00")],origin_position:new y.Vector3(0,0,-.5),direction_heritaged:!0,direction_theta:Math.PI/3,regen_area_type:!1,regen_area:ee,create_interval_time:10,create_interval_time_random:0,rotation_angle_random:Math.PI/6,particle_life_time:400,particle_life_time_random:20,speed:4,speed_end:0,speed_random:.1},{fire_type:"burst",burst_cnt:80,particle_geometry:new y.BoxGeometry(.1,.1,.1),particle_material:this.material_manager.referenceMaterial("shootingStar-particle"),particle_texture:"none",mainbody_lifetime:null,colors:[new y.Color("#dddd00"),new y.Color("#dddd88")],origin_position:new y.Vector3(0,0,0),direction_heritaged:!0,direction_theta:null,regen_area_type:!1,regen_area:new y.BoxGeometry(1,1,1,1,1,1),create_interval_time:null,create_interval_time_random:null,rotation_angle_random:Math.PI/6,particle_life_time:600,particle_life_time_random:0,speed:6,speed_end:0,speed_random:4}],this.effect_obj=new K(this.particle_params,[{name:"shootingStar"}]),this.world.Add_AnimationObject(this.id,this)}Move(e,t,i){let s=b.default.timeline();this.instance.position.copy(e),this.instance.position.setComponent(1,t.y);let o=new y.Object3D;o.position.copy(this.instance.position);let r=new y.Object3D;r.position.addVectors(this.instance.position,t),r.position.multiplyScalar(.5),r.position.setComponent(1,t.y+4),o.lookAt(r.position),o.rotateX(-Math.PI/6),r.lookAt(t),r.rotateX(Math.PI/6);let a=o.quaternion,n=r.quaternion;return this.instance.quaternion.copy(a),s.to(this.instance.position,{ease:"none",x:t.x,z:t.z,duration:i,onComplete:()=>{this.Explode(),this.Inactive(),this.Destroy()},onUpdate:()=>{this.instance.quaternion.slerpQuaternions(a,n,s.time()/i)}}),b.default.timeline().to(this.instance.position,{ease:"Power1.easeOut",y:t.y+4,duration:i/2}).to(this.instance.position,{ease:"Power1.easeIn",y:t.y,duration:i/2}),s}Fire(){}Inactive(){this.effect_obj.Inactive("particle",0),this.effect_obj.Inactive("trail",0)}SetUpdateFilter(e,t){this.effect_obj.SetUpdateFilter(e,t)}Explode(){this.effect_obj.Burst(1),this.Destroy()}Destroy(){let e=this.effect_obj.Get_Max_Life();setTimeout((()=>{this.world.Remove_AnimationObject(this.id),this.effect_obj.Destroy()}),e)}Update(e){this.effect_obj.Update(e)}}let ie=new y.CylinderGeometry(1,1,1);ie.rotateX(Math.PI/2);class se{constructor(){this.experience=new Nt,this.scene=this.experience.scene,this.world=this.experience.world,this.material_manager=this.experience.material,this.Init()}get instance(){return this.effect_obj.instance}get id(){return this.effect_obj.instance.id}Init(){this.particle_params=[{fire_type:"stream",burst_cnt:null,particle_geometry:new y.TorusGeometry(.125/3,.075/3,5,16),particle_material:this.material_manager.referenceMaterial("shootingStar-particle"),particle_texture:"none",mainbody_lifetime:null,colors:[new y.Color("#88ff00"),new y.Color("#88ff00")],origin_position:new y.Vector3(0,0,-.5),direction_heritaged:!1,direction_theta:Math.PI/2,regen_area_type:!1,regen_area:ie,create_interval_time:10,create_interval_time_random:0,rotation_angle_random:Math.PI/6,particle_life_time:400,particle_life_time_random:20,speed:4,speed_end:0,speed_random:.1},{fire_type:"burst",burst_cnt:80,particle_geometry:new y.BoxGeometry(.1,.1,.1),particle_material:this.material_manager.referenceMaterial("shootingStar-particle"),particle_texture:"none",mainbody_lifetime:null,colors:[new y.Color("#88dd22"),new y.Color("#88dd88")],origin_position:new y.Vector3(0,0,0),direction_heritaged:!0,direction_theta:null,regen_area_type:!1,regen_area:new y.BoxGeometry(1,1,1,1,1,1),create_interval_time:null,create_interval_time_random:null,rotation_angle_random:Math.PI/6,particle_life_time:600,particle_life_time_random:0,speed:6,speed_end:0,speed_random:4}],this.effect_obj=new K(this.particle_params,[{name:"healingBall"}]),this.world.Add_AnimationObject(this.id,this)}Move(e,t,i){let s=b.default.timeline();this.instance.position.copy(e),this.instance.position.setComponent(1,t.y);let o=new y.Object3D;o.position.copy(this.instance.position);let r=new y.Object3D;r.position.addVectors(this.instance.position,t),r.position.multiplyScalar(.5),r.position.setComponent(1,t.y+4),o.lookAt(r.position),o.rotateX(-Math.PI/6),r.lookAt(t),r.rotateX(Math.PI/6);let a=o.quaternion,n=r.quaternion;return this.instance.quaternion.copy(a),s.to(this.instance.position,{ease:"none",x:t.x,z:t.z,duration:i,onComplete:()=>{this.Explode(),this.Inactive(),this.Destroy()},onUpdate:()=>{this.instance.quaternion.slerpQuaternions(a,n,s.time()/i)}}),b.default.timeline().to(this.instance.position,{ease:"Power1.easeOut",y:t.y+4,duration:i/2}).to(this.instance.position,{ease:"Power1.easeIn",y:t.y,duration:i/2}),s}Fire(){}Inactive(){this.effect_obj.Inactive("particle",0),this.effect_obj.Inactive("trail",0)}SetUpdateFilter(e,t){this.effect_obj.SetUpdateFilter(e,t)}Explode(){this.effect_obj.Burst(1),this.Destroy()}Destroy(){let e=this.effect_obj.Get_Max_Life();setTimeout((()=>{this.world.Remove_AnimationObject(this.id),this.effect_obj.Destroy()}),e)}Update(e){this.effect_obj.Update(e)}}let oe=new y.CylinderGeometry(1,1,1);oe.rotateX(Math.PI/2);class re{constructor(){this.experience=new Nt,this.scene=this.experience.scene,this.world=this.experience.world,this.material_manager=this.experience.material,this.Init()}get instance(){return this.effect_obj.instance}get id(){return this.effect_obj.instance.id}Init(){this.particle_params=[{fire_type:"stream",burst_cnt:null,particle_geometry:new y.TorusGeometry(.125/3,.075/3,5,16),particle_material:this.material_manager.referenceMaterial("shootingStar-particle"),particle_texture:"none",mainbody_lifetime:null,colors:[new y.Color("#ffff00"),new y.Color("#ffff00")],origin_position:new y.Vector3(0,0,-.5),direction_heritaged:!1,direction_theta:Math.PI/2,regen_area_type:!1,regen_area:oe,create_interval_time:10,create_interval_time_random:0,rotation_angle_random:Math.PI/6,particle_life_time:400,particle_life_time_random:20,speed:4,speed_end:0,speed_random:.1},{fire_type:"burst",burst_cnt:320,particle_geometry:new y.BoxGeometry(.1,.1,.1),particle_material:this.material_manager.referenceMaterial("shootingStar-particle"),particle_texture:"none",mainbody_lifetime:null,colors:[new y.Color("#dddd00"),new y.Color("#dddd88")],origin_position:new y.Vector3(0,0,0),direction_heritaged:!0,direction_theta:null,regen_area_type:!1,regen_area:new y.BoxGeometry(1,1,1,1,1,1),create_interval_time:null,create_interval_time_random:null,rotation_angle_random:Math.PI/6,particle_life_time:1500,particle_life_time_random:0,gravity:new y.Vector3(0,-1.5,0),speed:6,speed_end:0,speed_random:8}],this.effect_obj=new K(this.particle_params,[{name:"shootingStar"}]),this.world.Add_AnimationObject(this.id,this)}Move(e,t,i){let s=b.default.timeline();this.instance.position.copy(e);let o=new y.Object3D;o.position.copy(this.instance.position);let r=new y.Object3D;r.position.addVectors(this.instance.position,t),r.position.multiplyScalar(.5),r.position.setComponent(1,t.y),o.lookAt(r.position),o.rotateX(-Math.PI/24),r.lookAt(t),r.rotateX(0);let a=o.quaternion,n=r.quaternion;return this.instance.quaternion.copy(a),s.to(this.instance.position,{ease:"none",x:t.x,z:t.z,duration:i,onComplete:()=>{this.Explode(),this.Inactive(),this.Destroy()},onUpdate:()=>{this.instance.quaternion.slerpQuaternions(a,n,s.time()/i)}}),b.default.timeline().to(this.instance.position,{ease:"Power1.easeOut",y:t.y,duration:i}),s}Fire(){}Inactive(){this.effect_obj.Inactive("particle",0),this.effect_obj.Inactive("trail",0)}SetUpdateFilter(e,t){this.effect_obj.SetUpdateFilter(e,t)}Explode(){this.effect_obj.Burst(1),this.Destroy()}Destroy(){let e=this.effect_obj.Get_Max_Life();setTimeout((()=>{this.world.Remove_AnimationObject(this.id),this.effect_obj.Destroy()}),e)}Update(e){this.effect_obj.Update(e)}}let ae=new y.CylinderGeometry(.01,.05,1,16);ae.rotateX(Math.PI/2);class ne{constructor(e,t){this.experience=new Nt,this.scene=this.experience.scene,this.world=this.experience.world,this.material_manager=this.experience.material,this.Init(e,t)}get instance(){return this.effect_obj.instance}get id(){return this.effect_obj.instance.id}Init(e,t){let i=1.3*e.distanceTo(t)/.2;this.particle_params=[{fire_type:"stream",burst_cnt:null,particle_geometry:ae.clone(),particle_material:this.material_manager.referenceMaterial("shootingStar-particle"),particle_texture:"none",mainbody_lifetime:200,colors:[new y.Color("#0000ff"),new y.Color("#0033ff")],origin_position:new y.Vector3(0,0,-.5),direction_heritaged:!0,direction_theta:Math.PI/8,direction_scale:new y.Vector3(1,.2,1),regen_area_type:!1,regen_area:ae,create_interval_time:10,create_interval_time_random:0,rotation_angle_random:0,particle_life_time:200,particle_life_time_random:0,speed:i,speed_end:i,speed_random:0,opacity_interpolation:"None"}],this.effect_obj=new K(this.particle_params,[]),this.effect_obj.instance.position.copy(e),this.effect_obj.instance.lookAt(t),this.world.Add_AnimationObject(this.id,this),setTimeout((()=>{this.Destroy()}),4*this.particle_params[0].mainbody_lifetime)}Destroy(){let e=this.effect_obj.Get_Max_Life();setTimeout((()=>{this.world.Remove_AnimationObject(this.id),this.effect_obj.Destroy()}),e)}Update(e){this.effect_obj.Update(e)}}const he=new y.Vector3(0,-2,15);class le{constructor(e,t,i,s){this.name=e,this.info=i;let o=i;Object.keys(o).forEach((e=>{this[`${e}`]=i[`${e}`]})),this.power=s.power,this.extraPower=s.extraPower,this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.debug=this.experience.debug,this.opponent="top"==this.owner?"bottom":"top",this.isPlaying=!1,this.state="tray",this.soundManager=this.experience.sound,this.setTextures(e),this.setGeometry(e),this.setMaterial(),this.setMesh(t),this.setEffect(e),"Odin"===this.name&&this.setDebug()}GameOver(){this.Playing_Off(),this.RemoveScene(),this.setPosition(he),this.Highlight_Off(),this.Ban_Off(),this.state="tray"}Playing_On(){this.isPlaying=!0}Playing_Off(){this.isPlaying=!1}Hover_On(){this.mesh.layers.enable(1)}Hover_Off(){this.mesh.layers.disable(1)}setTextures(e){this.texture=this.resources.items[`god${e}Texture`],this.texture.encoding=y.sRGBEncoding,this.imageAspect=this.texture.image.width/this.texture.image.height,this.normalmap=this.resources.items[`god${e}NormalmapTexture`],this.normalmap.encoding=y.sRGBEncoding}setGeometry(e){this.geometry=new y.ExtrudeGeometry(this.resources.items[`${e}SVG`],{steps:1,depth:25,curveSegments:4,bevelEnabled:!0,bevelThickness:5,bevelSize:7,bevelOffset:2,bevelSegments:4});let t=2e8,i=-2e8,s=2e8,o=-2e8,r=this.geometry.attributes.position.array;for(let e=0;e<r.length;e+=3){let a=r[e];t=Math.min(t,a),i=Math.max(i,a);let n=r[e+1];s=Math.min(s,n),o=Math.max(o,n)}let a=.95*(i-t),n=.95*(o-s);for(let e=0;e<r.length;e+=2)this.geometry.attributes.uv.array[e]=(this.geometry.attributes.uv.array[e]+a/2)/a,this.geometry.attributes.uv.array[e+1]=(this.geometry.attributes.uv.array[e+1]+n/2)/n;let h=.009,l=this.geometry.attributes.position.array;for(let e=0;e<l.length;e+=3)this.geometry.attributes.position.array[e]*=h,this.geometry.attributes.position.array[e+1]*=h,this.geometry.attributes.position.array[e+2]*=h}setMaterial(){this.material=new y.MeshStandardMaterial({map:this.texture,normalMap:this.normalmap,side:y.DoubleSide,metalness:.75,roughness:.75,aoMapIntensity:.28,envMapIntensity:8,normalScale:new y.Vector2(1,1)}),this.material.color.set(new y.Color(11238985)),this.org_color=this.material.color.clone(),this.material_arr=[this.material,new y.MeshStandardMaterial({map:this.resources.items.wood_table_worn_diff,side:y.DoubleSide})]}Highlight_On_Pick(){let e=b.default.timeline();return e.to(this.effectMesh.material,{ease:"none",duration:.15,opacity:0}),e.to(this.effectMesh.material,{ease:"none",duration:.7,opacity:.3}),e}Highlight_On(){return b.default.to(this.effectMesh.material,{ease:"none",duration:.2,opacity:.3})}Highlight_Off(){b.default.to(this.effectMesh.material,{ease:"none",duration:.2,opacity:0})}Ban_On(){let e=this.mesh.material[0].color;return b.default.to(e,{ease:"none",duration:.2,r:.125,g:.125,b:.125})}Ban_Off(){let e=this.mesh.material[0].color;b.default.to(e,{ease:"none",duration:.2,r:this.org_color.r,g:this.org_color.g,b:this.org_color.b})}Blink(){let e=b.default.timeline();return e.to(this.effectMesh.material,{ease:"none",duration:.15,opacity:0}),e.to(this.effectMesh.material,{ease:"none",duration:.7,opacity:.4}),e.to(this.effectMesh.material,{delay:1,ease:"none",duration:.7,opacity:0}),new Promise((e=>{setTimeout((()=>{e(!0)}),1200)}))}FilterScene(){1==this.isPlaying?this.AddScene():0==this.isPlaying&&this.RemoveScene()}AddScene(){this.mesh.visible=!0}RemoveScene(){this.mesh.visible=!1}setMesh(e){this.mesh=new y.Mesh(this.geometry,this.material_arr),this.mesh.position.copy(e),this.mesh.rotateX(-Math.PI/2),this.mesh.castShadow=!0,this.scene.add(this.mesh)}setEffect(e){let t=this.resources.items[`god${e}Effect`];if(!t)return;const i=new y.ShapeGeometry(t);let s=.009,o=i.attributes.position.array;for(let e=0;e<o.length;e+=3)i.attributes.position.array[e]*=s,i.attributes.position.array[e+1]*=s,i.attributes.position.array[e+2]*=s;const r=new y.MeshBasicMaterial({color:"#ffff44",depthWrite:!1,transparent:!0,opacity:0});this.effectMesh=new y.Mesh(i,r),this.effectMesh.position.z+=.3,this.effectMesh.layers.enable(1),this.mesh.add(this.effectMesh)}CheckCanUse(e,t){return this.cost[e]>=t}getID(){return this.mesh.id}getPosition(){return this.mesh.position.clone()}PoisonNeedles_Fire(e,t){new ne(e,t)}FireWorks_Fire(e,t=null){let i;i=null!=t?t:this.getPosition();let s=[];return e.forEach((e=>{let t=(new re).Move(i,e,1);s.push(t)})),Promise.all(s)}HealingBall_Fire(e,t=null){let i;i=null!=t?t:this.getPosition();let s=[];return e.forEach((e=>{let t=(new se).Move(i,e,.7);s.push(t)})),Promise.all(s)}ShootingStar_Fire(e,t=null){let i;i=null!=t?t:this.getPosition();let s=[];return e.forEach((e=>{let t=(new te).Move(i,e,.7);s.push(t)})),Promise.all(s)}setPosition(e){this.mesh.position.copy(e)}moveSlide(e){let t=this.mesh.position.x+5*e;return b.default.to(this.mesh.position,{duration:.5,ease:"Power2.easeOut",x:t})}moveTo(e,t=0){return b.default.timeline().to(this.mesh.position,{duration:1,delay:t,ease:"Power2.easeOut",x:e.x,y:e.y,z:e.z}).to(this.mesh.position,{duration:.2,ease:"none",y:.1})}active(){this.debug.active&&this.debugFolder.show()}deactive(){this.debug.active&&this.debugFolder.hide()}__dbg_action(){this.power(0,this.experience.world.avatars.bottom,this.experience.world.avatars.top)}setDebug(){this.debug.active&&(this.debugFolder=this.debug.ui.addFolder(`god favor ${this.mesh.id}`),this.debugFolder.addColor(this.material,"color").name("body_color"),this.debugFolder.add(this.material.normalScale,"x").min(0).max(1).step(.001).name("normal_x"),this.debugFolder.add(this.material.normalScale,"y").min(0).max(1).step(.001).name("normal_y"),this.debugFolder.add(this.material,"aoMapIntensity").min(0).max(1).step(.001).name("aoMapIntensity"),this.debugFolder.add(this.material,"roughness").min(0).max(1).step(.001).name("roughness"),this.debugFolder.add(this.material,"metalness").min(0).max(1).step(.001).name("metalness"),this.debugFolder.add(this.material,"envMapIntensity").min(0).max(10).step(.001).name("envMapIntensity"))}canUseThePower(e){}Power___(e,t){switch(this.name){case"Thor":this.ThorPower(e,t);break;case"Idun":this.IdunPower(e,t);break;case"Odin":this.OdinPower(e,t)}}ThorPower(e,t){let i=this.info.effectValue[e],s=(this.info.cost[e],this.experience.game.playerController[`${this.opponent}`]),o=0;for(;o!=i&&0!=s.health;){let e=new Weapon("mjolnir",this.mesh.position);e.appear(),e.setTarget(s.getLastHealthStone()),s.health--,t.add(e.anim,"start"),o++}}IdunPower(e,t){}OdinPower(e,t){}}class ce{constructor(){this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.debug=this.experience.debug,this.original_position=null,this.setGeometry(),this.setTexture(),this.setMaterial(),this.setMesh()}setGeometry(){let e=2.8,t=.1;this.height_=1.35,this.outerWallGeometry=new y.CylinderGeometry(2.9,2.9,this.height_,32,4,!0),this.innerWallGeometry=new y.CylinderGeometry(e-t,e-t,this.height_,32,4,!0),this.thicknessGeometry=new y.RingGeometry(e-t,2.9,32,1),this.flatGeometry=new y.CylinderGeometry(e-t,e-t,t,32,3)}setTexture(){this.textureDiffuse=this.resources.items.tray_map,this.textureNormal=this.resources.items.tray_normal,this.textureRoughness=this.resources.items.tray_roughness,["textureDiffuse","textureNormal","textureRoughness"].forEach((e=>{this[`${e}`].encoding=y.sRGBEncoding,this[`${e}`].repeat.set(1,1),this[`${e}`].wrapS=y.RepeatWrapping,this[`${e}`].wrapT=y.RepeatWrapping,this[`${e}`].anisotropy=16}))}setMaterial(){this.material=new y.MeshStandardMaterial({map:this.textureDiffuse,normalMap:this.textureNormal,envMapIntensity:1.75,metalness:.15,roughness:.85}),this.material.flatshading=!1,this.material.side=y.DoubleSide,this.resources.items.traywall_map.repeat.set(1.5,1),this.resources.items.traywall_map.encoding=y.sRGBEncoding,this.resources.items.traywall_map.wrapS=y.RepeatWrapping,this.resources.items.traywall_map.wrapT=y.RepeatWrapping,this.resources.items.traywall_normal.repeat.set(1.5,1),this.resources.items.traywall_normal.encoding=y.sRGBEncoding,this.resources.items.traywall_normal.wrapS=y.RepeatWrapping,this.resources.items.traywall_normal.wrapT=y.RepeatWrapping,this.resources.items.traywall_roughness.repeat.set(1.5,1),this.resources.items.traywall_roughness.encoding=y.sRGBEncoding,this.resources.items.traywall_roughness.wrapS=y.RepeatWrapping,this.resources.items.traywall_roughness.wrapT=y.RepeatWrapping,this.wall_material=new y.MeshStandardMaterial({map:this.resources.items.traywall_map,normalMap:this.resources.items.traywall_normal,metalness:.15,roughness:.85,envMapIntensity:2.5}),this.wall_material.flatshading=!1,this.wall_material.side=y.DoubleSide}setMesh(){this.outerWallMesh=new y.Mesh(this.outerWallGeometry,this.wall_material),this.innerWallMesh=new y.Mesh(this.innerWallGeometry,this.wall_material),this.thicknessMesh=new y.Mesh(this.thicknessGeometry,this.material),this.thicknessMesh.rotation.x-=Math.PI/2,this.flatMesh=new y.Mesh(this.flatGeometry,this.material),this.outerWallMesh.position.y=this.height_/2,this.innerWallMesh.position.y=this.height_/2,this.thicknessMesh.position.y=this.height_,this.outerWallMesh.rotateY(Math.PI),this.mesh=new y.Group,this.mesh.add(this.outerWallMesh),this.mesh.add(this.innerWallMesh),this.mesh.add(this.thicknessMesh),this.mesh.add(this.flatMesh),this.flatMesh.receiveShadow=!0,this.outerWallMesh.castShadow=!0,this.innerWallMesh.receiveShadow=!0,this.innerWallMesh.castShadow=!0,this.scene.add(this.mesh)}Move(e){return b.gsap.to(this.mesh.position,{duration:.3,ease:"none",z:e.z})}Set_Original_Position(){this.original_position=this.mesh.position.clone()}Reset_Position(){this.Move(this.original_position)}setDebug(){this.debug.active&&(this.debugFolder=this.debug.ui.addFolder("Tray"),this.debugFolder.addColor(this.material,"color"),this.debugFolder.addColor(this.material,"emissive"),this.debugFolder.add(this.material,"displacementScale").name("symbol displacement Scale").min(0).max(1).step(.001).listen(),this.debugFolder.add(this.material,"displacementBias").name("symbol displacement Bias").min(-2).max(2).step(.001).listen(),this.debugFolder.add(this.material,"aoMapIntensity").name("aoMapIntensity").min(0).max(1).step(.001).listen(),this.debugFolder.add(this.material.normalScale,"x").name("normal Scale X").min(0).max(1).step(.001).listen(),this.debugFolder.add(this.material.normalScale,"y").name("normal Scale Y").min(0).max(1).step(.001).listen(),this.debugFolder.add(this.material,"metalness").name("metalness").min(0).max(1).step(.001).listen(),this.debugFolder.add(this.material,"roughness").name("roughness").min(-1).max(2).step(.001).listen(),this.debugFolder.add(this.mesh.position,"x").name("position X").min(-10).max(10).step(.001).listen(),this.debugFolder.add(this.mesh.position,"y").name("position Y").min(-1).max(5).step(.001).listen(),this.debugFolder.add(this.mesh.position,"z").name("position Z").min(-10).max(10).step(.001).listen())}}x.d({},{});class de{constructor(){this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.debug=this.experience.debug,this.setGeometry(),this.setTextures(),this.setMaterial(),this.setMesh();let e=this.createCarpetBorder();e.position.y=-.325,e.position.z=-10,this.scene.add(e);let t=this.createWoodTable();t.position.z=-15,t.position.y=-.5,this.scene.add(t),this.setDebug()}createCarpetBorder(){let e=[];for(let t=-30;t<=30;t+=6)e.push(new y.Vector3(t,0,.5*(Math.random()-.5)));const t=new y.CatmullRomCurve3(e);let i=this.resources.items.carpet_border_O;i.repeat.set(5,3),i.encoding=y.sRGBEncoding,i.wrapS=y.RepeatWrapping,i.wrapT=y.RepeatWrapping,i.anisotropy=8;const s=new y.TubeGeometry(t,64,.75,3,!1),o=new y.MeshStandardMaterial({map:i,bumpScale:5e-4,roughness:.95,envMapIntensity:3}),r=new y.Mesh(s,o);return r.rotateZ(Math.PI),r}createWoodTable(){let e=this.resources.items.wood02_map,t=this.resources.items.wood02_normal,i=this.resources.items.wood02_roughness;e.encoding=y.sRGBEncoding,t.encoding=y.sRGBEncoding,i.encoding=y.sRGBEncoding,e.repeat.set(4,4),t.repeat.set(4,4),i.repeat.set(4,4),e.wrapS=y.RepeatWrapping,e.wrapT=y.RepeatWrapping,t.wrapS=y.RepeatWrapping,t.wrapT=y.RepeatWrapping,i.wrapS=y.RepeatWrapping,i.wrapT=y.RepeatWrapping;let s=new y.PlaneGeometry(60,15,64,16);this.wood_mat=new y.MeshStandardMaterial({map:e,normalMap:t,roughnessMap:i,metalness:.3,roughness:.7});let o=new y.Mesh(s,this.wood_mat);return o.rotation.x=.5*-Math.PI,o}setGeometry(){this.geometry=new y.PlaneGeometry(60,40,64,64)}setTextures(){this.textures={},this.textureArm=this.resources.items.book_pattern_arm,this.textureDiffuse=this.resources.items.book_pattern_diff_I,this.textureNormal=this.resources.items.book_pattern_nor,["textureArm","textureNormal","textureDiffuse"].forEach((e=>{this[`${e}`].encoding=y.sRGBEncoding,this[`${e}`].repeat.set(2.25,1.5),this[`${e}`].wrapS=y.RepeatWrapping,this[`${e}`].wrapT=y.RepeatWrapping,this[`${e}`].anisotropy=8}))}setMaterial(){this.material=new y.MeshStandardMaterial({map:this.textureDiffuse,normalMap:this.textureNormal,normalScale:new y.Vector2(.5,.5),aoMap:this.textureArm,roughnessMap:this.textureArm,bumpScale:5e-4,metalness:.2,roughness:.8})}setMesh(){this.mesh=new y.Mesh(this.geometry,this.material),this.mesh.rotation.x=.5*-Math.PI,this.mesh.position.z=10,this.mesh.receiveShadow=!0,this.scene.add(this.mesh)}setDebug(){this.debug.active&&(this.debugFolder=this.debug.ui.addFolder("Table"),this.debugFolder.addColor(this.wood_mat,"color"))}}function ue(e){let t=(new Nt).resources.items.perlin_noise,i=e.clone();return i.transparent=!0,i.opacity=1,i.uTime={value:.4},i.uOffset={value:new y.Vector2(0,0)},i.uThreshold={value:.3},i.uMixTexture={value:t},i.onBeforeCompile=e=>{e.uniforms.uTime=i.uTime,e.uniforms.uThreshold=i.uThreshold,e.uniforms.uMixTexture=i.uMixTexture,e.uniforms.uOffset=i.uOffset,e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n\n            uniform float uTime;\n            uniform float uThreshold;\n            uniform sampler2D uMixTexture;\n            uniform vec2 uOffset;\n            "),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","\n            #include <color_fragment>\n    \n            float mixRatio = uTime;\n\n            vec2 uv;\n            uv.x = vUv.x + uOffset.x;\n            uv.y = vUv.y + uOffset.y;\n            \n            vec4 material_ = diffuseColor;\n            vec4 empty = vec4(0.0, 0.0, 0.0, 0.0);\n            vec4 transitionTexel = texture2D(uMixTexture, uv);\n    \n            float r = mixRatio * (1.0 + uThreshold * 2.0) - uThreshold;\n            float mixf = clamp((transitionTexel.x  - r)*(1.0/uThreshold), 0.0, 1.0);\n\n\n            mixf = step(0.5, mixf);\n            \n            diffuseColor = mix( empty, material_, mixf );\n            ")},i}function me(e){let t=(new Nt).resources.items.perlin_noise,i=e.clone();return i.transparent=!0,i.opacity=1,i.uTime={value:.4},i.uThreshold={value:.5},i.uMixTexture={value:t},i.uOutlineColor={value:new y.Vector4(.8,.8,.2,1)},i.uThickness_In={value:.25},i.uThickness_Out={value:.75},i.uOffset={value:new y.Vector2(0,0)},i.onBeforeCompile=e=>{e.uniforms.uTime=i.uTime,e.uniforms.uOffset=i.uOffset,e.uniforms.uThreshold=i.uThreshold,e.uniforms.uMixTexture=i.uMixTexture,e.uniforms.uOutlineColor=i.uOutlineColor,e.uniforms.uThickness_In=i.uThickness_In,e.uniforms.uThickness_Out=i.uThickness_Out,e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n\n            uniform float uTime;\n            uniform float uThreshold;\n            uniform sampler2D uMixTexture;\n            uniform vec4 uOutlineColor;\n            \n            uniform float uThickness_In;\n            uniform float uThickness_Out;\n            \n            uniform vec2 uOffset;\n            "),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","\n            #include <color_fragment>\n    \n            float mixRatio = uTime;\n\n            vec2 uv;\n            uv.x = vUv.x + uOffset.x;\n            uv.y = vUv.y + uOffset.y;\n            \n            vec4 empty = vec4(0.0, 0.0, 0.0, 0.0);\n            vec4 transitionTexel = texture2D(uMixTexture, uv);\n    \n            float r = mixRatio * (1.0 + uThreshold * 2.0) - uThreshold;\n            float mixf = clamp((transitionTexel.x  - r)*(1.0/uThreshold), 0.0, 1.0);\n\n            float outline_A = step(uThickness_Out, mixf);\n            float outline_B = step(uThickness_In, mixf);\n            float outline_ = outline_B - outline_A;\n            \n            vec4 outline;\n            outline.x = uOutlineColor.x;\n            outline.y = uOutlineColor.y;\n            outline.z = uOutlineColor.z;\n            outline.w = uOutlineColor.w;\n\n            mixf = step(0.5, mixf);\n            \n            diffuseColor = mix(empty, outline, outline_);\n            ")},i}class pe{constructor(e){this.experience=new Nt,this.debug=this.experience.debug,this.scene=this.experience.scene,this.resources=this.experience.resources;const t=function(e){const t=e.attributes.position.count;let i=Object.keys(e.attributes),s=e.attributes,o=new y.BufferGeometry;i.forEach((e=>{let t=s[`${e}`];o.setAttribute(e,t.clone())}));const r=new Float32Array(3*t),a=new Float32Array(3*t),n=new Float32Array(3*t),h=new Float32Array(3*t);for(let e=0;e<t;e++){let t=s.position.array[3*e+0],i=s.position.array[3*e+1],o=s.position.array[3*e+2];r[3*e+0]=0,r[3*e+1]=0,r[3*e+2]=0,a[3*e+0]=t+y.MathUtils.randFloat(.75,2),a[3*e+1]=i+1.5*y.MathUtils.randFloat(0,3),a[3*e+2]=o+y.MathUtils.randFloatSpread(1.5),n[3*e+0]=t-y.MathUtils.randFloat(2,3),n[3*e+1]=i+1.5*y.MathUtils.randFloat(1,4.5),n[3*e+2]=o+y.MathUtils.randFloatSpread(2),h[3*e+0]=t+y.MathUtils.randFloatSpread(1),h[3*e+1]=i+1.5*y.MathUtils.randFloat(1.5,7),h[3*e+2]=o+y.MathUtils.randFloat(-.5,.5)}return o.setAttribute("color",new y.BufferAttribute(r,3)),o.setAttribute("aControl0",new y.BufferAttribute(a,3)),o.setAttribute("aControl1",new y.BufferAttribute(n,3)),o.setAttribute("aEndPosition",new y.BufferAttribute(h,3)),o}(e),i=new y.PointsMaterial({map:this.resources.items.particle_star_06,size:.6,sizeAttenuation:!0,depthWrite:!1,blending:y.AdditiveBlending,vertexColors:!0});this.material=function(e){let t=(new Nt).resources.items.perlin_noise,i=e.clone();return i.transparent=!0,i.opacity=1,i.uTime={value:.1},i.uDelay={value:.1},i.uThreshold={value:.75},i.uMixTexture={value:t},i.uParticleColor={value:new y.Vector3(.8,.8,.2)},i.onBeforeCompile=e=>{e.uniforms.uTime=i.uTime,e.uniforms.uDelay=i.uDelay,e.uniforms.uThreshold=i.uThreshold,e.uniforms.uMixTexture=i.uMixTexture,e.uniforms.uParticleColor=i.uParticleColor,e.vertexShader=e.vertexShader.replace("#include <common>","#include <common>\n\n            uniform float uTime;\n            uniform float uDelay;\n            uniform float uThreshold;\n            uniform sampler2D uMixTexture;\n            uniform vec3 uParticleColor;\n\n            attribute vec3 aControl0;\n            attribute vec3 aControl1;\n            attribute vec3 aEndPosition;\n\n            varying vec2 vUv;\n\n            vec3 bezier(vec3 A, vec3 B, vec3 C, vec3 D, float t) {\n                vec3 E = mix(A, B, t);\n                vec3 F = mix(B, C, t);\n                vec3 G = mix(C, D, t);\n              \n                vec3 H = mix(E, F, t);\n                vec3 I = mix(F, G, t);\n              \n                vec3 P = mix(H, I, t);\n              \n                return P;\n              }\n            "),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n            #include <begin_vertex>\n    \n            float mixRatio = uTime - uDelay;\n            \n            vec4 empty = vec4(0.0, 0.0, 0.0, 0.0);\n            vec4 transitionTexel = texture2D(uMixTexture, uv);\n    \n            float r = mixRatio * (1.0 + uThreshold * 2.0) - uThreshold;\n            float mixf = clamp((transitionTexel.x  - r)*(1.0/uThreshold), 0.0, 1.0);\n\n\n            // transformed.y += aEndPosition.y * mixf;\n            transformed = bezier(transformed, aControl0, aControl1, aEndPosition, 1.0 - mixf);\n\n            vColor.x = uParticleColor.x;\n            vColor.y = uParticleColor.y;\n            vColor.z = uParticleColor.z;\n            // size.x = 0.1;\n            // size.y = 0.1;\n            // size.z = 0.1;\n            vUv = uv;\n            "),e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n\n            uniform float uTime;\n            uniform float uDelay;\n            uniform float uThreshold;\n            uniform sampler2D uMixTexture;\n            varying vec2 vUv;\n            "),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","\n            #include <color_fragment>\n    \n            float mixRatio = uTime - uDelay;\n\n            \n            vec4 material_ = diffuseColor;\n            vec4 empty = vec4(0.0, 0.0, 0.0, 0.0);\n            vec4 transitionTexel = texture2D(uMixTexture, vUv);\n    \n            float r = mixRatio * (1.0 + uThreshold * 2.0) - uThreshold;\n            float mixf = clamp((transitionTexel.x  - r)*(1.0/uThreshold), 0.0, 1.0);\n\n\n            float a = step(0.001, mixf);\n            float b = 1.0 - step(0.999, mixf);\n\n            diffuseColor = mix( empty, material_, a * b * mixf );\n            ")},i}(i),i.dispose(),this.points=new y.Points(t,this.material),this.points.layers.enable(1)}}class _e{get mesh(){return this.model.mesh}constructor(e){this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.materialManager=this.experience.material,this.geometryManager=this.experience.geometry,this.debug=this.experience.debug,this.avatarIndex,this.eventEmitter,this.originalColor=null,this.owner=e,this.modelName="health-stone",this.anim=b.default.timeline(),this.uTime={value:0},this.state="fine",this.next_stone=null,this.setModel()}InitialGame(){this.Hover_Off(),this.Highlighting_Off(),this.BloomEffectOff(),this.CastShadow_On(),this.Recovery()}Hover_On(){this.Highlighting_On()}Hover_Off(){this.Highlighting_Off()}Highlighting_On(){this.model.mesh.layers.enable(1),this.model.mesh.material.color.set(new y.Color(1,.25,.05)),null!=this.next_stone&&"fine"==this.next_stone.state&&this.next_stone.Highlighting_On()}Highlighting_Off(){this.model.mesh.layers.disable(1),this.model.mesh.material.color.copy(this.originalColor),null!=this.next_stone&&"fine"==this.next_stone.state&&this.next_stone.Highlighting_Off()}CastShadow_On(){this.model.mesh.castShadow=!0}CastShadow_Off(){this.model.mesh.castShadow=!1}SyncToState(){switch(this.state){case"fine":this.uTime.value=0,this.CastShadow_On();break;case"destroy":this.uTime.value=1,this.CastShadow_Off()}}Damaged(e="default"){this.owner.DamageAnim(),this.state="destroy","default"!=e&&this.ChangeDamageEffect(e);let t=ge[`${e}`];"axe"==t?this.experience.sound.Play_AxeDamage():"arrow"==t&&this.experience.sound.Play_ArrowDamage();let i=b.default.timeline();return i.to(this.uTime,{delay:.1,duration:3,value:1,onStart:()=>{this.eventEmitter&&this.eventEmitter.trigger(`${this.avatarIndex}-damage-${t}-anim`,[this.GetPosition()]),this.BloomEffectOn(),this.CastShadow_Off()},onComplete:()=>{this.BloomEffectOff();let t=this.model.GetPosition().clone();this.model.SetPosition(t),"default"!=e&&this.ChangeDamageEffect("default"),this.SyncToState()}}),i}Recovery(e){this.uTime.value=0,this.state="fine",this.SyncToState()}ChangeDamageEffect(e){this.ChangeEffectColor(e)}ChangeEffectColor(e){switch(fe[`${e}`]){case"default":this.particle.material.uParticleColor.value.set(.8,.8,.2),this.outline_material.uOutlineColor.value.set(.8,.8,.2,1);break;case"mjolnir":this.particle.material.uParticleColor.value.set(.05,.6,.9),this.outline_material.uOutlineColor.value.set(.05,.6,.9,1)}}ChangeMaterialColor(e){let t=this.model.mesh.material,i={};t.color.getHSL(i,y.LinearSRGBColorSpace);let s=new y.Color;s.setHSL(e,i.s,i.l);let o=b.default.timeline();o.to(this,{ease:"none",duration:.6,onUpdate:()=>{t.color.lerpColors(this.originalColor,s,o.time()/.6)}})}ResetMaterialColor(){let e=this.model.mesh.material,t=e.color.clone(),i=b.default.timeline();i.to(this,{ease:"none",duration:.6,onUpdate:()=>{e.color.lerpColors(t,this.originalColor,i.time()/.6)}})}Shine_On(){this.model.mesh.layers.enable(1)}Shine_Off(){this.model.mesh.layers.disable(1)}BloomEffectOn(){this.outline_mesh.layers.isEnabled(1)||this.outline_mesh.layers.enable(1)}BloomEffectOff(){this.outline_mesh.layers.isEnabled(1)&&this.outline_mesh.layers.disable(1)}Extinguish(){}Action(e,t){return this.model.Action(e,t)}setModel(){this.model=new M("health-stone");let e=this.model.mesh.material,t=this.model.mesh.geometry,i={};e.color.getHSL(i,y.LinearSRGBColorSpace);let s,o,r=.05+t.index__/14*.7,a=i.h;"top"===t.team__&&(a=.5),e.color.setHSL(a,i.s,r),this.originalColor=e.color.clone(),this.mask_material,this.outline_material,[s,o]=function(e){return[ue(e),me(e)]}(e),this.mask_material=s,this.model.mesh.material=this.mask_material,this.outline_material=o,this.outline_mesh=new y.Mesh(t,this.outline_material),this.particle=new pe(t),this.model.mesh.add(this.outline_mesh),this.model.mesh.add(this.particle.points),this.model.mesh.material.uTime=this.uTime,this.outline_material.uTime=this.uTime,this.particle.material.uTime=this.uTime}SetPosition(e){this.model.SetPosition(e)}SetOpacity(e){this.model.SetOpacity(e)}GetPosition(){return this.model.GetPosition()}Instantiate(){}AnimationDamage(){}AnimationRecovery(){}getID(){return this.model.getID()}AnimationAppearance(e=.5){return this.model.AnimationAppearance(e)}Blink(){return this.model.Blink()}}const ge={arrow:"arrow",axe:"axe",mjolnir:"godfavor"},fe={default:"default",arrow:"default",axe:"default",mjolnir:"mjolnir"};class xe{constructor(e){this.experience=new Nt,this.scene=this.experience.scene,this.isSwap=0,this.experience.resources.items.uv_checker.encoding=y.sRGBEncoding;let t=this.experience.resources.items.coin_green,i=this.experience.resources.items.coin_green_normal;t.encoding=y.sRGBEncoding,i.encoding=y.sRGBEncoding,t.center=new y.Vector2(.5,.5),t.rotation=-(Math.PI/2+Math.PI/15.5),i.center=new y.Vector2(.5,.5),i.rotation=-(Math.PI/2+Math.PI/15.5);let s=this.experience.resources.items.coin_blue,o=this.experience.resources.items.coin_blue_normal;s.encoding=y.sRGBEncoding,o.encoding=y.sRGBEncoding,s.center=new y.Vector2(.5,.5),s.rotation=Math.PI-Math.PI/8,o.center=new y.Vector2(.5,.5),o.rotation=Math.PI-Math.PI/8;let r=new y.CylinderGeometry(1.25,1.25,.15,32),a=[new y.MeshStandardMaterial({color:"black",metalness:.4,roughness:.6}),new y.MeshStandardMaterial({map:s,normalMap:o,metalness:.45,roughness:.55}),new y.MeshStandardMaterial({map:t,normalMap:i,metalness:.5,roughness:.5})];this.coinMesh=new y.Mesh(r,a),this.coinMesh.castShadow=!0,this.scene.add(this.coinMesh),this.anchors=e,this.turn_player_index=0}SetPositionOrigin(){this.coinMesh.position.set(0,.075,0)}GameOver(){this.isSwap=0,this.turn_player_index=0,this.SetPositionOrigin()}PlayerSwap(){this.isSwap=1}SetFirstPlayer(e){this.turn_player_index=e}GetCoinFaceDirection(e){return(e+this.isSwap)*Math.PI}GetCoinPosition(e){let t=(e+this.isSwap)%2;return this.anchors[t]}FlyToNextAnchor(){let e=this.GetCoinFaceDirection(this.turn_player_index),t=this.GetCoinPosition(this.turn_player_index);this.turn_player_index=(this.turn_player_index+1)%2,b.default.timeline({defaults:{duration:.15}}).to(this.coinMesh.position,{ease:"sine.out",delay:.5,y:3.5}).to(this.coinMesh.position,{ease:"sine.in",y:.075}),b.default.to(this.coinMesh.position,{delay:.5,duration:.3,ease:"none",x:t.x,z:t.z}),b.default.to(this.coinMesh.rotation,{delay:.6,duration:.2,ease:"none",x:e})}Flip(e,t){this.coinMesh.position.y=.075;let i=this.GetCoinFaceDirection(e);this.coinMesh.rotation.x=i;let s=b.default.timeline().from(this.coinMesh.position,{delay:t,duration:.7,ease:"Power1.easeIn",y:7,onStart:()=>{this.experience.sound.Play_FlipCoin()}}).from(this.coinMesh.position,{duration:.7,ease:"Power2.easeOut",z:11.5},"<").from(this.coinMesh.rotation,{duration:.7,ease:"none",x:6*Math.PI},"<");return b.default.to(this.coinMesh.position,{duration:1,delay:1.2+t,onComplete:()=>{this.FlyToNextAnchor()}}),s}}const ye=300;let ve=new y.Matrix4;class we{static instance=null;constructor(){null==we.instance&&(we.instance=this,this.experience=new Nt,this.world=this.experience.world,this.scene=this.experience.scene,this.resources=this.experience.resources,this.geometryManager=this.experience.geometry,this.materialManager=this.experience.material,this.debug=this.experience.debug,this.original_color=new y.Color(16737826),this.Initialize())}get instance(){return this.effect_mesh}Initialize(){let e=new Float32Array(ye);for(let t=0;t<ye;t++)e[t]=0;this.effect_geometry=this.geometryManager.items.token.clone(),this.effect_geometry.setAttribute("alpha",new y.InstancedBufferAttribute(e,1,!0,1)),this.effect_materials=[,,this.materialManager.referenceMaterial("token_effect"),,,,],this.effect_mesh=new y.InstancedMesh(this.effect_geometry,this.effect_materials,ye),this.effect_mesh.layers.enable(1),this.index_queue=Array.from(Array(ye).keys()),this.particle_infos=[];let t=new y.Vector3(0,-3,20);for(let e=0;e<ye;e++){let i=new y.Matrix4;i.setPosition(new y.Vector3(0,-1,20)),this.effect_mesh.setMatrixAt(e,i),i.setPosition(t),this.effect_mesh.setMatrixAt(e,i),this.particle_infos.push(new be(e))}this.effect_mesh.renderOrder=1,this.effect_mesh.instanceMatrix.needsUpdate=!0,this.scene.add(this.effect_mesh),this.world.Add_AnimationObject(this.instance.id,this)}GetParticle(){let e=this.index_queue.pop();return null==e?null:this.particle_infos[e]}ReturnParticle(e){this.index_queue.push(e)}initialMove(e,t,i){return this.GetParticle().initialMove(e,t,i)}Spend(e){return this.GetParticle().Spend(e)}slideMove(e,t){return this.GetParticle().slideMove(e,t)}SetMatrixAt(e,t){this.instance.setMatrixAt(e,t),this.instance.instanceMatrix.needsUpdate=!0}SetOpacityAt(e,t){this.effect_mesh.geometry.attributes.alpha.array[e]=t,this.effect_mesh.geometry.attributes.alpha.needsUpdate=!0}Update(){for(let e=0;e<ye;e++){let t,i,s=e,o=this.particle_infos[s];1==be.needsUpdate[s]&&(t=o.effect_matrix,this.SetMatrixAt(s,t),be.needsUpdate[s]=!1),1==be.needsEffectUpdate[s]&&(i=o.opacity.effect,this.SetOpacityAt(s,i))}}}class be{static needsUpdate=new Array(ye).fill(!1);static needsEffectUpdate=new Array(ye).fill(!1);constructor(e){this.index=e,this.position={vec:new y.Vector3(0,-3,20),get x(){return this.vec.x},get y(){return this.vec.y},get z(){return this.vec.z},set x(e){this.vec.setX(e),be.needsUpdate[this.index]=!0},set y(e){this.vec.setY(e),be.needsUpdate[this.index]=!0},set z(e){this.vec.setZ(e),be.needsUpdate[this.index]=!0}},this.position.index=e,this.opacity={effect_:0,get effect(){return this.effect_},set effect(e){this.effect_=e,be.needsEffectUpdate[this.index]=!0}},this.opacity.index=e}get effect_matrix(){let e=this.position.vec.clone();return e.setY(e.y+.05),ve.setPosition(e),ve}AnimationEnd(){this.position.x=0,this.position.y=-2,this.position.z=20,we.instance.ReturnParticle(this.index)}setPosition(e){this.position.x=e.x,this.position.y=e.y,this.position.z=e.z}initialMove(e,t,i){let s,o=b.default.timeline();return this.setPosition(e),s=1==i?this.position.y+1:t.y+1,o.to(this.opacity,{duration:.6,ease:"none",effect:1}),o.to(this.position,{duration:.6,ease:"none",y:s},"<"),1==i?o.to(this.position,{duration:.55,ease:"none",x:t.x,y:t.y,z:t.z}):o.from(this.position,{duration:.55,ease:"none",x:t.x,y:s,z:t.z}),o.addLabel("lightoff",">"),o.to(this.opacity,{duration:.4,ease:"none",effect:0,onComplete:()=>{this.AnimationEnd()}}),o}Spend(e){let t=b.default.timeline();return this.setPosition(e),t.to(this.opacity,{duration:.5,ease:"none",effect:1}),t.addLabel("lightoff",">"),t.to(this.opacity,{delay:.5,duration:.5,ease:"none",effect:0,onComplete:()=>{this.AnimationEnd()}}),t}slideMove(e,t){let i=b.default.timeline();return this.setPosition(e),i.to(this.opacity,{delay:.2,duration:.4,ease:"none",effect:1}),i.addLabel("lighton","<"),i.to(this.position,{delay:.15,duration:.4,ease:"none",x:t.x,y:t.y,z:t.z}),i.to(this.opacity,{delay:.15,duration:.4,effect:0,ease:"none",onComplete:()=>{this.AnimationEnd()}}),i}}const ke=50;let Me=new y.Matrix4;new y.Color;const Se=new y.Vector3(0,-2,15);function Te(e,t){const i={top:-1,bottom:1}[`${e}`],s=new y.Vector3(4*i,0,4*i);let o=new y.Vector3(0,0,0),r=t,a=1.3,n=s;return i<0&&(n.z+=i*a*.5,n.x+=i*a*4),o.z=a*Math.floor(r/25)+n.z,r=Math.floor(r%25),o.x=a*Math.floor(r/5)+n.x,o.y=.2+.3*Math.floor(r%5)+n.y,o}class De{constructor(e){this.experience=new Nt,this.world=this.experience.world,this.scene=this.experience.scene,this.resources=this.experience.resources,this.geometryManager=this.experience.geometry,this.materialManager=this.experience.material,this.debug=this.experience.debug,this.user=null,this.Initialize(e)}get instance(){return this.mesh}get id(){return this.instance.id}Initialize(e){this.user=e>0?"bottom":"top";let t=new Float32Array(ke),i=new Float32Array(ke),s=new Float32Array(100);Array.from(Array(ke).keys()).reverse(),this.index_queue=0,this.token_infos=[];for(let e=0;e<ke;e++)t[e]=0,i[e]=0,s[2*e]=Math.random(),s[2*e+2]=Math.random(),this.token_infos.push(new Ae(this.user,e,(()=>{this.DisplaySync(e)})));this.geometry=this.geometryManager.items.token.clone(),this.geometry.setAttribute("alpha",new y.InstancedBufferAttribute(t,1,!0,1)),this.geometry.setAttribute("time",new y.InstancedBufferAttribute(i,1,!0,1)),this.geometry.setAttribute("offset",new y.InstancedBufferAttribute(s,2,!0,1)),this.material_front=this.experience.material.referenceMaterial("token_material"),this.material_side=this.experience.material.referenceMaterial("token_material_side"),this.material_front.opacity=1,this.material_side.opacity=1,this.materials=[this.material_side,this.material_side,this.material_front,this.material_side,this.material_side,this.material_side],this.mesh=new y.InstancedMesh(this.geometry,this.materials,ke),this.mesh.castShadow=!0;let o=new y.Color("#ffffff");for(let e=0;e<50;e++)Me.setPosition(Se),this.mesh.setMatrixAt(e,Me),this.mesh.setColorAt(e,o);this.mesh.instanceMatrix.needsUpdate=!0,this.scene.add(this.mesh),this.experience.world.Add_AnimationObject(this.mesh.id,this)}GameOver(){this.Clear()}Clear(){this.token_infos.forEach(((e,t)=>{this.Hide(t)})),this.index_queue=0}NewToken(e){let t=this.GetToken();return t.Set_Begin_Position_Effect(e),t.Initialize(),t}GetToken(){let e=this.Active();return this.token_infos[e]}ReturnToken(){this.Inactive()}Active(){let e=this.index_queue;return this.index_queue++,e}Inactive(){this.index_queue--}Show(e){let t=Te(this.user,e),i=this.token_infos[e];i.position.x=t.x,i.position.y=t.y,i.position.z=t.z,i.opacity.color=1,i.time.value=0}Hide(e){let t=new y.Vector3(0,-3,15);Me.setPosition(t);let i=this.token_infos[e];i.position.x=0,i.position.y=-3,i.position.z=15,i.opacity.color=0,i.time.value=0}DisplaySync(e){e<this.index_queue?this.Show(e):this.Hide(e)}SetMatrixAt(e,t){this.mesh.setMatrixAt(e,t),this.mesh.instanceMatrix.needsUpdate=!0}SetOpacityAt_Color(e,t){this.mesh.geometry.attributes.alpha.array[e]=t,this.mesh.geometry.attributes.alpha.needsUpdate=!0}SetOpacityAt_Time(e,t){this.mesh.geometry.attributes.time.array[e]=t,this.mesh.geometry.attributes.time.needsUpdate=!0}Update(){for(let e=0;e<ke;e++){let t=e,i=this.token_infos[t],s=null,o=null;if(1==Ae.needsUpdate[`${this.user}`][t]){let e=i.matrix;this.SetMatrixAt(t,e),Ae.needsUpdate[`${this.user}`][t]=!1}1==Ae.needsColorUpdate[`${this.user}`][t]&&(s=i.opacity.color,this.SetOpacityAt_Color(t,s),Ae.needsColorUpdate[`${this.user}`][t]=!1),1==Ae.needsTimeUpdate[`${this.user}`][t]&&(o=i.time.value,this.SetOpacityAt_Time(t,o),Ae.needsTimeUpdate[`${this.user}`][t]=!1)}}}class Ae{static needsUpdate={bottom:new Array(ke).fill(!1),top:new Array(ke).fill(!1)};static needsColorUpdate={bottom:new Array(ke).fill(!1),top:new Array(ke).fill(!1)};static needsTimeUpdate={bottom:new Array(ke).fill(!1),top:new Array(ke).fill(!1)};constructor(e,t,i){this.user=e,this.index=t,this.DisplaySync=i,this.effect_begin_position=new y.Vector3,this.origin_position=Te(this.user,this.index),this.owner=null,this.filter={color:!1},this.position={vec:new y.Vector3(0,5,0),get x(){return this.vec.x},get y(){return this.vec.y},get z(){return this.vec.z},set x(e){this.vec.setX(e),Ae.needsUpdate[`${this.user}`][this.index]=!0},set y(e){this.vec.setY(e),Ae.needsUpdate[`${this.user}`][this.index]=!0},set z(e){this.vec.setZ(e),Ae.needsUpdate[`${this.user}`][this.index]=!0}},this.position.index=t,this.position.user=e,this.opacity={color_:0,get color(){return this.color_},set color(e){this.color_=e,Ae.needsColorUpdate[`${this.user}`][this.index]=!0}},this.opacity.index=t,this.opacity.user=e,this.time={value_:0,set value(e){this.value_=e,Ae.needsTimeUpdate[`${this.user}`][this.index]=!0},get value(){return this.value_}},this.time.index=t,this.time.user=e,this.animation_cnt=0}get matrix(){return Me.setPosition(this.position.vec),Me}Initialize(){this.time.value=0}Set_Begin_Position_Effect(e){this.effect_begin_position.copy(e)}SetOpacity_Hide(){this.opacity.color=0}SetOpacity_Origin(){this.opacity.color=1}SetPosition_Hide(){this.position.x=0,this.position.y=-3,this.position.z=15}SetPosition_Origin(){this.position.x=this.origin_position.x,this.position.y=this.origin_position.y,this.position.z=this.origin_position.z}AnimationEnd(){this.animation_cnt--,0==this.animation_cnt&&this.DisplaySync()}Disappear(){this.animation_cnt++,this.SetPosition_Origin(),this.SetOpacity_Origin(),b.default.timeline().to(this.opacity,{ease:"none",color:0,duration:.5,onComplete:()=>{this.AnimationEnd()}})}Appear(){this.animation_cnt++;let e=b.default.timeline();return this.SetOpacity_Hide(),e.to(this.opacity,{delay:.15,duration:.4,color:1,ease:"none",onStart:()=>{this.SetPosition_Origin()},onComplete:()=>{this.AnimationEnd()}}),e}initialMove(e,t=!0){this.animation_cnt++,this.SetOpacity_Hide(),e=this.GetPosition();let i=this.effect_begin_position,s=we.instance.initialMove(i,e,t);return s.to(this.opacity,{duration:.4,ease:"none",color:1,onStart:()=>{this.SetPosition_Origin()},onComplete:()=>{this.AnimationEnd()}},"lightoff"),s}slideMove(e){this.animation_cnt++;let t=this.GetPosition();this.SetPosition_Origin(),this.SetOpacity_Origin();let i=we.instance.slideMove(t,e);return i.to(this.opacity,{duration:.4,ease:"none",color:0,onStart:()=>{this.SetPosition_Origin()},onComplete:()=>{this.AnimationEnd()}},"lighton"),i}GetPosition(){return this.origin_position}Spend(){this.animation_cnt++;let e=this.origin_position,t=we.instance.Spend(e);return t.to(this.opacity,{duration:.5,ease:"none",color:0,onComplete:()=>{this.AnimationEnd()}},"lightoff"),t}destroy(){}}class Ce{constructor(e){this.experience=new Nt,this.scene=this.experience.scene,this.debug=this.experience.debug,this.token_pool=new De(e),this.dices=[],this.diceDictionary={},this.token_dices=[],this.tokenDiceDictionary={},this.godFavors=[],this.godFavorDictionary={},this.healthStones=[],this.healthStoneDictionary={},this.health=15,this.health_anim_index,this.tokens=[],this.tray=new y.Vector3,this.bowl,this.frostbite=0,this.chosenDicesSite=[],this.chosenDicesSite_token=[],this.waitingDicesSite=[],this.actionEndDicesSite=[],this.diceChosenIndex=[],this.diceChosenIndex_token=[],this.sortedDiceForBattle=[],this.diceStartAnchor=new y.Vector3(0,5,12.5*e),this.diceChosenAnchor=new y.Vector3(4,.5,2*e),this.diceWaitingAnchor=new y.Vector3(-9,.5,2*e),this.actionEndAnchor=new y.Vector3(4*e,.5,9.75*e),this.tokenStackAnchor=new y.Vector3(4*e,0,4*e),this.godFavorAnchor=new y.Vector3(4.5*e,.1,7.375*e),this.healthStoneAnchor=new y.Vector3(-3.9*e,.25,6*e),this.coinAnchor=new y.Vector3(-13,.075,6*e),this.anchorSign=e,this.doubleCubeAnchor=new y.Vector3(-12,-50,5*e),this.eventEmitter,this.index,this.tokens_need_init=[],this.tokens_need_destroy=[]}get max_hp(){return 15-this.frostbite}InitialGame(e){this.ResetRound(),this.tokens=[],this.token_pool.Clear(),this.healthStones.forEach((e=>{let t=e.GetPosition().clone();t.y=this.healthStoneAnchor.y,e.SetPosition(t),e.eventEmitter=this.eventEmitter,e.avatarIndex=this.index,e.InitialGame()})),this.health=15,this.health_anim_index=15;let t=this.health-e.health;for(let e=0;e<t;e++)this.GetTargetHealthStone(null);let i=e.token;for(let e=0;e<i;e++)this.CreateNewToken(this.GetNextTokenPosition());this.godFavors.forEach((e=>{e.moveTo(new y.Vector3(0,0,-20))})),this.godFavors.length=0,this.dices.forEach((e=>e.InitialGame()))}GameOver(){this.ResetRound(),this.token_pool.GameOver(),this.tokens=[],this.healthStones.forEach((e=>{let t=e.GetPosition().clone();t.y=this.healthStoneAnchor.y,e.SetPosition(t),e.eventEmitter=this.eventEmitter,e.avatarIndex=this.index,e.InitialGame()})),this.health=15,this.frostbite=0,this.dices.forEach(((e,t)=>{this.DiceToActionEnd(e,t),e.GameOver()})),this.godFavors.forEach((e=>{e.GameOver()})),this.bowl.Reset_Position()}OrganizeTable(){let e=this.tray.clone();e.z+=7*this.anchorSign,this.bowl.Move(e),this.healthStones.forEach((e=>{e.mesh.position.y=-5})),this.dices.forEach((e=>{e.Organize(this.anchorSign)}))}SetupTable(){let e=this.tray.clone();this.bowl.Move(e),this.healthStones.forEach((e=>{e.mesh.position.y=this.healthStoneAnchor.y})),this.dices.forEach((e=>{e.Setup(this.anchorSign)}))}GetDicesIndexsOnCondition(e){let t=[];return this.dices.forEach(((i,s)=>{e(i)&&"ban"!=i.state&&t.push(s)})),t}GetDiceMarks(){let e=[];return this.sortedDiceForBattle.forEach((t=>{"ban"!==t.state&&e.push(...t.getMarks())})),e}GetDiceMark_Single(){}GetSortedDiceForBattle(){return this.sortedDiceForBattle}ResetRound(){this.chosenDicesSite=[],this.chosenDicesSite_token=[],this.waitingDicesSite=[],this.actionEndDicesSite=[],this.diceChosenIndex=[],this.diceChosenIndex_token=[],this.health_anim_index=this.health,this.dices.forEach((e=>{e.ResetRound()})),this.token_dices.forEach((e=>{e.ResetRound()}))}DiceToActionEnd(e,t){let i=this.actionEndAnchor.clone();return i.x+=t*this.anchorSign*1.3,e.DiceToActionEnd(i)}DicesToWaiting(e,t){let i=[];e.forEach((e=>{i.push({index:e,x:this.dices[e].getPosition().x})})),i.sort(((e,t)=>e.x-t.x)),i.forEach(((t,i)=>{e[i]=t.index}));let s=new y.Vector3;s.copy(this.diceWaitingAnchor),s.x+=1.3*this.waitingDicesSite.length;let o=[];return e.forEach((e=>{let t=this.dices[e].DiceToWaiting(s);o.push(t),this.waitingDicesSite.push(this.dices[e]),s.x+=1.3})),this.chosenDicesSite=[],this.chosenDicesSite_token=[],o}Withdraw(){this.dices.forEach((e=>{e.Withdraw(this.diceStartAnchor)}))}RollDices(e,t,i){let s=0,o=[];return this.dices.forEach(((i,r)=>{if(null!=e[r]){let i=this.dices[r].Roll(e[r],t[s],this.diceStartAnchor);o.push(i),s++}})),o}PhysicsRollDices(){this.dices.forEach((e=>{e.PhysicsRoll()}))}checkSelectedObject(e){if(e.getID()in this.diceDictionary)return{type:"dice",index:this.diceDictionary[e.getID()].index};if(e.getID()in this.tokenDiceDictionary)return{type:"tokendice",index:this.tokenDiceDictionary[e.getID()].index};if(e.getID()in this.godFavorDictionary){let t=this.godFavorDictionary[e.getID()];return{type:"godfavor",index:t.index,info:t.obj.info}}return e.getID()in this.healthStoneDictionary?{type:"healthstone",index:this.healthStoneDictionary[e.getID()].index}:void 0}FindFromDictionary(e){return e in this.diceDictionary?this.diceDictionary[e].obj:e in this.godFavorDictionary?this.godFavorDictionary[e].obj:e in this.healthStoneDictionary?this.healthStoneDictionary[e].obj:null}PhaseStart(e){switch(e){case"godfavor":this.dices.forEach((e=>{e.TokenMark_Hightlight_On()}));break;case"resolution":this.dices.forEach((e=>{e.TokenMark_Hightlight_Off()}))}}SetDiceFormation(e,t){this.sortedDiceForBattle=[];let i=e.weapons,s=this.diceWaitingAnchor.clone();"modern"===t?(this.token_dices.forEach(((e,t)=>{e.MoveToAction(s.clone(),t),s.x+=1.3})),s.x+=.5):s.x=this.diceWaitingAnchor.x+1;let o=0,r=s.x,a=[];for(let t=0;t<6;t++){let n=i[t];this.dices.forEach(((e,t)=>{if("ban"!==e.state&&e.getWeapon()==n){this.sortedDiceForBattle.push(e);let t=e.MoveToAction(s.clone(),o);a.push(t),s.x+=1.3,o++,e.state="waiting"}})),r+=1.3*e[`${t}`]+.5,s.x=r}return a}ChooseDice(e,t){let i;for(i=0;i<6&&null!=this.chosenDicesSite[i];i++);let s=new y.Vector3;switch(t){case"roll":s.copy(this.diceChosenAnchor),s.x+=1.3*i,this.chosenDicesSite[i]=this.dices[e],this.diceChosenIndex[e]=i;break;case"godfavor":s.copy(this.dices[e].getPosition()),s.y+=3}return this.dices[e].ChooseDice(s,t)}CancleDice(e,t){let i=this.dices[e].CancleDice(t);return this.chosenDicesSite[this.diceChosenIndex[e]]=null,this.diceChosenIndex[e]=-1,i}ClickDice(e,t){let i=this.dices[e].GetDiceState();return"tray"===i||"waiting"===i?this.ChooseDice(e,t):"chosen"===i||"levitation"===i?this.CancleDice(e,t):void 0}ChooseDice_Token(e){let t;for(t=0;t<2&&null!=this.chosenDicesSite_token[t];t++);let i=new y.Vector3;return i.copy(this.diceChosenAnchor),i.z-=1.95,i.x+=1.3*t,this.chosenDicesSite_token[t]=this.token_dices[e],this.diceChosenIndex_token[e]=t,console.log(e,i),this.token_dices[e].ChooseDice(i,"roll")}CancleDice_Token(e){let t=this.token_dices[e].CancleDice("roll");return this.chosenDicesSite_token[this.diceChosenIndex_token[e]]=null,this.diceChosenIndex_token[e]=-1,t}ClickDice_Token(e){let t=this.token_dices[e].GetDiceState();return"tray"===t?this.ChooseDice_Token(e):"chosen"===t?this.CancleDice_Token(e):void 0}GetDiceState(e){return this.dices[e].GetDiceState()}GodFavorPower(e,t){this.godFavors[e].Power(t)}Get_FireWorks_Position(){let e=this.healthStoneAnchor.clone();return e.setX(e.x+-2.25*this.anchorSign),e.setY(3.5),e}Get_HealthStone_Area_Center(){return this.healthStones[7].GetPosition().clone()}AddOtherToken(e){let t=this.token_pool.NewToken(this.GetNextTokenPosition());return this.tokens.push(t),t}Check_Token_FreeSpace(){return this.tokens.length<50}GetToken(e){let t=[];return e.forEach((e=>{let i=this.dices[e].getPosition(),s=this.CreateNewToken(i);t.push(s)})),t}GetToken_Modern(e){let t=[];return e.forEach(((e,i)=>{let s=this.token_dices[i].getPosition().clone();for(let i=0;i<e;i++){let e=this.CreateNewToken(s);t.push(e),s.y+=.2}})),Promise.all(t).then((()=>{this.DiceToActionEnd(this.token_dices[0],6),this.DiceToActionEnd(this.token_dices[1],7)}))}SpendToken(e){let t=[];this.eventEmitter&&this.eventEmitter.trigger(`${this.index}-use-token`,[e]);for(let i=0;i<e;i++){if(0==this.tokens.length)return;t.push(this.tokens.pop().Spend()),this.token_pool.ReturnToken(),this.eventEmitter&&this.eventEmitter.trigger(`${this.index}-use-token-anim`,[this.GetNextTokenPosition()])}return Promise.all(t)}CreateNewToken(e){if(this.tokens.length>=50)return null;let t=this.token_pool.NewToken(e),i=this.GetNextTokenPosition(),s=t.initialMove(i);return this.tokens.push(t),s}Token_Destroy_Immediately(e){let t=0;for(let i=0;i<e;i++){if(0==this.tokens.length)return;this.tokens_need_destroy.unshift(this.tokens.pop()),this.token_pool.ReturnToken(),t++}return t}Token_Destroy_Animation(){let e=this.tokens_need_destroy.pop();null!=e&&(e.Spend(),this.Token_Destroy_Animation())}Token_Create_Immediately(){if(this.tokens.length>=50)return;let e=this.GetNextTokenPosition(),t=this.token_pool.NewToken(e);this.tokens.push(t),this.tokens_need_init.unshift(t)}Token_Initial_Animation(e){let t=this.tokens_need_init.pop();void 0!==t&&(t.Set_Begin_Position_Effect(e),t.initialMove(e,!0))}GetNextTokenPosition(){let e=new y.Vector3(0,0,0),t=this.tokens.length,i=1.3,s=this.tokenStackAnchor.clone();return this.anchorSign<0&&(s.z+=this.anchorSign*i*.5,s.x+=this.anchorSign*i*4),e.z=i*Math.floor(t/25)+s.z,t=Math.floor(t%25),e.x=i*Math.floor(t/5)+s.x,e.y=.2+.3*Math.floor(t%5)+s.y,e}GetHealth(){return this.health}GetTokenLength(){return this.tokens.length}Get_Tokens_Area_Position(){let e=this.tokenStackAnchor.clone(),t=e.clone();return t.setX(t.x+1.3*this.anchorSign*4),[e,t]}Get_Need_Heal_Positions(e){let t=[];for(let i=0;i<e;i++){let e=this.health_anim_index+i;if(e>=this.max_hp)break;t.push(this.healthStones[e].GetPosition().clone())}return t}Get_Damage_Stones_Positions(e){let t=[];for(let i=0;i<e;i++){let e=this.health_anim_index-1-i;if(e<0)break;t.push(this.healthStones[e].GetPosition().clone())}return t}DamageAnim(){this.experience.sound.Play_StoneShed(),this.health_anim_index--}GetLastHealthStone(){return this.health>0?this.healthStones[this.health-1]:null}GetTargetHealthStone(e=null,t=!1){let i=null;if(this.health>0){let s=this.healthStones[--this.health].GetPosition().clone();this.eventEmitter&&this.eventEmitter.trigger(`${this.index}-damage-${e}`,[s]),t||this.healthStones[this.health].Damaged(),i=s}return this.health<=0&&this.experience.controller.FinishGame(this.index),i}GetDices_Top_Position_By_Indexes(e){let t=this.GetDicesPosition_By_Indexes(e);return t.forEach((e=>{e.setComponent(1,1)})),t}GetDicesPosition_By_Indexes(e){let t=[];return e.forEach((e=>{let i=this.dices[e].getPosition().clone();t.push(i)})),t}Take_FrostBite(e){let t=14-this.frostbite;this.frostbite+=e;let i=[],s=[];for(;!(t<0||0==e);)s.push(this.healthStones[t].GetPosition()),console.log(t,this.health-1),t==this.health-1&&(i.push(this.GetLastHealthStone()),this.GetTargetHealthStone(null,!0)),e--,t--;return[s,i]}ConvertDiceMark(e,t,i,s,o){let r=[],a=[];return i.forEach(((i,n)=>{let h=this.dices[i],l=s[n],c=h.ConvertDiceMark(l,e,t,o);r.push(c[0]),a.push(c[1])})),[r,a]}DecreaseDiceMark(e,t,i){let s=[],o=[];return t.forEach(((t,r)=>{let a=this.dices[t],n=i[r],h=a.DecreaseDiceMark(n,e);s.push(h[0]),o.push(h[1])})),[s,o]}Highlighting_Marks(e,t,i){let s=[];return t.forEach(((t,o)=>{let r=this.dices[t];s.push(r.Highlighting_Mark(e,i))})),Promise.all(s)}HealthStones_Change_Color(e){this.healthStones.forEach((t=>{t.ChangeMaterialColor(e)}))}HealthStones_Reset_Color(){this.healthStones.forEach((e=>{e.ResetMaterialColor()}))}HealthStones_ShineOn(){console.log("Bloom Effect On"),this.healthStones.forEach((e=>{e.Shine_On()}))}HealthStones_ShineOff(){this.healthStones.forEach((e=>{e.Shine_Off()}))}HealthStonesInteractOn(){let e=[];this.healthStones.forEach((t=>{"fine"===t.state&&e.push(t)})),this.experience.world.TurnOnInteract(e)}HealthStonesInteractOff(){this.experience.world.TurnOffInteract(this.healthStones)}Heal(){this.health<this.max_hp&&this.health++}HealAnimation(e=null){let t;return this.health_anim_index<this.max_hp&&(this.healthStones[this.health_anim_index].Recovery(e),t=this.healthStones[this.health_anim_index].Blink(),this.health_anim_index++),t}async HealingBall_Animation(e,t=null){if(this.health_anim_index<this.max_hp){let i=this.health_anim_index;this.health_anim_index++;let s=this.healthStones[i].GetPosition().clone(),o=new se;await o.Move(e,s,.7),this.healthStones[i].Recovery(t),await this.healthStones[i].Blink()}}BanDices(e){let t=[];return e.forEach((e=>{let i=this.DiceToActionEnd(this.dices[e],25);t.push(i),this.dices[e].state="ban"})),Promise.all(t)}GetTargetToken(){if(this.tokens.length>0){let e=this.tokens.pop();return this.token_pool.ReturnToken(),e}return null}AddDices(e){this.dices.push(...e),e.forEach(((e,t)=>{this.diceDictionary[`${e.getID()}`]={obj:e,index:6+t},e.setDiceMaterialColor(new y.Color(16744680)),e.isDisappeared=!1,e.DiceToActionEnd=function(){return this.Disappear(),null}}))}ReduceDices(e){for(let t=0;t<e;t++){let e=this.dices.pop();0==e.isDisappeared&&e.Disappear();let t=e.getID();delete this.diceDictionary[`${t}`],this.experience.world.RemoveDice(e)}}GetAvatarInfo(){let e=[];this.dices.forEach((t=>{e.push(t.GetDiceState())}));let t=[];return this.token_dices.forEach((e=>{t.push(e.GetDiceState())})),{health:this.health,token:this.tokens.length,dicesState:e,dicesState_token:t}}ForceSync(e){let t=e.health-this.GetHealth();if(t>0)for(let e=0;e<t;e++)this.Heal(),this.HealAnimation();else if(t<0){t*=-1;for(let e=0;e<t;e++)this.GetTargetHealthStone("none")}let i=e.token-this.tokens.length;if(i>0)for(let e=0;e<i;e++)this.CreateNewToken(this.GetNextTokenPosition());else i<0&&this.SpendToken(-1*i)}_DBG_SetDiceFaceColor(e){this.dices[e]._DBG_setFaceColor()}_DBG_ResetDiceFaceColor(e){this.dices[e]._DBG_resetFaceColor()}SetDiceMaterialColor(e,t){let i=new y.Color;i.setHSL(t[0],t[1],t[2]),this.dices[e].setDiceMaterialColor(i)}ResetDiceMaterialColor(e){this.dices[e].resetDiceMaterialColor()}setDebug(){}PrintAnchors(){let e=[this.diceStartAnchor,this.diceChosenAnchor,this.diceWaitingAnchor,this.actionEndAnchor,this.tokenStackAnchor,this.godFavorAnchor,this.healthStoneAnchor,this.coinAnchor,this.doubleCubeAnchor],t=new y.BoxGeometry(1,1,1);e.forEach(((i,s)=>{let o=new y.MeshBasicMaterial({transparent:!0,opacity:.5});o.color.setHSL(s/e.length,1,.5),console.log(s/e.length);let r=new y.Mesh(t,o);r.position.copy(i),this.scene.add(r)}))}}class Pe{constructor(e=new y.Vector3(0,0,0)){this.experience=new Nt,this.resources=this.experience.resources,this.debug=this.experience.debug,this.scene=this.experience.scene,this.material_manager=this.experience.material,this.state="tray",this.Initialize(e)}Initialize(e){this.material=this.material_manager.getMaterial("banSign").clone(),this.geometry=new y.PlaneGeometry(1.5,1.5),this.mesh=new y.Mesh(this.geometry,this.material),this.mesh.rotateX(-Math.PI/2),this.mesh.position.copy(e),this.scene.add(this.mesh)}Destroy(){b.default.to(this.material,{duration:.5,opacity:0,onComplete:()=>{this.material.dispose(),this.scene.remove(this.mesh)}})}}class Fe{constructor(){this.experience=new Nt,this.resources=this.experience.resources,this.debug=this.experience.debug,this.scene=this.experience.scene,this.banSigns=[],this.prepare_rotation,this.state="tray",this.org_position=new y.Vector3(5,3,-12),this.Initialize()}Initialize(){this.mesh=this.resources.items.stampModel.scenes[0].children[0],this.scene.add(this.mesh),this.mesh.rotateX(-Math.PI/6),this.mesh.castShadow=!0,this.prepare_rotation=this.mesh.rotation.clone(),this.mesh.position.y+=1,this.mesh.position.z-=1}Stamp(e){e.y=0,this.mesh.setRotationFromEuler(this.prepare_rotation);let t=b.default.timeline();return t.to(this.mesh.position,{duration:.4,x:e.x,y:e.y+2,z:e.z-1.5,ease:"Power3.easeOut"}).to(this.mesh.position,{delay:.1,duration:.3,z:e.z-1.9,ease:"Power2.easeOut"}).to(this.mesh.rotation,{duration:.3,x:Math.PI/2-Math.PI/5,ease:"Power2.easeOut"},"<").to(this.mesh.rotation,{delay:.1,duration:.1,x:Math.PI/2}).to(this.mesh.position,{duration:.1,y:.5,ease:"Sine.easeIn"},"<").to(this.mesh.position,{duration:.1,z:e.z,ease:"Sine.easeOut",onComplete:()=>{this.CreateBanSign(e.clone())}},"<").to(this.mesh.position,{delay:.15,duration:.3,y:3,ease:"Power1.easeIn"}).to(this.mesh.position,{duration:.5,x:this.org_position.x,z:this.org_position.z}),t}CreateBanSign(e){e.y+=.7;let t=new Pe(e);this.banSigns.push(t)}PositionToOrigin(){this.mesh.position.copy(this.org_position)}ClearBanSign(){this.banSigns.forEach((e=>{e.Destroy()}))}}const Ge=(e=>{var t={};return x.d(t,e),t})({TextGeometry:()=>a.TextGeometry});class Oe{constructor(){this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.owner=null,this.doubling_index=0,this.proposed_cnt=0,this.anchor=new y.Vector3(-12,-50,0),this.anchor_setup=this.anchor.clone(),this.anchor_setup.x-=3.5,this.Initialize(),this.rotations=[new y.Quaternion(0,0,0,1),new y.Quaternion(-.707,0,0,.707),new y.Quaternion(0,0,.707,.707),new y.Quaternion(0,0,-.707,.707),new y.Quaternion(1,0,0,0)]}GetInstance(){return this.instance}MoveTo(e){b.gsap.to(this.instance.position,{duration:.15,ease:"none",x:e.x})}Setup(){this.MoveTo(this.anchor_setup)}Organize(){this.MoveTo(this.anchor)}GameOver(){this.owner=null,this.doubling_index=0,this.proposed_cnt=0;let e=this.anchor,t=this.rotations[0];this.Animation_Transform(e,t);let i=this.rotations.length;for(let e=0;e<i;e++)this.text_mesh[e].layers.disable(1),this.text_mesh[e].material.color.setRGB(.15,.15,.15);this.text_mesh[0].material.color.setRGB(1,1,1)}getID(){return this.instance.id}CreateTextGeometry(e){let t=this.resources.items.font_tektur;const i=new Ge.TextGeometry(e,{font:t,size:1.25,height:.05,curveSegments:1,bevelEnabled:!1});let s=i.attributes.position.array,o=i.attributes.uv.array,r=2e8,a=-2e8,n=2e8,h=-2e8,l=2e8,c=-2e8,d=0;for(let e=0;e<s.length;e+=3,d+=2)r=Math.min(r,s[e]),a=Math.max(a,s[e]),n=Math.min(n,s[e+1]),h=Math.max(h,s[e+1]),l=Math.min(l,s[e+2]),c=Math.max(c,s[e+2]),o[d]=s[e],o[d+1]=s[e+1];let u=(a-r)/2,m=(h-n)/2,p=(c-l)/2;d=0;for(let e=0;e<s.length;e+=3,d+=2)s[e]-=u,s[e+1]-=m,s[e+2]-=p,s[e]*=1.25,o[d]/=a,o[d+1]/=h;return i}Hover_On(){}Hover_Off(){}DoubleGame(e,t){this.proposed_cnt++,this.text_mesh[t-1].material.color.setRGB(.15,.15,.15),this.text_mesh[t-1].layers.disable(1),1==this.proposed_cnt?this.text_mesh[t].material.color.setRGB(1,1,1):2==this.proposed_cnt&&this.text_mesh[t].material.color.setRGB(1,.05,.05),this.text_mesh[t].layers.enable(1),this.owner=e,this.doubling_index=t;let i=this.experience.controller.avatars[`${e}`].doubleCubeAnchor;t==this.rotations.length-1&&(i=i.clone(),i.z=0);let s=this.rotations[t];this.Animation_Transform(i,s)}StartResolutionPhase(){this.text_mesh[this.doubling_index].layers.disable(1),this.text_mesh[this.doubling_index].material.color.setRGB(1,1,1)}Move_To_Anchor(){}ResetRound(){this.proposed_cnt=0}Animation_Transform(e,t){let i=this.GetInstance(),s=b.gsap.to(i.position,{duration:.4,ease:"none",x:e.x,z:e.z});b.gsap.timeline().to(i.position,{duration:.2,ease:"sine.out",y:3.5}).to(i.position,{duration:.2,ease:"sine.in",y:e.y}),s.eventCallback("onUpdate",(()=>i.quaternion.slerp(t,s.time()/.4))),s.eventCallback("onComplete",(()=>i.quaternion.copy(t)))}Initialize(){let e=new y.BoxGeometry(2,2,2,32,32,32),t=2/3*2,i=e.attributes.position.array,s=e.attributes.normal.array;for(let e=0;e<i.length;e+=3){let o=new y.Vector3;o.set(i[e],i[e+1],i[e+2]),o.distanceToSquared(this.scene.position)>1.7777777777777777&&(o.normalize(),i[e]=o.x*t,i[e+1]=o.y*t,i[e+2]=o.z*t,s[e]=o.x,s[e+1]=o.y,s[e+2]=o.z)}e.computeVertexNormals();let o=this.resources.items.doublecube_map;o.encoding=y.sRGBEncoding;let r=new y.MeshStandardMaterial({envMapIntensity:2.5,map:o,metalness:.4,roughness:.6});this.instance=new y.Mesh(e,r),this.instance.position.copy(this.anchor),this.scene.add(this.instance),this.instance.castShadow=!0;let a=this.resources.items.doublecube_number_map;a.encoding=y.sRGBEncoding;let n=new y.MeshStandardMaterial({map:a}),h=[this.CreateTextGeometry("1"),this.CreateTextGeometry("2"),this.CreateTextGeometry("4"),this.CreateTextGeometry("6"),this.CreateTextGeometry("8"),this.CreateTextGeometry("X")];this.text_mesh=[new y.Mesh(h[0],n.clone()),new y.Mesh(h[1],n.clone()),new y.Mesh(h[2],n.clone()),new y.Mesh(h[3],n.clone()),new y.Mesh(h[4],n.clone()),new y.Mesh(h[5],n.clone())],this.text_mesh[0].position.set(0,1,0),this.text_mesh[0].rotateX(-Math.PI/2),this.scene.add(this.text_mesh[0]),this.text_mesh[1].position.set(0,0,1),this.scene.add(this.text_mesh[1]),this.text_mesh[2].position.set(1,0,0),this.text_mesh[2].rotateX(-Math.PI/2),this.text_mesh[2].rotateY(Math.PI/2),this.scene.add(this.text_mesh[2]),this.text_mesh[3].position.set(-1,0,0),this.text_mesh[3].rotateX(-Math.PI/2),this.text_mesh[3].rotateY(-Math.PI/2),this.scene.add(this.text_mesh[3]),this.text_mesh[4].position.set(0,-1,0),this.text_mesh[4].rotateX(Math.PI/2),this.scene.add(this.text_mesh[4]),this.text_mesh[5].position.set(0,0,-1),this.text_mesh[5].rotateX(Math.PI),this.scene.add(this.text_mesh[5]),this.text_mesh.forEach((e=>{e.material.color.setRGB(.15,.15,.15),this.instance.add(e)})),this.text_mesh[0].material.color.setRGB(1,1,1)}}class Be{constructor(){this.experience=new Nt,this.resources=this.experience.resources,this.debug=this.experience.debug,this.scene=this.experience.scene,this.material_manager=this.experience.material,this.canvas=document.createElement("canvas"),this.canvas.width=480,this.canvas.height=270,this.ctx=this.canvas.getContext("2d"),this.mode_=null,this.view_=null,this.user_="bottom",this.anchor=new y.Vector3(12.5,0,0),this.anchor_setup=this.anchor.clone(),this.anchor_setup.x-=2,this.dbg_view=!0,this.Initialize(this.canvas),this.setDebug()}Initialize(e){this.instance=this.resources.items.ChessClock.scene,this.body_=this.instance.children[0],this.screen_=this.instance.children[1],this.switch_toggle=this.instance.children[2],this.loop_A=this.instance.children[3],this.loop_B=this.instance.children[4],this.switch_button=this.instance.children[5],this.switch_button_red=this.switch_button.children[0];let t=new y.MeshStandardMaterial({color:"black",metalness:.4,roughness:.6,envMapIntensity:2.5});this.switch_toggle.material.dispose(),this.switch_toggle.material=t,this.toggle_txt=this.switch_toggle.children[0],this.toggle_highlight={bottom:this.switch_toggle.children[1],tom:this.switch_toggle.children[0]},this.toggle_highlight.bottom=this.switch_toggle.children[1],this.toggle_highlight.top=this.switch_toggle.children[2],this.toggle_highlight.top.material.dispose(),this.toggle_highlight.bottom.material.dispose(),this.toggle_color={top:{active:new y.Color("#1fffff"),inactive:new y.Color("#003f3f")},bottom:{active:new y.Color("#1fff11"),inactive:new y.Color("#003f04")}},this.switch_button.material.dispose(),this.switch_button.material=t,this.switch_button_red.material.dispose(),this.switch_button_red.material=new y.MeshStandardMaterial({color:"#ff0707",metalness:.05,roughness:.35,envMapIntensity:1.5,transparent:!0,opacity:.7,flatShading:!0}),this.switch_button_red.geometry.computeVertexNormals(),this.toggle_highlight.top.material=new y.MeshStandardMaterial({color:this.toggle_color.top.inactive}),this.toggle_highlight.bottom.material=new y.MeshStandardMaterial({color:this.toggle_color.bottom.inactive});let i=this.resources.items.wood08_map,s=this.resources.items.wood08_normal,o=this.resources.items.wood08_roughness;i.encoding=y.sRGBEncoding,s.encoding=y.sRGBEncoding,o.encoding=y.sRGBEncoding;let r=new y.MeshStandardMaterial({map:i,roughnessMap:o,metalness:.1,roughness:.9,envMapIntensity:2.5});this.body_.material.dispose(),this.loop_A.material.dispose(),this.loop_B.material.dispose(),this.body_.material=r,this.loop_A.material=r,this.loop_B.material=r,this.loop_A.scale.set(1,1,1),this.loop_B.scale.set(1,1,1),this.canvas_texture=new y.CanvasTexture(e),this.canvas_texture.encoding=y.sRGBEncoding;let a=new y.MeshBasicMaterial({map:this.canvas_texture});this.screen_.material.dispose(),this.screen_.material=a,this.scene.add(this.instance),this.switch_toggle.orgY=this.switch_toggle.position.y,this.switch_button.orgY=this.switch_button.position.y,this.instance.rotateY(-Math.PI/2),this.instance.position.copy(this.anchor),this.instance.children[0].castShadow=!0,this.ButtonMode()}SetUser(e){this.user=e}Highlight_On(){this.ToggleHighlight_Enable(this.user)}Highlight_Off(){this.ToggleHighlight_Disable(this.user)}async ModeSet_Toggle(){"toggle"!=this.mode_&&(this.mode_="toggle",await this.Open_Loop(.6),await this.Hide_Button(),await this.Close_Loop(),await this.Sleep(150),this.switch_button.visible=!1,this.switch_toggle.visible=!0,await this.Open_Loop(0),await this.Show_Toggle())}async ModeSet_Button(){"button"!=this.mode_&&(this.mode_="button",await this.Hide_Toggle(),await this.Close_Loop(),await this.Sleep(150),this.switch_toggle.visible=!1,this.switch_button.visible=!0,await this.Open_Loop(.6),await this.Show_Button(),await this.Close_Loop())}Sleep(e){return new Promise((t=>{setTimeout((()=>{t(!0)}),e)}))}Open_Loop(e){let t=b.default.timeline();return t.to(this.loop_A.scale,{duration:.2,x:e}),t.to(this.loop_B.scale,{duration:.2,x:e},"<"),t}Close_Loop(){let e=b.default.timeline();return e.to(this.loop_A.scale,{duration:.2,x:1}),e.to(this.loop_B.scale,{duration:.2,x:1},"<"),e}Hide_Toggle(){let e=b.default.timeline();return e.to(this.switch_toggle.position,{ease:"Power1.easeOut",duration:.35,y:this.switch_toggle.orgY-2}),e}Show_Toggle(){let e=b.default.timeline();return e.to(this.switch_toggle.position,{ease:"Power1.easeOut",duration:.35,y:this.switch_toggle.orgY}),e}Hide_Button(){let e=b.default.timeline();return e.to(this.switch_button.position,{ease:"Power1.easeOut",duration:.35,y:this.switch_button.orgY-2}),e}Show_Button(){let e=b.default.timeline();return e.to(this.switch_button.position,{ease:"Power1.easeOut",duration:.35,y:this.switch_button.orgY}),e}ToggleHighlight_Enable(e){this.toggle_highlight[`${e}`].layers.enable(1),this.toggle_highlight[`${e}`].material.color=this.toggle_color[`${e}`].active}ToggleHighlight_Disable(e){this.toggle_highlight[`${e}`].layers.disable(1),this.toggle_highlight[`${e}`].material.color=this.toggle_color[`${e}`].inactive}Highlight_Toggle(e){}Invert_Toggle(){if(null===this.user)return;let e="top"==this.user?"bottom":"top";this.Turn_Toggle(e)}Turn_Toggle(e){if(this.user===e)return;let t;this.SetUser(e),this.ToggleHighlight_Disable("top"),this.ToggleHighlight_Disable("bottom"),t="top"==e?-.1637119:"bottom"==e?.1637119:0,b.default.to(this.switch_toggle.rotation,{ease:"none",duration:.05,z:t})}FillText(e,t="#ffffff"){this.ctx.save();let i=e.toString();this.ctx.fillStyle="#060A0F",this.ctx.fillRect(120,0,240,270),this.ctx.font="11rem Tektur",this.ctx.textAlign="left",this.ctx.strokeStyle=t,this.ctx.fillStyle=t;let s=this.ctx.measureText(i).width,o=this.ctx.measureText(i).actualBoundingBoxAscent+this.ctx.measureText(i).actualBoundingBoxDescent,r=null;r="top"==this.view_?-Math.PI/2:3*-Math.PI/7,this.ctx.translate(this.canvas.width/2,this.canvas.height/2),this.ctx.rotate(r),this.ctx.fillText(i,-s/2,o/2),this.canvas_texture.needsUpdate=!0,this.ctx.restore()}DrawCircle(e,t,i,s,o){this.ctx.save(),this.ctx.lineWidth=i,this.ctx.strokeStyle=s,this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e,t,30,0,2*Math.PI),this.ctx.stroke(),this.ctx.fill(),this.ctx.closePath(),this.ctx.restore()}Light_Off_All(){["top","bottom"].forEach((e=>{for(let t=0;t<3;t++)this.Light(e,t,!1)}))}Light_On_All(){["top","bottom"].forEach((e=>{for(let t=0;t<3;t++)this.Light(e,t,!0)}))}Light(e,t,i){let s,o,r,a;"top"==e?(s="#00ffff",o=1==i?"#00ffff":"#004545",r=60):"bottom"==e&&(s="#00ff00",o=1==i?"#00ff00":"#004500",r=420),a=50+85*t,this.DrawCircle(r,a,10,s,o)}DisplayNumber(e){this.view_="isometric",this.FillText(e,"#ffffff")}DisplayFavor(){this.view_="top",this.FillText("⌘","#ffaa04")}DisplayFrost(){this.view_="top",this.FillText("❄","#4499ff")}ButtonMode(){this.view_="isometric",this.ModeSet_Toggle()}ToggleMode(){this.view_="top",this.ModeSet_Button()}RoundEnd(){this.Light_On_All()}MoveTo(e){b.default.to(this.instance.position,{duration:.15,ease:"none",x:e.x})}Setup(){this.MoveTo(this.anchor_setup)}Organize(){this.MoveTo(this.anchor)}GameStart(){this.view_="top"}GameOver(){this.view_="isometric",this.Turn_Toggle(null),this.DisplayFavor(),this.Light_Off_All(),this.Organize()}setDebug(){this.debug.active&&(this.debugFolder=this.debug.ui.addFolder("clock"),this.debugFolder.addColor(this.body_.material,"color").name("body_color"),this.debugFolder.add(this.body_.material,"metalness").min(0).max(1).step(.001).name("body_metalness"),this.debugFolder.add(this.body_.material,"roughness").min(0).max(1).step(.001).name("body_roughness"),this.debugFolder.add(this.body_.material,"envMapIntensity").min(0).max(6).step(.001).name("body_envMapIntensity"),this.debugFolder.addColor(this.switch_button_red.material,"color").name("body_color"),this.debugFolder.add(this.switch_button_red.material,"metalness").min(0).max(1).step(.001).name("body_metalness"),this.debugFolder.add(this.switch_button_red.material,"roughness").min(0).max(1).step(.001).name("body_roughness"),this.debugFolder.add(this.switch_button_red.material,"envMapIntensity").min(0).max(6).step(.001).name("body_envMapIntensity"))}}const Ie=15;let Ee=new y.Matrix4;class Ve{static instance=null;constructor(){null==Ve.instance&&(Ve.instance=this,this.experience=new Nt,this.world=this.experience.world,this.scene=this.experience.scene,this.resources=this.experience.resources,this.geometryManager=this.experience.geometry,this.materialManager=this.experience.material,this.debug=this.experience.debug,this.Initialize())}get instance(){return this.effect_mesh}Initialize(){let e=new Float32Array(Ie);for(let t=0;t<Ie;t++)e[t]=0;this.effect_geometry=this.geometryManager.items.token.clone(),this.effect_geometry.setAttribute("alpha",new y.InstancedBufferAttribute(e,1,!0,1)),this.effect_materials=[,,this.materialManager.referenceMaterial("ragnarok_effect"),,,,],this.effect_mesh=new y.InstancedMesh(this.effect_geometry,this.effect_materials,Ie),this.effect_mesh.layers.enable(1),this.index_queue=Array.from(Array(Ie).keys()),this.particle_infos=[];for(let e=0;e<Ie;e++){let t=new y.Matrix4;t.setPosition(new y.Vector3(0,-1,20)),this.effect_mesh.setMatrixAt(e,t),this.particle_infos.push(new Re(e))}this.effect_mesh.renderOrder=2,this.effect_mesh.instanceMatrix.needsUpdate=!0,this.scene.add(this.effect_mesh),this.world.Add_AnimationObject(this.instance.id,this)}GetParticle(){let e=this.index_queue.pop();return null==e?null:this.particle_infos[e]}ReturnParticle(e){this.index_queue.push(e)}initialMove(e,t,i){return this.GetParticle().initialMove(e,t,i)}Spend(e){return this.GetParticle().Spend(e)}slideMove(e,t){return this.GetParticle().slideMove(e,t)}SetMatrixAt(e,t){this.instance.setMatrixAt(e,t),this.instance.instanceMatrix.needsUpdate=!0}SetOpacityAt(e,t){this.effect_mesh.geometry.attributes.alpha.array[e]=t,this.effect_mesh.geometry.attributes.alpha.needsUpdate=!0}Update(){for(let e=0;e<Ie;e++){let t,i,s=e,o=this.particle_infos[s];1==Re.needsUpdate[s]&&(t=o.effect_matrix,this.SetMatrixAt(s,t),Re.needsUpdate[s]=!1),1==Re.needsEffectUpdate[s]&&(i=o.opacity.effect,this.SetOpacityAt(s,i))}}}class Re{static needsUpdate=new Array(Ie).fill(!1);static needsEffectUpdate=new Array(Ie).fill(!1);static quat_=new y.Quaternion(0,.258819,0,.965925);static scale_=new y.Vector3(1.3,1,1.3);constructor(e){this.index=e,this.position={vec:new y.Vector3(0,-3,20),get x(){return this.vec.x},get y(){return this.vec.y},get z(){return this.vec.z},set x(e){this.vec.setX(e),Re.needsUpdate[this.index]=!0},set y(e){this.vec.setY(e),Re.needsUpdate[this.index]=!0},set z(e){this.vec.setZ(e),Re.needsUpdate[this.index]=!0}},this.position.index=e,this.opacity={effect_:0,get effect(){return this.effect_},set effect(e){this.effect_=e,Re.needsEffectUpdate[this.index]=!0}},this.opacity.index=e}get effect_matrix(){let e=this.position.vec.clone();return e.setY(e.y+.05),Ee.compose(e,Re.quat_,Re.scale_),Ee}AnimationEnd(){this.position.x=0,this.position.y=-2,this.position.z=20,Ve.instance.ReturnParticle(this.index)}setPosition(e){this.position.x=e.x,this.position.y=e.y,this.position.z=e.z}initialMove(e,t,i){let s,o=b.default.timeline();return this.setPosition(e),s=1==i?this.position.y:t.y,o.to(this.opacity,{duration:.6,ease:"none",effect:1}),o.to(this.position,{duration:.6,ease:"none",y:s},"<"),1==i?o.to(this.position,{duration:.55,ease:"none",x:t.x,y:.25,z:t.z}):o.from(this.position,{duration:.55,ease:"none",x:t.x,y:s,z:t.z}),o.addLabel("lightoff",">"),o.to(this.opacity,{duration:.4,ease:"none",effect:0,onComplete:()=>{this.AnimationEnd()}}),o}Spend(e){let t=b.default.timeline();return this.setPosition(e),t.to(this.opacity,{duration:.5,ease:"none",effect:1}),t.addLabel("lightoff",">"),t.to(this.opacity,{delay:.5,duration:.5,ease:"none",effect:0,onComplete:()=>{this.AnimationEnd()}}),t}slideMove(e,t){let i=b.default.timeline();return this.setPosition(e),i.to(this.opacity,{delay:.2,duration:.4,ease:"none",effect:1}),i.addLabel("lighton","<"),i.to(this.position,{delay:.15,duration:.4,ease:"none",x:t.x,y:t.y,z:t.z}),i.to(this.opacity,{delay:.15,duration:.4,effect:0,ease:"none",onComplete:()=>{this.AnimationEnd()}}),i}}const ze=30;let $e=new y.Matrix4;new y.Color;const je=new y.Vector3(0,-2,15);class Ue{constructor(e){this.experience=new Nt,this.world=this.experience.world,this.scene=this.experience.scene,this.resources=this.experience.resources,this.materialManager=this.experience.material,this.debug=this.experience.debug,this.user=null,this.Initialize(e)}get instance(){return this.mesh}get id(){return this.instance.id}Initialize(e){this.user=e>0?"bottom":"top";let t=new Float32Array(ze);Array.from(Array(ze).keys()).reverse(),this.index_queue=0,this.token_infos=[];for(let e=0;e<ze;e++)t[e]=1,this.token_infos.push(new Le(this.user,e,(()=>{this.DisplaySync(e)})));this.geometry=new y.CylinderGeometry(.65,.65,.15,6,1,!1,Math.PI/6,2*Math.PI),this.geometry.setAttribute("alpha",new y.InstancedBufferAttribute(t,1,!0,1)),this.material=this.materialManager.referenceMaterial("ragnarok_material"),this.mesh=new y.InstancedMesh(this.geometry,this.material,ze),this.mesh.castShadow=!0;for(let e=0;e<ze;e++)$e.setPosition(je),this.mesh.setMatrixAt(e,$e);this.mesh.instanceMatrix.needsUpdate=!0,this.scene.add(this.mesh),this.experience.world.Add_AnimationObject(this.mesh.id,this)}NewToken(e){let t=this.GetToken();return t.Set_Begin_Position_Effect(e),t}GetToken(){let e=this.Active();return this.token_infos[e]}Active(){let e=this.index_queue;return this.index_queue++,e}Show(e){let t=function(e,t){const i={top:-1,bottom:1}[`${e}`],s=new y.Vector3(4*i,0,4*i);let o=new y.Vector3(0,0,0),r=t,a=1.3,n=s;return i<0&&(n.z+=i*a*.5,n.x+=i*a*4),o.z=a*Math.floor(r/25)+n.z,r=Math.floor(r%25),o.x=a*Math.floor(r/5)+n.x,o.y=.2+.25*Math.floor(r%5)+n.y,o}(this.user,e),i=this.token_infos[e];i.position.x=t.x,i.position.y=t.y,i.position.z=t.z,i.opacity.color=1,i.time.value=0}Hide(e){let t=new y.Vector3(0,-3,15);$e.setPosition(t);let i=this.token_infos[e];i.position.x=0,i.position.y=-3,i.position.z=15,i.opacity.color=0,i.time.value=0}DisplaySync(e){e<this.index_queue?this.Show(e):this.Hide(e)}SetMatrixAt(e,t){this.mesh.setMatrixAt(e,t),this.mesh.instanceMatrix.needsUpdate=!0}SetOpacityAt_Color(e,t){this.mesh.geometry.attributes.alpha.array[e]=t,this.mesh.geometry.attributes.alpha.needsUpdate=!0}Update(){for(let e=0;e<ze;e++){let t=e,i=this.token_infos[t],s=null;if(1==Le.needsUpdate[`${this.user}`][t]){let e=i.matrix;this.SetMatrixAt(t,e),Le.needsUpdate[`${this.user}`][t]=!1}1==Le.needsColorUpdate[`${this.user}`][t]&&(s=i.opacity.color,this.SetOpacityAt_Color(t,s),Le.needsColorUpdate[`${this.user}`][t]=!1)}}}class Le{static needsUpdate={bottom:new Array(ze).fill(!1),top:new Array(ze).fill(!1)};static needsColorUpdate={bottom:new Array(ze).fill(!1),top:new Array(ze).fill(!1)};constructor(e,t,i){this.user=e,this.index=t,this.DisplaySync=i,this.effect_begin_position=new y.Vector3,this.owner=null,this.filter={color:!1},this.position={vec:new y.Vector3(0,5,0),get x(){return this.vec.x},get y(){return this.vec.y},get z(){return this.vec.z},set x(e){this.vec.setX(e),Le.needsUpdate[`${this.user}`][this.index]=!0},set y(e){this.vec.setY(e),Le.needsUpdate[`${this.user}`][this.index]=!0},set z(e){this.vec.setZ(e),Le.needsUpdate[`${this.user}`][this.index]=!0}},this.position.index=t,this.position.user=e,this.opacity={color_:0,get color(){return this.color_},set color(e){this.color_=e,Le.needsColorUpdate[`${this.user}`][this.index]=!0}},this.opacity.index=t,this.opacity.user=e,this.animation_cnt=0}get matrix(){return $e.setPosition(this.position.vec),$e}SetPosition(e){this.position.x=e.x,this.position.y=.2,this.position.z=e.z}Set_Begin_Position_Effect(e){this.effect_begin_position.copy(e)}initialMove(e,t=!0,i){this.animation_cnt++;let s=this.effect_begin_position,o=Ve.instance.initialMove(s,e,t);return o.to(this.opacity,{duration:.4,ease:"none",color:1,onStart:()=>{this.SetPosition(e),i&&i.Damaged()}},"lightoff"),o}destroy(){}}const He=[{right:{weapon:"axe",token:!1},left:{weapon:"shield",token:!1},top:{weapon:"axe",token:!1},bottom:{weapon:"helmet",token:!1},front:{weapon:"arrow",token:!0},back:{weapon:"steal",token:!0}},{right:{weapon:"axe",token:!1},left:{weapon:"shield",token:!0},top:{weapon:"axe",token:!1},bottom:{weapon:"steal",token:!0},front:{weapon:"arrow",token:!1},back:{weapon:"helmet",token:!1}},{right:{weapon:"axe",token:!1},left:{weapon:"arrow",token:!0},top:{weapon:"axe",token:!1},bottom:{weapon:"helmet",token:!0},front:{weapon:"steal",token:!1},back:{weapon:"shield",token:!1}},{right:{weapon:"arrow",token:!1},left:{weapon:"shield",token:!1},top:{weapon:"axe",token:!1},bottom:{weapon:"helmet",token:!0},front:{weapon:"steal",token:!0},back:{weapon:"axe",token:!1}},{right:{weapon:"axe",token:!1},left:{weapon:"shield",token:!0},top:{weapon:"axe",token:!1},bottom:{weapon:"helmet",token:!1},front:{weapon:"steal",token:!1},back:{weapon:"arrow",token:!0}},{right:{weapon:"axe",token:!1},left:{weapon:"shield",token:!0},top:{weapon:"axe",token:!1},bottom:{weapon:"arrow",token:!1},front:{weapon:"steal",token:!1},back:{weapon:"helmet",token:!0}}];let Ne=["top","bottom"];const We=["Baldr","Bragi","Brunhild","Freyja","Freyr","Frigg","Heimdall","Hel","Idun","Loki","Mimir","Odin","Skadi","Skuld","Thor","Thrymr","Tyr","Ullr","Var","Vidar"];class qe{constructor(){this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.gameObjects={},this.playerInteractableObjects=[],this.top_card_pick_ancnor=new y.Vector3(-3.75,0,-3.75),this.bottom_card_pick_anchor=new y.Vector3(2.25,0,5.5),this.itemsDictionary=new Map,this.animation_objects=new Map,this.resources.on("ready",(()=>{this.environment=new W,this.double_cube=new Oe,this.experience.controller.double_cube=this.double_cube,new Ve,new we,this.ragnarok=new Ue,this.clock=new Be,this.clock.Light("top",0,!1),this.clock.Light("top",1,!1),this.clock.Light("top",2,!1),this.clock.Light("bottom",0,!1),this.clock.Light("bottom",1,!1),this.clock.Light("bottom",2,!1),this.clock.DisplayFavor(),this.stamp=new Fe,this.stamp.PositionToOrigin(),this.avatars={top:new Ce(-1),bottom:new Ce(1)},this.experience.controller.avatars.top=this.avatars.top,this.experience.controller.avatars.bottom=this.avatars.bottom,this.flipCoin=new xe([this.avatars.top.coinAnchor,this.avatars.bottom.coinAnchor]),this.experience.controller.flipCoin=this.flipCoin,this.towel=new de;let e=new ce;e.mesh.position.z=6,e.Set_Original_Position(),this.avatars.bottom.tray.copy(e.mesh.position),this.avatars.bottom.bowl=e,e=new ce,e.mesh.position.z=-6,e.Set_Original_Position(),this.avatars.top.tray.copy(e.mesh.position),this.avatars.top.bowl=e;let t=null;t=this.avatars.bottom.actionEndAnchor.clone(),this.dices=[],this.token_dices=[],He.forEach(((e,i)=>{let s;s=i>5?"token":"weapon";let o=new q(e,s);i>5?(this.token_dices.push(o),this.avatars.bottom.tokenDiceDictionary[`${o.getID()}`]={obj:o,index:i-6},this.avatars.bottom.token_dices.push(o)):(this.dices.push(o),this.avatars.bottom.diceDictionary[`${o.getID()}`]={obj:o,index:i},this.avatars.bottom.dices.push(o)),this.gameObjects[`${o.getID()}`]=o,this.playerInteractableObjects.push(o.mesh.mesh);let r=t;o.setPosition(r),r.setX(r.x+1.3)})),t=this.avatars.top.actionEndAnchor.clone(),He.forEach(((e,i)=>{let s;s=i>5?"token":"weapon";let o=new q(e,s);i>5?(this.token_dices.push(o),this.avatars.top.tokenDiceDictionary[`${o.getID()}`]={obj:o,index:i-6},this.avatars.top.token_dices.push(o)):(this.dices.push(o),this.avatars.top.diceDictionary[`${o.getID()}`]={obj:o,index:i},this.avatars.top.dices.push(o)),this.gameObjects[`${o.getID()}`]=o,this.playerInteractableObjects.push(o.mesh.mesh);let r=t;o.setPosition(r),r.setX(r.x-1.3)})),this.godFavors={},Ne.forEach(((e,t)=>{this.godFavors[`${e}`]={};let i=this.avatars[`${e}`];i.godFavorDictionary={},We.forEach(((s,o)=>{let r=new y.Vector3(3*o-30,.1,20+4*t);const a=new le(s,r,this.experience.godFavorsInfo[`${s}`],this.experience.godFavorsAction[`${s}`]);i.godFavorDictionary[`${a.getID()}`]={obj:a,index:o},this.playerInteractableObjects.push(a.mesh),this.gameObjects[a.mesh.id]=a,this.godFavors[`${e}`][`${s}`]=a,a.RemoveScene()}))})),Ne.forEach((e=>{let t=this.avatars[`${e}`],i=1.4,s=1.5,o={};o.x=(1+t.anchorSign)*i*-2+t.healthStoneAnchor.x,o.y=t.healthStoneAnchor.y,o.z=t.healthStoneAnchor.z;for(let e=0;e<15;e++){let r=Math.floor(e%5)*i+o.x,a=o.y,n=(Math.floor(e/5)-1)*s+o.z,h=new y.Vector3(r,a,n),l=new _e(t);l.SetPosition(h),l.model.mesh.castShadow=!0,t.healthStones.push(l),this.playerInteractableObjects.push(l.model.mesh),t.healthStoneDictionary[`${l.getID()}`]={obj:l,index:e},e>0&&(t.healthStones[e-1].next_stone=l)}})),this.resources.items.tray_map.encoding=y.sRGBEncoding,this.resources.items.tray_map.anisotropy=16,this.resources.items.tray_normal.encoding=y.sRGBEncoding,this.resources.items.tray_normal.anisotropy=16,new y.MeshStandardMaterial({map:this.resources.items.tray_map,normalMap:this.resources.items.tray_normal,metalness:.25,roughness:.75,envMapIntensity:2})}))}GameStart(){this.clock.GameStart(),this.FilterGodfavors()}GameOver(){this.flipCoin.GameOver(),this.double_cube.GameOver(),this.clock.GameOver(),this.stamp.ClearBanSign(),We.forEach(((e,t)=>{let i=this.godFavors.bottom[`${e}`],s=this.godFavors.top[`${e}`];i.GameOver(),s.GameOver()}))}Add_AnimationObject(e,t){this.animation_objects.set(e,t)}Remove_AnimationObject(e){this.animation_objects.delete(e)}AddThing(e,t,i){let s=t.godFavors;e.godFavors=[];for(let t=0;t<3;t++){let o=We[s[t]],r=e.godFavorAnchor.clone();r.x+=1.8*t*e.anchorSign;let a=this.godFavors[`${i}`][`${o}`];a.setPosition(r),a.Playing_On(),e.godFavors.push(a),e.godFavorDictionary[`${a.getID()}`].index=t}}FilterGodfavors(){We.forEach(((e,t)=>{let i=this.godFavors.bottom[`${e}`],s=this.godFavors.top[`${e}`];i.FilterScene(),s.FilterScene()}))}CardBanMove(e,t){let i=We[t],s=this.godFavors.bottom[`${i}`];return s.state="banned_sign",s.Ban_On(),this.stamp.Stamp(s.getPosition().clone())}CardPickMove(e,t,i){let s=We[t],o=this.godFavors.bottom[`${s}`];o.state="waiting";let r=o.Highlight_On_Pick(),a=this.avatars[`${e}`].godFavorAnchor.clone();return a.x+=1.8*i*this.avatars[`${e}`].anchorSign,a.y=1.5,new Promise((e=>{r.then((()=>{b.default.to(o.mesh.position,{duration:.3,y:1.5,ease:"Power2.easeOut"}),o.moveTo(a,.3).then((()=>{e(1)}))}))}))}PrintAnchor(){}ArrangeCards(e){let t,i,s,o=new y.Vector3(0,1.5,-11),r=2,a=3.25;this.clock.Setup(),this.double_cube.Setup(),"liberty"==e?(i=4,t=new y.Vector3(5*-r-2,.15,(.25-(i-1)/2)*a)):(r=2.2,i=3,t=new y.Vector3(5*-r,.15,(.25-(i-1)/2)*a)),s=We.length/i,s=parseInt(Math.ceil(s));let n,h=[],l=this.avatars.bottom;return We.forEach(((e,i)=>{n=this.godFavors.bottom[`${e}`].getID(),l.godFavorDictionary[`${n}`].index=i;let c=this.godFavors.bottom[`${e}`];c.AddScene(),c.Playing_Off(),c.index=i,c.setPosition(o);let d=t.x+r*(i%s),u=t.y,m=t.z+a*Math.floor(i/s);h.push(c.moveTo(new y.Vector3(d,u,m),i/10))})),Promise.all(h)}OrganizeCards(){this.stamp.ClearBanSign();let e=new y.Vector3(0,.5,-12),t=[];return We.forEach(((i,s)=>{let o=this.godFavors.bottom[`${i}`];o.Highlight_Off(),o.Ban_Off(),"waiting"!==o.state&&t.push(o.moveTo(e,s/30))})),Promise.all(t)}OrganizeTable(){We.forEach(((e,t)=>{this.godFavors.bottom[`${e}`].GameOver()})),this.clock.Organize(),this.double_cube.Organize()}SetupTable(){this.clock.Setup(),this.double_cube.Setup()}CreateDice(e){let t=new q(He[e]);return this.dices.push(t),this.gameObjects[`${t.getID()}`]=t,this.playerInteractableObjects.push(t.mesh.mesh),t}RemoveDice(e){this.dices.pop(),delete this.gameObjects[`${e.getID()}`],this.playerInteractableObjects.pop()}TurnOnInteract(e){e.forEach((e=>{this.gameObjects[`${e.getID()}`]=e}))}TurnOffInteract(e){e.forEach((e=>{delete this.gameObjects[`${e.getID()}`]}))}checkSelectedObject(e){return this.FindFromDictionary(e.getID())?{type:"doublecube"}:null}FindFromDictionary(e){return this.itemsDictionary.has(e)?this.itemsDictionary.get(e).obj:null}AddItem(e){this.itemsDictionary.set(e.getID(),{obj:e})}Take_FrostBite(e,t){let i=new y.Vector3;this.clock.screen_.getWorldPosition(i);let[s,o]=this.avatars[`${e}`].Take_FrostBite(t),r=[];return s.forEach(((e,t)=>{let s=this.ragnarok.NewToken(i),a=o[t];r.push(s.initialMove(e,!0,a))})),Promise.all(r)}update(e){for(const t of this.animation_objects)t[1].Update(e);this.avatars.top.dices.forEach((t=>{t.update(e)})),this.avatars.top.token_dices.forEach((t=>{t.update(e)})),this.avatars.bottom.dices.forEach((t=>{t.update(e)})),this.avatars.bottom.token_dices.forEach((t=>{t.update(e)}))}}const Xe=(e=>{var t={};return x.d(t,e),t})({GLTFLoader:()=>n.GLTFLoader}),Ye=(e=>{var t={};return x.d(t,e),t})({SVGLoader:()=>h.SVGLoader}),Qe=(e=>{var t={};return x.d(t,e),t})({FontLoader:()=>l.FontLoader});class Ze extends k{constructor(e){super(),this.sources=e,this.items={},this.toLoad=this.sources.length,this.loaded=0,this.loadingBarElement=document.getElementsByClassName("loading-bar")[0],this.setLoaders(),this.startLoading()}setLoaders(){this.loaders={},this.loaders.gltfLoader=new Xe.GLTFLoader,this.loaders.textureLoader=new y.TextureLoader,this.loaders.cubeTextureLoader=new y.CubeTextureLoader,this.loaders.svgLoader=new Ye.SVGLoader,this.loaders.soundLoader=new y.AudioLoader,this.loaders.fontLoader=new Qe.FontLoader,Object.keys(this.loaders).forEach((e=>{this.loaders[`${e}`].crossOrigin="anonymous"})),this.r2_url="http://localhost:3000/resources"}async startLoading(){for(const e of this.sources)if(await new Promise((e=>{setTimeout((()=>{e(!0)}),25)})),"gltfModel"===e.type)this.loaders.gltfLoader.load(this.r2_url+e.path,(t=>{this.sourceLoaded(e,t)}));else if("texture"===e.type)this.loaders.textureLoader.load(this.r2_url+e.path,(t=>{this.sourceLoaded(e,t)}));else if("cubeTexture"===e.type){let t=new Array(6).fill(this.r2_url);t=t.map(((t,i)=>t+e.path[i])),this.loaders.cubeTextureLoader.load(t,(t=>{this.sourceLoaded(e,t)}))}else"svg"===e.type?this.loaders.svgLoader.load(this.r2_url+e.path,(t=>{let i;1==t.paths.length?i=Ye.SVGLoader.createShapes(t.paths[0]):(i=[],t.paths.forEach((e=>{i.push(Ye.SVGLoader.createShapes(e))}))),this.sourceLoaded(e,i)})):"sound"===e.type?this.loaders.soundLoader.load(this.r2_url+e.path,(t=>{this.sourceLoaded(e,t)})):"font"===e.type&&this.loaders.fontLoader.load(this.r2_url+e.path,(t=>{this.sourceLoaded(e,t)}))}sourceLoaded(e,t){this.items[e.name]=t,this.loaded++,this.loadingBarElement.style.transform=`scaleX(${(this.loaded+1)/this.toLoad})`,this.loaded===this.toLoad&&(this.items.perlin_noise.encoding=y.sRGBEncoding,this.items.perlin_noise.wrapS=y.RepeatWrapping,this.items.perlin_noise.wrapT=y.RepeatWrapping,window.BlackOff(),this.trigger("ready"))}}const Je=[{name:"environmentMapTexture",type:"cubeTexture",path:["/textures/environmentMap/px.jpg","/textures/environmentMap/nx.jpg","/textures/environmentMap/py.jpg","/textures/environmentMap/ny.jpg","/textures/environmentMap/pz.jpg","/textures/environmentMap/nz.jpg"]},{name:"pebblesModel",type:"gltfModel",path:"/models/Collections/pebbles.glb"},{name:"grassColorTexture",type:"texture",path:"/textures/dirt/color.jpg"},{name:"grassNormalTexture",type:"texture",path:"/textures/dirt/normal.jpg"},{name:"axeModel",type:"gltfModel",path:"/models/Weapon/axe.glb"},{name:"arrowModel",type:"gltfModel",path:"/models/Weapon/arrow.glb"},{name:"bowModel",type:"gltfModel",path:"/models/Weapon/bow.glb"},{name:"helmetModel",type:"gltfModel",path:"/models/Weapon/helmet.glb"},{name:"shieldModel",type:"gltfModel",path:"/models/Weapon/shield.glb"},{name:"mjolnirModel",type:"gltfModel",path:"/models/Weapon/mjolnir.glb"},{name:"ChessClock",type:"gltfModel",path:"/models/Collections/ChessClock_X.glb"},{name:"stampModel",type:"gltfModel",path:"/models/Collections/stamp.glb"},{name:"stamp_ao",type:"texture",path:"/textures/stamp/ao.jpg"},{name:"stamp_map",type:"texture",path:"/textures/stamp/map.jpg"},{name:"stamp_normal",type:"texture",path:"/textures/stamp/normal.jpg"},{name:"stamp_roughness",type:"texture",path:"/textures/stamp/roughness.jpg"},{name:"diceArrowTexture",type:"texture",path:"/textures/dice/ACV-ArrowOrlog.webp"},{name:"diceAxeTexture",type:"texture",path:"/textures/dice/ACV-AxeOrlog.webp"},{name:"diceGodFavorTexture",type:"texture",path:"/textures/dice/ACV-GodFavorOrlog.webp"},{name:"diceHelmetTexture",type:"texture",path:"/textures/dice/ACV-HelmetOrlog.webp"},{name:"diceShieldTexture",type:"texture",path:"/textures/dice/ACV-ShieldOrlog.webp"},{name:"diceStealTexture",type:"texture",path:"/textures/dice/ACV-StealFavorOrlog.webp"},{name:"ArrowMark",type:"texture",path:"/textures/dice/Arrow.png"},{name:"AxeMark",type:"texture",path:"/textures/dice/Axe.png"},{name:"HelmetMark",type:"texture",path:"/textures/dice/Helmet.png"},{name:"ShieldMark",type:"texture",path:"/textures/dice/Shield.png"},{name:"StealMark",type:"texture",path:"/textures/dice/Steal.png"},{name:"TokenMark",type:"texture",path:"/textures/dice/Token.png"},{name:"OneMark",type:"texture",path:"/textures/dice/OneMark.png"},{name:"TwoMark",type:"texture",path:"/textures/dice/TwoMark.png"},{name:"ThreeMark",type:"texture",path:"/textures/dice/ThreeMark.png"},{name:"FourMark",type:"texture",path:"/textures/dice/FourMark.png"},{name:"ragnarok_map",type:"texture",path:"/textures/ragnarok/ragnarok_token_B.png"},{name:"ragnarok_normal",type:"texture",path:"/textures/ragnarok/ragnarok_normal.png"},{name:"godBaldrTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Baldr.webp"},{name:"godBragiTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Bragi.webp"},{name:"godBrunhildTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Brunhild.webp"},{name:"godFreyjaTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Freyja.webp"},{name:"godFreyrTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Freyr.webp"},{name:"godFriggTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Frigg.webp"},{name:"godHeimdallTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Heimdall.webp"},{name:"godHelTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Hel.webp"},{name:"godIdunTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Idun.webp"},{name:"godLokiTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Loki.webp"},{name:"godMimirTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Mimir.webp"},{name:"godOdinTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Odin.webp"},{name:"godSkadiTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Skadi.webp"},{name:"godSkuldTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Skuld.webp"},{name:"godThorTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Thor.webp"},{name:"godThrymrTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Thrymr.webp"},{name:"godTyrTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Tyr.webp"},{name:"godUllrTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Ullr.webp"},{name:"godVarTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Var.webp"},{name:"godVidarTexture",type:"texture",path:"/textures/godfavor/map/ACV_Orlog_Vidar.webp"},{name:"ragnarok_token",type:"svg",path:"/svg/ragnarok_token_E.svg"},{name:"BaldrSVG",type:"svg",path:"/textures/godfavor/svg/Baldr_svg_A.svg"},{name:"BragiSVG",type:"svg",path:"/textures/godfavor/svg/Bragi_svg_A.svg"},{name:"BrunhildSVG",type:"svg",path:"/textures/godfavor/svg/Brunhild_svg.svg"},{name:"FreyjaSVG",type:"svg",path:"/textures/godfavor/svg/Freyja_svg.svg"},{name:"FreyrSVG",type:"svg",path:"/textures/godfavor/svg/Freyr_svg.svg"},{name:"FriggSVG",type:"svg",path:"/textures/godfavor/svg/Frigg_svg.svg"},{name:"HeimdallSVG",type:"svg",path:"/textures/godfavor/svg/Heimdall_svg.svg"},{name:"HelSVG",type:"svg",path:"/textures/godfavor/svg/Hel_svg.svg"},{name:"IdunSVG",type:"svg",path:"/textures/godfavor/svg/Idun_svg.svg"},{name:"LokiSVG",type:"svg",path:"/textures/godfavor/svg/Loki_svg.svg"},{name:"MimirSVG",type:"svg",path:"/textures/godfavor/svg/Mimir_svg.svg"},{name:"OdinSVG",type:"svg",path:"/textures/godfavor/svg/Odin_svg.svg"},{name:"SkadiSVG",type:"svg",path:"/textures/godfavor/svg/Skadi_svg.svg"},{name:"SkuldSVG",type:"svg",path:"/textures/godfavor/svg/Skuld_svg.svg"},{name:"ThorSVG",type:"svg",path:"/textures/godfavor/svg/Thor_svg_A.svg"},{name:"ThrymrSVG",type:"svg",path:"/textures/godfavor/svg/Thrymr_svg.svg"},{name:"TyrSVG",type:"svg",path:"/textures/godfavor/svg/Tyr_svg.svg"},{name:"UllrSVG",type:"svg",path:"/textures/godfavor/svg/Ullr_svg.svg"},{name:"VarSVG",type:"svg",path:"/textures/godfavor/svg/Var_svg.svg"},{name:"VidarSVG",type:"svg",path:"/textures/godfavor/svg/Vidar_svg.svg"},{name:"godBaldrNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Baldr_normal.png"},{name:"godBragiNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Bragi_normal.png"},{name:"godBrunhildNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Brunhild_normal.png"},{name:"godFreyjaNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Freyja_normal.png"},{name:"godFreyrNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Freyr_normal.png"},{name:"godFriggNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Frigg_normal.png"},{name:"godHeimdallNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Heimdall_normal.png"},{name:"godHelNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Hel_normal.png"},{name:"godIdunNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Idun_normal.png"},{name:"godLokiNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Loki_normal.png"},{name:"godMimirNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Mimir_normal.png"},{name:"godOdinNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Odin_normal.png"},{name:"godSkadiNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Skadi_normal.png"},{name:"godSkuldNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Skuld_normal.png"},{name:"godThorNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Thor_normal.png"},{name:"godThrymrNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Thrymr_normal.png"},{name:"godTyrNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Tyr_normal.png"},{name:"godUllrNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Ullr_normal.png"},{name:"godVarNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Var_normal.png"},{name:"godVidarNormalmapTexture",type:"texture",path:"/textures/godfavor/normal/Vidar_normal.png"},{name:"godBaldrEffect",type:"svg",path:"/textures/godfavor/effect/Baldr.svg"},{name:"godBragiEffect",type:"svg",path:"/textures/godfavor/effect/Bragi.svg"},{name:"godBrunhildEffect",type:"svg",path:"/textures/godfavor/effect/Brunhild.svg"},{name:"godFreyjaEffect",type:"svg",path:"/textures/godfavor/effect/Freyja.svg"},{name:"godFreyrEffect",type:"svg",path:"/textures/godfavor/effect/Freyr.svg"},{name:"godFriggEffect",type:"svg",path:"/textures/godfavor/effect/Frigg_A.svg"},{name:"godHeimdallEffect",type:"svg",path:"/textures/godfavor/effect/Heimdall.svg"},{name:"godHelEffect",type:"svg",path:"/textures/godfavor/effect/Hel.svg"},{name:"godIdunEffect",type:"svg",path:"/textures/godfavor/effect/Idun.svg"},{name:"godLokiEffect",type:"svg",path:"/textures/godfavor/effect/Loki.svg"},{name:"godMimirEffect",type:"svg",path:"/textures/godfavor/effect/Mimir.svg"},{name:"godOdinEffect",type:"svg",path:"/textures/godfavor/effect/Odin.svg"},{name:"godSkadiEffect",type:"svg",path:"/textures/godfavor/effect/Skadi.svg"},{name:"godSkuldEffect",type:"svg",path:"/textures/godfavor/effect/Skuld.svg"},{name:"godThorEffect",type:"svg",path:"/textures/godfavor/effect/Thor_A.svg"},{name:"godThrymrEffect",type:"svg",path:"/textures/godfavor/effect/Thrymr.svg"},{name:"godTyrEffect",type:"svg",path:"/textures/godfavor/effect/Tyr.svg"},{name:"godUllrEffect",type:"svg",path:"/textures/godfavor/effect/Ullr.svg"},{name:"godVarEffect",type:"svg",path:"/textures/godfavor/effect/Var.svg"},{name:"godVidarEffect",type:"svg",path:"/textures/godfavor/effect/Vidar.svg"},{name:"godsymbolDisp",type:"texture",path:"/textures/godsymbol/diplacement_map.jpeg"},{name:"godsymbolDisp2",type:"texture",path:"/textures/godsymbol/displacement_.png"},{name:"godsymbolNormal",type:"texture",path:"/textures/godsymbol/normalmap.png"},{name:"godsymbolNormal2",type:"texture",path:"/textures/godsymbol/normalmap2.png"},{name:"godsymbolNoise",type:"texture",path:"/textures/godsymbol/Perlin_noise_example.png"},{name:"godsymbolAO",type:"texture",path:"/textures/godsymbol/AOmap.png"},{name:"godsymbolAO2",type:"texture",path:"/textures/godsymbol/AOmap2.png"},{name:"godsymbolDiffuse",type:"texture",path:"/textures/godsymbol/diffuseMap.jpg"},{name:"wood_table_worn_diff",type:"texture",path:"/textures/wood_table_worn_4k/textures/wood_table_worn_diff_4k.jpg"},{name:"wood_table_worn_arm",type:"texture",path:"/textures/wood_table_worn_4k/textures/wood_table_worn_arm_4k.jpg"},{name:"wood_table_worn_nor",type:"texture",path:"/textures/wood_table_worn_4k/textures/wood_table_worn_nor_gl_4k.jpg"},{name:"leather_white_diff",type:"texture",path:"/textures/leather_white_4k/textures/leather_white_diff_4k.jpg"},{name:"leather_white_arm",type:"texture",path:"/textures/leather_white_4k/textures/leather_white_arm_4k.jpg"},{name:"leather_white_nor",type:"texture",path:"/textures/leather_white_4k/textures/leather_white_nor_gl_4k.jpg"},{name:"book_pattern_diff",type:"texture",path:"/textures/book_pattern_1k/textures/book_pattern_col1_1k.jpg"},{name:"book_pattern_arm",type:"texture",path:"/textures/book_pattern_1k/textures/book_pattern_arm_1k.jpg"},{name:"book_pattern_nor",type:"texture",path:"/textures/book_pattern_1k/textures/book_pattern_nor_gl_1k.jpg"},{name:"book_pattern_diff_I",type:"texture",path:"/textures/book_pattern_1k/textures/book_pattern_col1_1k_I.jpg"},{name:"perlin_noise",type:"texture",path:"/textures/noise/perlin.png"},{name:"ban_sign",type:"texture",path:"/textures/ban/ban.png"},{name:"bgm",type:"sound",path:"/sounds/orlog-bgm.mp3"},{name:"Victory",type:"sound",path:"/sounds/ingame/Victory.mp3"},{name:"arrow_block_1",type:"sound",path:"/sounds/ingame/arrow_block_1.mp3"},{name:"arrow_damage",type:"sound",path:"/sounds/ingame/arrow_damage.mp3"},{name:"arrow_shot_0",type:"sound",path:"/sounds/ingame/arrow_shot_0.mp3"},{name:"axe_block_0",type:"sound",path:"/sounds/ingame/axe_block_0.mp3"},{name:"axe_block_1",type:"sound",path:"/sounds/ingame/axe_block_1.mp3"},{name:"axe_damage_0",type:"sound",path:"/sounds/ingame/axe_damage_0.mp3"},{name:"axe_damage_1",type:"sound",path:"/sounds/ingame/axe_damage_1.mp3"},{name:"axe_throw",type:"sound",path:"/sounds/ingame/axe_throw.mp3"},{name:"coinflip",type:"sound",path:"/sounds/ingame/coinflip.mp3"},{name:"create_token",type:"sound",path:"/sounds/ingame/create_token.mp3"},{name:"dice_hover_0",type:"sound",path:"/sounds/ingame/dice_hover_0.mp3"},{name:"dice_hover_1",type:"sound",path:"/sounds/ingame/dice_hover_1.mp3"},{name:"dice_hover_2",type:"sound",path:"/sounds/ingame/dice_hover_2.mp3"},{name:"dice_hover_3",type:"sound",path:"/sounds/ingame/dice_hover_3.mp3"},{name:"dice_hover_4",type:"sound",path:"/sounds/ingame/dice_hover_4.mp3"},{name:"dice_hover_5",type:"sound",path:"/sounds/ingame/dice_hover_5.mp3"},{name:"dice_move_0",type:"sound",path:"/sounds/ingame/dice_move_0.mp3"},{name:"dice_move_1",type:"sound",path:"/sounds/ingame/dice_move_1.mp3"},{name:"dice_roll_0",type:"sound",path:"/sounds/ingame/dice_roll_0.mp3"},{name:"dice_roll_1",type:"sound",path:"/sounds/ingame/dice_roll_1.mp3"},{name:"dice_take_0",type:"sound",path:"/sounds/ingame/dice_take_0.mp3"},{name:"dice_take_1",type:"sound",path:"/sounds/ingame/dice_take_1.mp3"},{name:"godfavor_power",type:"sound",path:"/sounds/ingame/godfavor_power.mp3"},{name:"group_roll_0",type:"sound",path:"/sounds/ingame/group_roll_0.mp3"},{name:"group_roll_1",type:"sound",path:"/sounds/ingame/group_roll_1.mp3"},{name:"group_roll_2",type:"sound",path:"/sounds/ingame/group_roll_2.mp3"},{name:"group_roll_3",type:"sound",path:"/sounds/ingame/group_roll_3.mp3"},{name:"group_roll_4",type:"sound",path:"/sounds/ingame/group_roll_4.mp3"},{name:"group_roll_5",type:"sound",path:"/sounds/ingame/group_roll_5.mp3"},{name:"steal_token_0",type:"sound",path:"/sounds/ingame/steal_token_0.mp3"},{name:"steal_token_2",type:"sound",path:"/sounds/ingame/steal_token_2.mp3"},{name:"stone_shed_2",type:"sound",path:"/sounds/ingame/stone_shed_2.mp3"},{name:"stone_shed_3",type:"sound",path:"/sounds/ingame/stone_shed_3.mp3"},{name:"sound_thor",type:"sound",path:"/sounds/ingame/thor.mp3"},{name:"card_sound_landing",type:"sound",path:"/sounds/card/card_landing_A.mp3"},{name:"card_sound_take",type:"sound",path:"/sounds/card/card_take_A.mp3"},{name:"card_sound_throw",type:"sound",path:"/sounds/card/card_throw_A.mp3"},{name:"circle01",type:"texture",path:"/textures/circle/circle01.png"},{name:"particle_star_06",type:"texture",path:"/textures/particle/star_06.png"},{name:"particle_muzzle_01",type:"texture",path:"/textures/particle/muzzle_01.png"},{name:"particle_circle_05",type:"texture",path:"/textures/particle/circle_05.png"},{name:"particle_star_08",type:"texture",path:"/textures/particle/star_08.png"},{name:"waternormals",type:"texture",path:"/textures/waternormals.jpg"},{name:"uv_checker",type:"texture",path:"/textures/uv_checker.jpg"},{name:"uv_band",type:"texture",path:"/textures/uv_band.jpg"},{name:"carpet_border_O",type:"texture",path:"/textures/carpet_border_O.jpg"},{name:"token_normal",type:"texture",path:"/textures/godsymbol/token_normal_N.png"},{name:"textures_godsymbol_colormap",type:"texture",path:"/textures/godsymbol/textures_godsymbol_colormap_D.png"},{name:"token_svg",type:"svg",path:"/textures/godsymbol/token_svg.svg"},{name:"tray_map",type:"texture",path:"/textures/tray/tray_map_C.jpeg"},{name:"tray_normal",type:"texture",path:"/textures/tray/tray_normal_C.jpeg"},{name:"tray_roughness",type:"texture",path:"/textures/tray/tray_roughness_C.jpeg"},{name:"traywall_map",type:"texture",path:"/textures/traywall/traywall_map_C.jpeg"},{name:"traywall_normal",type:"texture",path:"/textures/traywall/traywall_normal_C.jpeg"},{name:"traywall_roughness",type:"texture",path:"/textures/traywall/traywall_roughness_C.jpeg"},{name:"wood02_map",type:"texture",path:"/textures/wood/02/DefaultMaterial_BaseColor.jpg"},{name:"wood02_normal",type:"texture",path:"/textures/wood/02/DefaultMaterial_Normal.jpg"},{name:"wood02_roughness",type:"texture",path:"/textures/wood/02/DefaultMaterial_Roughness.jpg"},{name:"wood08_map",type:"texture",path:"/textures/wood/08/wooden08_map.jpg"},{name:"wood08_normal",type:"texture",path:"/textures/wood/08/wooden08_normal.jpg"},{name:"wood08_roughness",type:"texture",path:"/textures/wood/08/wooden08_roughness.jpg"},{name:"coin_green",type:"texture",path:"/textures/coin/coin_green_A.jpeg"},{name:"coin_green_normal",type:"texture",path:"/textures/coin/coin_green_normal.jpeg"},{name:"coin_blue",type:"texture",path:"/textures/coin/coin_blue.jpeg"},{name:"coin_blue_normal",type:"texture",path:"/textures/coin/coin_blue_normal.jpeg"},{name:"doublecube_map",type:"texture",path:"/textures/doublecube/double_cube_map_D.png"},{name:"doublecube_number_map",type:"texture",path:"/textures/doublecube/double_cube_number_map_D.png"},{name:"font_tektur",type:"font",path:"/fonts/Tektur_Condensed_Bold.json"}],Ke={Baldr:{title:{en:"Baldr's Invulnerability",kr:"발드르의 무적"},description:{en:"Add {HELMET} for each die that rolled {HELMET}.<br>Add {SHIELD} for each die that rolled {SHIELD}.",kr:"{HELMET} 주사위마다 {HELMET}을 추가합니다.<br>{SHIELD} 주사위마다 {SHIELD}를 추가합니다."},spec_en:function(e){return`+${this.effectValue[e]} {HELMET} & {SHIELD} per die`},spec_kr:function(e){return`{HELMET} & {SHIELD} 1개당 +${this.effectValue[e]}`},cost:[3,6,9],afterDecision:!1,effectValue:[1,2,3],priority:4,color:16750848},Bragi:{title:{en:"Bragi's Verve",kr:"브라기의 활력"},description:{en:"Gain ⌘ for each die that rolled a {STEAL}.",kr:"{STEAL} 주사위마다 ⌘ 을 획득합니다."},spec_en:function(e){return`Gain ${this.effectValue[e]} ⌘ per die`},spec_kr:function(e){return`주사위 1개당 ⌘ ${this.effectValue[e]} 개 획득`},cost:[4,8,12],afterDecision:!1,effectValue:[2,3,4],priority:4,color:10779648},Brunhild:{title:{en:"Brunhild's Fury",kr:"브룬힐드의 분노"},description:{en:"Multiply each {AXE} die.<br>Round up to a whole number.",kr:"{AXE} 개수에 곱하기를 합니다. <br>소수점 아래는 올림합니다."},spec_en:function(e){return`x${this.effectValue[e]} {AXE}`},spec_kr:function(e){return`{AXE} x${this.effectValue[e]}`},cost:[6,10,18],afterDecision:!1,effectValue:[1.5,2,3],priority:4,color:1136076},Freyja:{title:{en:"Freyja's Plenty",kr:"프레이야의 풍요"},description:{en:"Roll additional dice this round.",kr:"이번 라운드에서 주사위를 추가로 굴립니다."},spec_en:function(e){return`+${this.effectValue[e]} dice`},spec_kr:function(e){return`+${this.effectValue[e]} 주사위`},cost:[2,4,6],afterDecision:!1,effectValue:[1,2,3],priority:2,color:16711935,modelName:"FreyjaDice"},Freyr:{title:{en:"Freyr's Gift",kr:"프레이의 선물"},description:{en:"Add to the total of whichever die face is in majority.",kr:"가장 많이 나온 주사위 면 개수를 증가시킵니다. (동률이면 그중 임의의 주사위 면)"},spec_en:function(e){return`+${this.effectValue[e]}`},spec_kr:function(e){return`+${this.effectValue[e]}`},cost:[4,6,8],afterDecision:!1,effectValue:[2,3,4],priority:4,color:16749567},Frigg:{title:{en:"Frigg's Sight",kr:"프리그의 시야"},description:{en:"Re-roll any of your, or your opponent's, dice.",kr:"자신 또는 상대의 주사위를 다시 굴립니다."},spec_en:function(e){return`Re-roll ${this.effectValue[e]} dice`},spec_kr:function(e){return`주사위 ${this.effectValue[e]} 개를 다시 굴립니다.`},cost:[2,3,4],afterDecision:!1,effectValue:[2,3,4],priority:2,extraInput:{trigger:"Resolution",user:"bottom",godfavor:"Frigg"},color:14277081},Heimdall:{title:{en:"Heimdall's Watch",kr:"헤임달의 경계"},description:{en:"Gain health tokens for each attack you block.",kr:"상대의 공격을 방어할 때마다<br>체력을 회복합니다."},spec_en:function(e){return`+ ${this.effectValue[e]} HP per Block`},spec_kr:function(e){return`방어 1회 당 HP +${this.effectValue[e]} `},cost:[4,7,10],afterDecision:!1,effectValue:[1,2,3],priority:4,color:6770343},Hel:{title:{en:"Hel's Grip",kr:"헬의 손아귀"},description:{en:"Each {AXE} damage dealt to the opponent heals you.",kr:"상대에게 입힌 {AXE} 피해마다<br>자신의 체력을 회복합니다."},spec_en:function(e){return`+ ${this.effectValue[e]} HP per damage`},spec_kr:function(e){return`피해 1 당 HP +${this.effectValue[e]}`},cost:[6,12,18],afterDecision:!1,effectValue:[1,2,3],priority:4,color:3700253},Idun:{title:{en:"Idun's Rejuvenation",kr:"이둔의 회춘"},description:{en:"Gain health tokens.",kr:"체력을 회복합니다."},spec_en:function(e){return`Heal ${this.effectValue[e]} HP`},spec_kr:function(e){return`체력 ${this.effectValue[e]} 회복`},cost:[4,7,10],afterDecision:!0,effectValue:[2,4,6],priority:7,color:16776960},Loki:{title:{en:"Loki's Trick",kr:"로키의 계략"},description:{en:"Ban opponent's dice for the Round.",kr:"상대의 주사위를 골라<br>이번 라운드에서 배제합니다."},spec_en:function(e){return`Ban ${this.effectValue[e]} dice`},spec_kr:function(e){return`주사위 ${this.effectValue[e]} 개 배제`},cost:[3,6,9],afterDecision:!1,effectValue:[1,2,3],priority:2,extraInput:{trigger:"Resolution",user:"bottom",godfavor:"Loki"},color:10066329},Mimir:{title:{en:"Mimir's Wisdom",kr:"미미르의 지혜"},description:{en:"Gain ⌘ for each attack dealt to you causing damage.",kr:"자신에게 피해를 입힌 공격마다<br>⌘ 을 획득합니다."},spec_en:function(e){return`+ ${this.effectValue[e]} ⌘ per damage`},spec_kr:function(e){return`입은 피해 당 ⌘ ${this.effectValue[e]} 개 획득`},cost:[3,5,7],afterDecision:!1,effectValue:[1,2,3],priority:4,color:16568392},Odin:{title:{en:"Odin's Sacrifice",kr:"오딘의 희생"},description:{en:"Sacrifice any number of your health tokens and gain ⌘ per health token sacrificed.",kr:"자신의 체력을 원하는 만큼 희생하여<br>⌘ 을 획득합니다."},spec_en:function(e){return`Gain ${this.effectValue[e]} ⌘ per health token`},spec_kr:function(e){return`희생한 체력 1당 ⌘ ${this.effectValue[e]} 개 획득`},cost:[6,8,10],afterDecision:!0,effectValue:[3,4,5],priority:7,extraInput:{trigger:"Resolution",user:"bottom",godfavor:"Odin"},color:16777215},Skadi:{title:{en:"Skadi's Hunt",kr:"스칼디의 사냥"},description:{en:"Add {ARROW} for each die that rolled {ARROW}",kr:"{ARROW} 주사위마다 {ARROW} 을 추가합니다."},spec_en:function(e){return`+${this.effectValue[e]} {ARROW} per die`},spec_kr:function(e){return`{ARROW} ${this.effectValue[e]} 개 추가`},cost:[6,10,14],afterDecision:!1,effectValue:[1,2,3],priority:4,color:16711680},Skuld:{title:{en:"Skuld's Claim",kr:"스쿨드의 압수"},description:{en:"Destroy apponent's ⌘ for each die that rolled {ARROW}",kr:"자신의 {ARROW} 주사위마다<br>상대의 ⌘ 을 파괴합니다."},spec_en:function(e){return`-${this.effectValue[e]} ⌘ per die`},spec_kr:function(e){return`주사위 1개당 ⌘ ${this.effectValue[e]} 개 파괴`},cost:[4,6,8],afterDecision:!1,effectValue:[2,3,4],priority:3,color:4040109},Thor:{title:{en:"Thor's Strike",kr:"토르의 일격"},description:{en:"Deal damage to the opponent.",kr:"상대에게 피해를 입힙니다."},spec_en:function(e){return`-${this.effectValue[e]} HP`},spec_kr:function(e){return`${this.effectValue[e]} 피해`},cost:[4,8,12],afterDecision:!0,effectValue:[2,5,8],priority:6,color:65535},Thrymr:{title:{en:"Thrymr's Theft",kr:"스림의 도둑질"},description:{en:"Reduce the effect level of the God Favor invoked by opponent this turn.",kr:"상대가 이번 라운드에 불러낸<br>신의 축복 효과를 낮춥니다."},spec_en:function(e){return`Reduce ${this.effectValue[e]} level`},spec_kr:function(e){return`${this.effectValue[e]}단계 낮춥니다.`},cost:[3,6,9],afterDecision:!1,effectValue:[1,2,3],priority:1,color:0},Tyr:{title:{en:"Tyr's Pledge",kr:"티르의 맹세"},description:{en:"Sacrifice any number of your health tokens to destroy opponent's ⌘",kr:"자신의 체력을 원하는 만큼 희생하여 상대의 ⌘ 을 파괴합니다."},spec_en:function(e){return`Destroy ${this.effectValue[e]} ⌘ per HP`},spec_kr:function(e){return`희생한 체력 1 당 ⌘ ${this.effectValue[e]}개 파괴`},cost:[4,6,8],afterDecision:!1,effectValue:[2,3,4],priority:3,extraInput:{trigger:"Resolution",user:"bottom",godfavor:"Tyr"},color:10027263},Ullr:{title:{en:"Ullr's Aim",kr:"울르의 조준"},description:{en:"Your {ARROW} bypasses the opponent's {SHIELD}",kr:"자신의 {ARROW} 이 상대의 {SHIELD} 를 무시합니다."},spec_en:function(e){return`${this.effectValue[e]} {ARROW} bypasses {SHIELD}`},spec_kr:function(e){return`{ARROW} ${this.effectValue[e]}개가 {SHIELD} 무시`},cost:[2,3,4],afterDecision:!1,effectValue:[2,3,6],priority:4,color:9684093},Var:{title:{en:"Var's Bond",kr:"바르의 결속"},description:{en:"Each ⌘ spent by your opponent heals you.",kr:"상대가 소비한 ⌘ 마다 자신의 체력을<br>회복합니다."},spec_en:function(e){return`+${this.effectValue[e]} HP per ⌘`},spec_kr:function(e){return`⌘ 1개당 HP +${this.effectValue[e]}`},cost:[10,14,18],afterDecision:!1,effectValue:[1,2,3],priority:1,color:65280},Vidar:{title:{en:"Vidar's Might",kr:"비다르의 힘"},description:{en:"Remove rolled {HELMET} dice from opponent.",kr:"상대의 {HELMET}을 제거합니다."},spec_en:function(e){return`-${this.effectValue[e]} {HELMET}`},spec_kr:function(e){return`-${this.effectValue[e]} {HELMET}`},cost:[2,4,6],afterDecision:!1,effectValue:[2,4,6],priority:4,color:13386021}};function et(e){let t=[];const i=.1*(e-1)/2;for(let s=0;s<e;s++){let e=new y.Object3D,o=.1*s-i;e.translateX(o),e.translateY(-o),e.updateMatrix(),t.push(e.matrix.clone())}return t}let tt={Baldr:{power:async function(e,t,i,s){await this.Blink(this.effectMesh.material);let o=s.dices_index,r=s.marks_cnt,a=t.GetDices_Top_Position_By_Indexes(o);await this.ShootingStar_Fire(a);let n=[];for(let e=0;e<o.length;e++)n.push(et(r[e]));let h=[],l=[];for(let e=0;e<o.length;e++){let[i,s]=t.ConvertDiceMark(null,this.color,[o[e]],[r[e]],n[e]);h.push(...i),l.push(...s)}return await Promise.all(h),[l,[]]}},Bragi:{power:async function(e,t,i){await this.Blink(this.effectMesh.material);let s=this.effectValue[e],o=t.GetDicesIndexsOnCondition((e=>"steal"==e.getWeapon())),r=t.GetDices_Top_Position_By_Indexes(o);await this.ShootingStar_Fire(r);let a=[];o.forEach((e=>{for(let i=0;i<s;i++){let s=t.dices[e].getPosition().clone();s.y+=.5*i,a.push(t.CreateNewToken(s))}})),await Promise.all(a)}},Brunhild:{power:async function(e,t,i){await this.Blink(this.effectMesh.material);let s=t.GetDicesIndexsOnCondition((e=>"axe"==e.getWeapon())),o=s.length,r=this.effectValue[e],a=Math.ceil(o*r),n=Math.floor(a/o),h=a%o,l=Array(o).fill(n);for(let e=0;e<h;e++)l[e]++;let c=t.GetDices_Top_Position_By_Indexes(s);await this.ShootingStar_Fire(c);let d=o,u=[],m=[],p=[];for(let e=0;e<d;e++){let i;switch(l[e]){case 1:i=new y.Object3D,u.push(i.matrix.clone());break;case 2:i=new y.Object3D,i.rotateZ(-.1),i.translateX(.05),i.updateMatrix(),u.push(i.matrix.clone()),i=new y.Object3D,i.rotateZ(.1),i.translateX(-.05),i.scale.set(-1,1,1),i.updateMatrix(),u.push(i.matrix.clone());break;case 3:for(let e=0;e<3;e++)i=new y.Object3D,i.rotateZ(2*e*Math.PI/3+Math.PI/6),i.scale.set(.85,.85,.85),i.translateX(.07),i.translateY(.07),i.updateMatrix(),u.push(i.matrix.clone())}let[o,r]=t.ConvertDiceMark(this.weaponName,this.color,[s[e]],[l[e]],u);m.push(...o),p.push(...r)}return await Promise.all(m),[p,[]]}},Freyja:{power:async function(e,t,i,s){await this.Blink(this.effectMesh.material);let o=e+1,r=new y.Vector3(0,0,5.5*t.anchorSign),a=-1*(o-1)*1.3/2,n=[];for(let e=0;e<o;e++)r.x=a+1.3*e,r.y=.5,n.push(r.clone());return await this.ShootingStar_Fire(n),[[function(){t.ReduceDices(e+1)}],[function(){let i=[],o=e+1,r=-1*(o-1)*1.3/2,a=new y.Vector3(0,0,5.5*t.anchorSign);for(let e=0;e<o;e++){let t=this.CreateItem("dice",s.nDiceIndexes[e]);a.x=r+1.3*e,a.y=.5,t.state="waiting",t.setPosition(a),i.push(t)}t.AddDices(i)}]]}},Freyr:{power:async function(e,t,i,s){await this.Blink(this.effectMesh.material);let o=s.increasedWeapon,r=s.weaponIndexes.length,a=[],n=[],h=t.GetDicesIndexsOnCondition((e=>e.getWeapon()==o)),l=t.GetDices_Top_Position_By_Indexes(h);await this.ShootingStar_Fire(l);for(let e=0;e<r;e++){s.weaponIndexes[e];let i=et(s.increasedValue[e]),r=s.weaponIndexes[e],h=s.increasedValue[e],[l,c]=t.ConvertDiceMark(o,this.color,[r],[h],i);a.push(...l),n.push(...c)}return await Promise.all(a),[n,[]]}},Frigg:{power:async function(e,t,i,s){await this.Blink(this.effectMesh.material);let o=this.effectValue[e];this.extraPickedDiceCnt=o},extraPower:async function(e,t,i,s,o){let r,a=o.avatar,n=o.dices_index;r="bottom"===a?t:i;let h=r.GetDicesPosition_By_Indexes(n);await this.ShootingStar_Fire(h)}},Heimdall:{power:async function(e,t,i){await this.Blink(this.effectMesh.material);let s=t.GetDicesIndexsOnCondition((e=>"helmet"==e.getWeapon())),o=t.GetDicesIndexsOnCondition((e=>"shield"==e.getWeapon())),r=t.GetDices_Top_Position_By_Indexes(s),a=t.GetDices_Top_Position_By_Indexes(o);await Promise.all([this.ShootingStar_Fire(r),this.ShootingStar_Fire(a)]),await t.Highlighting_Marks(this.color,[...s,...o],1);let n=this.effectValue[e];t.eventEmitter.on(`${t.index}-block-axe`,(()=>{for(let e=0;e<n;e++)t.Heal()})),t.eventEmitter.on(`${t.index}-block-arrow`,(()=>{for(let e=0;e<n;e++)t.Heal()})),t.eventEmitter.on(`${t.index}-block-axe-anim`,(e=>{for(let i=0;i<n;i++)t.HealingBall_Animation(e)})),t.eventEmitter.on(`${t.index}-block-arrow-anim`,(e=>{for(let i=0;i<n;i++)t.HealingBall_Animation(e)}))}},Hel:{power:async function(e,t,i){await this.Blink(this.effectMesh.material);let s=this.effectValue[e];for(let e=0;e<s;e++);t.eventEmitter.on(`${i.index}-damage-axe`,(()=>{for(let e=0;e<s;e++)t.Heal()})),t.eventEmitter.on(`${i.index}-damage-axe-anim`,(e=>{for(let i=0;i<s;i++)t.HealingBall_Animation(e,null)}));let o=t.GetDicesIndexsOnCondition((e=>"axe"==e.getWeapon())),r=t.GetDices_Top_Position_By_Indexes(o);await this.ShootingStar_Fire(r);let a=Array(o.length).fill(1),n=[];for(let e=0;e<1;e++){let t=new y.Object3D,i=.1*e-0;t.translateX(i),t.translateY(-i),t.updateMatrix(),n.push(t.matrix.clone())}let[h,l]=t.ConvertDiceMark(this.weaponName,this.color,o,a,n);return await Promise.all(h),[l,[]]}},Idun:{power:async function(e,t,i){await this.Blink(this.effectMesh.material);let s=this.effectValue[e],o=t.Get_Need_Heal_Positions(s),r=this.HealingBall_Fire(o);await r;let a=[];for(let e=0;e<s;e++)a.push(t.Heal());await Promise.all(a),a.length=0;for(let e=0;e<s;e++)a.push(t.HealAnimation());await Promise.all(a)}},Loki:{power:async function(e,t,i,s){let o=this.effectValue[e];this.extraPickedDiceCnt=o},extraPower:async function(e,t,i,s,o){await this.Blink(this.effectMesh.material);let r=o.dices_index,a=i.GetDicesPosition_By_Indexes(r);await this.ShootingStar_Fire(a)}},Mimir:{power:async function(e,t,i){await this.Blink(this.effectMesh.material);let s=t.Get_FireWorks_Position();s.setY(3.5),await this.FireWorks_Fire([s]),await new Promise((e=>{setTimeout((()=>{e(!0)}),500)})),t.HealthStones_Change_Color(.144444),await new Promise((e=>{setTimeout((()=>{e(!0)}),400)}));let o=this.effectValue[e];return t.eventEmitter.on(`${t.index}-damage-axe`,(()=>{for(let e=0;e<o;e++)t.Token_Create_Immediately()})),t.eventEmitter.on(`${t.index}-damage-arrow`,(()=>{for(let e=0;e<o;e++)t.Token_Create_Immediately()})),t.eventEmitter.on(`${t.index}-damage-godfavor`,(()=>{for(let e=0;e<o;e++)t.Token_Create_Immediately()})),t.eventEmitter.on(`${t.index}-damage-axe-anim`,(e=>{for(let i=0;i<o;i++){let s=e.clone();s.y+=.3*i,t.Token_Initial_Animation(s)}})),t.eventEmitter.on(`${t.index}-damage-arrow-anim`,(e=>{for(let i=0;i<o;i++){let s=e.clone();s.y+=.3*i,t.Token_Initial_Animation(s)}})),t.eventEmitter.on(`${t.index}-damage-godfavor-anim`,(e=>{for(let i=0;i<o;i++){let s=e.clone();s.y+=.3*i,t.Token_Initial_Animation(s)}})),[[()=>{t.HealthStones_Reset_Color()}],[]]}},Odin:{power:async function(e,t,i,s){},extraPower:async function(e,t,i,s,o){let r=o.damage,a=o.coefficient;await this.Blink(this.effectMesh.material);let n=t.Get_Damage_Stones_Positions(r);await this.ShootingStar_Fire(n);let h=[];for(let e=0;e<r;e++){let e=t.GetTargetHealthStone();if(null==e)break;for(let i=0;i<a;i++){let s=e.clone();s.y=.2*(i+1),h.push(t.CreateNewToken(s))}}return Promise.all(h)}},Skadi:{power:async function(e,t,i){await this.Blink(this.effectMesh.material);let s=t.GetDicesIndexsOnCondition((e=>"arrow"==e.getWeapon())),o=this.effectValue[e]+1,r=Array(s.length).fill(o),a=t.GetDices_Top_Position_By_Indexes(s);await this.ShootingStar_Fire(a);let n=o,h=[];const l=.1*(n-1)/2;for(let e=0;e<n;e++){let t=new y.Object3D,i=.1*e-l;t.translateX(i),t.translateY(-i),t.updateMatrix(),h.push(t.matrix.clone())}let[c,d]=t.ConvertDiceMark(this.weaponName,this.color,s,r,h);return await Promise.all(c),[d,[]]}},Skuld:{power:async function(e,t,i){await this.Blink(this.effectMesh.material);let s=this.effectValue[e],o=t.GetDicesIndexsOnCondition((e=>"arrow"==e.getWeapon())),r=o.length,a=t.GetDices_Top_Position_By_Indexes(o);await this.ShootingStar_Fire(a),await t.Highlighting_Marks(this.color,o,1);let[n,h]=i.Get_Tokens_Area_Position(),l=1/(a.length+1),c=l;a.forEach((e=>{let t=new y.Vector3;t.lerpVectors(n,h,c),c+=l,this.PoisonNeedles_Fire(e,t)})),i.Token_Destroy_Immediately(s*r)>0&&i.Token_Destroy_Animation(),await new Promise((e=>{setTimeout((()=>{e(!0)}),2500)}))}},Thor:{power:async function(e,t,i){await this.Blink(this.effectMesh.material),this.experience.sound.Play_SoundThor();let s=[];for(let t=0;t<this.effectValue[e]&&!(i.health<=0);t++){let e=this.getPosition(),t=new S("mjolnir");t.SetPosition(e);let o=t.GetTarget(i);null!=o&&s.push(t.Action(o,i))}let o=[];await Promise.all(s).then((e=>{e.forEach((e=>{o.push(e())}))})),await Promise.all(o)}},Thrymr:{power:async function(e,t,i){await this.Blink(this.effectMesh.material)}},Tyr:{power:async function(e,t,i,s){},extraPower:async function(e,t,i,s,o){let r=o.damage,a=o.coefficient;await this.Blink(this.effectMesh.material);let n=t.Get_Damage_Stones_Positions(r);await this.ShootingStar_Fire(n);let h=[];for(let e=0;e<r&&null!=t.GetTargetHealthStone();e++)h.push(i.SpendToken(a));await Promise.all(h)}},Ullr:{power:async function(e,t,i){await this.Blink(this.effectMesh.material)}},Var:{power:async function(e,t,i){await this.Blink(this.effectMesh.material);let s=this.effectValue[e];t.eventEmitter.on(`${i.index}-use-token`,(e=>{let i=s*e;for(let e=0;e<i;e++)t.Heal()})),t.eventEmitter.on(`${i.index}-use-token-anim`,(e=>{let i=s;for(let s=0;s<i;s++)t.HealingBall_Animation(e)}))}},Vidar:{power:async function(e,t,i,s){await this.Blink(this.effectMesh.material);let o=s.removedDicesIndex,r=s.removedCnt,a=i.GetDices_Top_Position_By_Indexes(o);await this.ShootingStar_Fire(a);let[n,h]=i.DecreaseDiceMark(this.color,o,r);return await Promise.all(n),[h,[]]}}};const it={Frigg:"Select dices to re-roll.",Loki:"Select dices to ban.",Odin:"Select health tokens to sacrifice.",Tyr:"Select health tokens to sacrifice."};class st extends k{constructor(){super(),this.deltaTime=0,this.experience=new Nt,this.sizes=this.experience.sizes,this.scene=this.experience.scene,this.canvas=this.experience.canvas,this.camera=this.experience.camera,this.selectedObject=[],this.mouse={x:0,y:0},this.raycaster=new y.Raycaster,this.playerInteractableObjects=this.experience.world.playerInteractableObjects,this.currentHoveredObject,this.lastHoverredGameObject=null,window.addEventListener("mousemove",(e=>{this.mouse.x=e.clientX/this.sizes.width*2-1,this.mouse.y=-e.clientY/this.sizes.height*2+1,this.mousemove()})),this.canvas.addEventListener("contextmenu",(e=>{null!=this.lastHoverredGameObject?(this.trigger("active_object",[this.lastHoverredGameObject.id]),this.trigger("contextmenu",[this.lastHoverredGameObject.id])):this.trigger("deactive_objects"),e.preventDefault()}),!1),this.canvas.addEventListener("click",(()=>{null!=this.lastHoverredGameObject?this.trigger("select",[this.lastHoverredGameObject.id]):this.trigger("empty")})),window.addEventListener("keydown",(e=>{switch(e.key){case"q":case"w":break;case" ":this.BellPush()}})),window.addEventListener("touchstart",(e=>{this.handleTouchStart(e)}),!1),window.addEventListener("touchmove",(e=>{this.handleTouchMove(e)}),!1),this.xDown=null,this.yDown=null}update(e){this.deltaTime+=e,this.deltaTime>=50&&(this.mousemove(),this.deltaTime=0)}BellPush(e=!1){this.trigger("button-push",["client",e])}handleTouchStart(e){const t=e.touches[0];this.xDown=t.clientX,this.yDown=t.clientY}handleTouchMove(e){if(this.xDown&&this.yDown){var t=e.touches[0].clientX,i=e.touches[0].clientY,s=this.xDown-t,o=this.yDown-i;Math.abs(s)+Math.abs(o)>250&&(this.trigger("button-push",["client"]),this.xDown=null,this.yDown=null)}}mousemove(){this.raycaster.setFromCamera(this.mouse,this.camera.instance);const e=this.raycaster.intersectObjects(this.playerInteractableObjects);if(this.selectedObject=[],e.length>0)for(let t=0;t<e.length;t++)if(e[t].object.id in this.experience.world.gameObjects){this.selectedObject.push(e[t].object);break}this.currentHoveredObject=this.selectedObject[0],this.lastHoverredGameObject!=this.currentHoveredObject&&(this.trigger("hover_off",[this.lastHoverredGameObject]),this.lastHoverredGameObject=this.currentHoveredObject,void 0!==this.currentHoveredObject&&this.trigger("hover_on",[this.selectedObject,this.currentHoveredObject.id]))}}class ot{constructor(){this.experience=new Nt,this.mousemanager=this.experience.mouseManager,this.controller=this.experience.controller,this.debug=this.experience.debug,this.time=this.experience.time,this.filter=[!1,!1,!1,!1,!1,!1,!1,!1,!1],this.ambigious=!1,this.rollDicesCnt=0,this.need_extra_input=!1,this.cached_godfavor_info={godFavorIndex:null,level:null,extraInput:null},this.setDebug()}TmpStorageInputInfo(e,t){this.need_extra_input=!0,this.cached_godfavor_info.godFavorIndex=e,this.cached_godfavor_info.level=t,this.filter[2]=!1}ObjectSelected(e,t=!1){if(this.ambigious&&this.experience.online.active)return;let i=this.controller.ObjectSelected(e);if(null!=i)switch(i.type){case"dice":this.ClickDice(i);break;case"tokendice":this.ClickTokenDice(i);break;case"godfavor":this.ClickGodFavor(i,t,e);break;case"healthstone":return this.ClickHealthstone(i);case"doublecube":this.ClickDoubleCube(i)}}ProposeDoubleGame(){this.controller.GetPhase()}ClickGodFavor(e,t,i){let s=this.controller.GetPhase();"godfavor"===s&&!0===this.filter[2]&&this.experience.ui.click(i,e),"cardselect"===s&&this.controller.MessageEnqueue("PickGodfavor",[e.index,t])}ClickDice(e){(e.isBottom&&this.filter[0]||!e.isBottom&&this.filter[4])&&("godfavor"===this.controller.GetPhase()?this.controller.MessageEnqueue("ExtraClickDice",[e.avatar,e.index]):this.controller.MessageEnqueue("ClickDice",[e.avatar,e.index]))}ClickTokenDice(e){(e.isBottom&&this.filter[1]||!e.isBottom&&this.filter[5])&&this.controller.MessageEnqueue("ClickDice_Token",[e.avatar,e.index])}BellPush(e,t){this.filter[8]&&(this.TurnOnAmbigious(),this.experience.world.clock.Invert_Toggle(),!0===this.need_extra_input?(this.cached_godfavor_info.extraInput=t,this.experience.redbird.MessageEnqueue("BellPushed",[e,this.cached_godfavor_info,this.controller.GetPhase(),this.controller.GetAvatarsInfo()])):this.experience.redbird.MessageEnqueue("BellPushed",[e,t,this.controller.GetPhase(),this.controller.GetAvatarsInfo()]))}ClickHealthstone(e){if(e.isBottom&&this.filter[3]||!e.isBottom&&this.filter[7])return e}ClickDoubleCube(e){this.filter[9]&&(this.DeactivateDoubleCube(),this.experience.redbird.MessageEnqueue("DoubleGame",[]))}DeactivateDoubleCube(){this.filter[9]=!1}ClickDice_RollPhase(e){}TurnOnAmbigious(){this.ambigious=!0;for(let e=0;e<this.filter.length;e++)this.filter[e]=!1}Trigger(e){"RollDice"===e.trigger&&this.rollDicesCnt>=4||this.TurnOffAmbigious(e)}TurnOffAmbigious(e){this.ambigious=!1,this.SetFilter(e)}SetFilter(e){switch(this.time.StartTimer(),this.experience.world.clock.Highlight_On(),e.trigger){case"CardSelect":this.filter[2]=!0,this.filter[8]=!0;break;case"Draft":"bottom"===e.user&&(this.filter[2]=!0,this.filter[8]=!0);break;case"RollDice":if(this.rollDicesCnt++,"bottom"===e.user){this.filter[0]=!0,"modern"==e.game_style&&(this.filter[1]=!0),this.filter[8]=!0;let t=this.controller.double_cube.owner;"bottom"!==t&&null!==t||(this.filter[9]=!0)}"top"!==e.user||this.experience.online.active||(this.filter[4]=!0,this.filter[5]=!0);break;case"GodFavor":this.filter[2]=!0,this.filter[8]=!0,this.experience.online.active||(this.filter[6]=!0);break;case"Resolution":this.SetFilterResolutionPhase(e)}}SetFilterResolutionPhase(e){switch(this.filter[8]=!0,e.godfavor){case"Loki":"bottom"===e.user?this.filter[4]=!0:"top"!==e.user||this.experience.online.active||(this.filter[0]=!0);break;case"Frigg":("bottom"===e.user||"top"===e.user&&!this.experience.online.active)&&(this.filter[4]=!0,this.filter[0]=!0);break;case"Tyr":case"Odin":"bottom"===e.user?(this.filter[3]=!0,this.experience.controller.avatars[`${e.user}`].HealthStonesInteractOn()):"top"!==e.user||this.experience.online.active||(this.filter[7]=!0,this.experience.controller.avatars[`${e.user}`].HealthStonesInteractOn())}}InitialGame(){this.filter=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],this.ambigious=!1,this.rollDicesCnt=0}ResetRound(){this.TurnOnAmbigious(),this.rollDicesCnt=0,this.need_extra_input=!1,this.cached_godfavor_info={godFavorIndex:null,level:null,extraInput:null}}setDebug(){this.debug.active}}const rt=(e=>{var t={};return x.d(t,e),t})({EffectComposer:()=>c.EffectComposer}),at=(e=>{var t={};return x.d(t,e),t})({RenderPass:()=>d.RenderPass}),nt=(e=>{var t={};return x.d(t,e),t})({ShaderPass:()=>u.ShaderPass}),ht=(e=>{var t={};return x.d(t,e),t})({OutlinePass:()=>m.OutlinePass}),lt=(e=>{var t={};return x.d(t,e),t})({FXAAShader:()=>p.FXAAShader}),ct=(e=>{var t={};return x.d(t,e),t})({GammaCorrectionShader:()=>_.GammaCorrectionShader}),dt=(e=>{var t={};return x.d(t,e),t})({UnrealBloomPass:()=>g.UnrealBloomPass}),ut=new y.Layers;ut.set(1);const mt={exposure:1,bloomStrength:2.1,bloomThreshold:0,bloomRadius:.5,scene:"Scene with Glow"};class pt{constructor(e){this.experience=new Nt,this.sizes=this.experience.sizes,this.scene=this.experience.scene,this.debug=this.experience.debug,this.darkMaterial=new y.MeshBasicMaterial({color:"black"}),this.materials={},this.renderer=this.experience.renderer,this.camera=this.experience.camera,this.sizes=this.experience.sizes,this.renderScene=new at.RenderPass(this.scene,this.camera.instance),this.bloomPass=new dt.UnrealBloomPass(new y.Vector2(this.sizes.width,this.sizes.height),1.5,.4,.85),this.bloomPass.threshold=mt.bloomThreshold,this.bloomPass.strength=mt.bloomStrength,this.bloomPass.radius=mt.bloomRadius,this.bloomComposer=new rt.EffectComposer(this.renderer.instance),this.bloomComposer.renderToScreen=!1,this.bloomComposer.addPass(this.renderScene),this.bloomComposer.addPass(this.bloomPass),this.finalPass=new nt.ShaderPass(new y.ShaderMaterial({uniforms:{originalTexture:{value:e.texture},bloomTexture:{value:this.bloomComposer.renderTarget2.texture}},vertexShader:"varying vec2 vUv;\n\n                void main() {\n                \n                    vUv = uv;\n                \n                    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n                \n                }",fragmentShader:"\n                uniform sampler2D originalTexture;\n                uniform sampler2D bloomTexture;\n\n                varying vec2 vUv;\n\n                void main() {\n\n                    gl_FragColor = ( texture2D( originalTexture, vUv ) + vec4( 1.0 ) * texture2D( bloomTexture, vUv ) );\n\n                }",defines:{}}),"baseTexture"),this.finalComposer=new rt.EffectComposer(this.renderer.instance),this.finalComposer.renderToScreen=!0,this.finalComposer.addPass(this.finalPass),this.setDebug()}setDebug(){this.debug.active&&(this.gui=this.experience.debug,this.debugFolder=this.debug.ui.addFolder("bloom"),this.debugFolder.add(mt,"exposure",.1,2).onChange((e=>{this.renderer.instance.toneMappingExposure=Math.pow(e,5)})),this.debugFolder.add(mt,"bloomThreshold",0,1).onChange((e=>{this.bloomPass.threshold=Number(e)})),this.debugFolder.add(mt,"bloomStrength",0,10).onChange((e=>{this.bloomPass.strength=Number(e)})),this.debugFolder.add(mt,"bloomRadius",0,1).step(.01).onChange((e=>{this.bloomPass.radius=Number(e)})))}renderBloom(){this.scene.traverse((e=>{this.darkenNonBloomed(e)})),this.bloomComposer.render(),this.scene.traverse((e=>{this.restoreMaterial(e)}))}darkenNonBloomed(e){let t=this.materials;e.name,e.isMesh&&!1===ut.test(e.layers)&&(t[e.uuid]=e.material,e.material=this.darkMaterial)}restoreMaterial(e){let t=this.materials;t[e.uuid]&&(e.material=t[e.uuid],delete t[e.uuid])}render(){this.renderBloom(),this.finalComposer.render()}}x.d({},{});class _t{constructor(e){this.experience=new Nt,this.sizes=this.experience.sizes,this.renderer=e,this.composer=new rt.EffectComposer(e),this.composer.renderToScreen=!1,this.darkMaterial=new y.MeshBasicMaterial({color:"black"}),this.composer.setSize(this.sizes.width,this.sizes.height),this.composer.setPixelRatio(Math.min(this.sizes.pixelRatio,2)),this.selectedObjects=[],this.passes={},this.setInstance()}setInstance(){this.passes.renderPass=new at.RenderPass(this.experience.scene,this.experience.camera.instance),this.composer.addPass(this.passes.renderPass),this.passes.gammaPass=new nt.ShaderPass(ct.GammaCorrectionShader),this.composer.addPass(this.passes.gammaPass),this.passes.effectFXAA=new nt.ShaderPass(lt.FXAAShader),this.pixelRatio=this.renderer.getPixelRatio(),this.passes.effectFXAA.material.uniforms.resolution.value.set(1/(this.sizes.width*this.sizes.pixelRatio),1/(this.sizes.height*this.sizes.pixelRatio)),this.composer.addPass(this.passes.effectFXAA),this.unrealBloomComposer=new pt(this.composer.renderTarget2),this.passes.outlinePass=new ht.OutlinePass(new y.Vector2(this.sizes.width,this.sizes.height),this.experience.scene,this.experience.camera.instance),this.passes.outlinePass.edgeStrength=8,this.passes.outlinePass.edgeGlow=1,this.passes.outlinePass.edgeThickness=8,this.passes.outlinePass.visibleEdgeColor.set("#ddaa22"),this.passes.outlinePass.hiddenEdgeColor.set("#ddaa22"),this.composer.addPass(this.passes.outlinePass),this.canvas_dom=document.getElementById("game-canvas")}resize(){this.composer.setSize(this.sizes.width,this.sizes.height),this.composer.setPixelRatio(Math.min(this.sizes.pixelRatio,2)),this.pixelRatio=this.renderer.getPixelRatio(),this.passes.effectFXAA.material.uniforms.resolution.value.set(1/(this.sizes.width*this.sizes.pixelRatio),1/(this.sizes.height*this.sizes.pixelRatio))}update(){"none"!==this.canvas_dom.style.display&&(this.composer.render(),this.unrealBloomComposer.render())}hover_on(e){this.passes.outlinePass.selectedObjects=e}hover_off(){this.passes.outlinePass.selectedObjects=[]}}class gt extends k{constructor(e){super(),this.playerType=e,this.experience=new Nt,this.resources=this.experience.resources,this.scene=this.experience.scene,this.debug=this.experience.debug,this.materialColor={value:"#feb2b2"},this.resources.on("ready",(()=>{["ArrowMark","AxeMark","HelmetMark","ShieldMark","StealMark"].forEach((e=>{this.resources.items[`${e}`].encoding=y.sRGBEncoding,this.resources.items[`${e}`].repeat=new y.Vector2(.85,.85),this.resources.items[`${e}`].offset=new y.Vector2((1-.85)/2,(1-.85)/2)})),["OneMark","TwoMark","ThreeMark","FourMark"].forEach((e=>{this.resources.items[`${e}`].encoding=y.sRGBEncoding,this.resources.items[`${e}`].repeat=new y.Vector2(1.25,1.25),this.resources.items[`${e}`].offset=new y.Vector2(-.125,-.125)})),this.resources.items.godsymbolDisp.encoding=y.sRGBEncoding,this.resources.items.ArrowMark.encoding=y.sRGBEncoding,this.resources.items.AxeMark.encoding=y.sRGBEncoding,this.resources.items.HelmetMark.encoding=y.sRGBEncoding,this.resources.items.ShieldMark.encoding=y.sRGBEncoding,this.resources.items.TokenMark.encoding=y.sRGBEncoding,this.resources.items.StealMark.encoding=y.sRGBEncoding,this.resources.items.godsymbolAO2.encoding=y.sRGBEncoding,this.resources.items.token_normal.encoding=y.sRGBEncoding,this.resources.items.textures_godsymbol_colormap.encoding=y.sRGBEncoding;let e=this.resources.items.ragnarok_map,t=this.resources.items.ragnarok_normal;e.encoding=y.sRGBEncoding,t.encoding=y.sRGBEncoding,e.repeat.set(1.15,1),e.wrapS=y.RepeatWrapping,e.wrapT=y.RepeatWrapping,e.offset.set(.95,0),t.repeat.set(1.1,1),t.wrapS=y.RepeatWrapping,t.wrapT=y.RepeatWrapping,t.offset.set(.95,0);let i=this.resources.items.particle_muzzle_01;i.encoding=y.sRGBEncoding;let s=this.resources.items.perlin_noise.clone();s.encoding=y.sRGBEncoding,s.wrapS=y.RepeatWrapping,s.wrapT=y.RepeatWrapping,this.items={zero:new y.MeshBasicMaterial({transparent:!0,opacity:0}),token_effect:new y.MeshStandardMaterial({map:this.resources.items.godsymbolDisp,color:"#ff6622",transparent:!0,opacity:1,blending:y.NormalBlending,depthWrite:!1,depthTest:!1}),token_material_side:new y.MeshStandardMaterial({color:"#ffaa04",transparent:!0,flatShading:!0,opacity:1,blending:y.NormalBlending}),token_material:new y.MeshStandardMaterial({color:"#ffaa04",map:this.resources.items.textures_godsymbol_colormap,aoMap:this.resources.items.godsymbolAO2,normalMap:this.resources.items.token_normal,envMapIntensity:6,metalness:.775,roughness:.225,flatShading:!0,transparent:!0,opacity:1,blending:y.NormalBlending}),ragnarok_effect:new y.MeshStandardMaterial({map:this.resources.items.ragnarok_map,color:"#4499ff",transparent:!0,opacity:1,blending:y.NormalBlending,depthWrite:!1,depthTest:!1}),ragnarok_material:new y.MeshStandardMaterial({color:"#0d2896",map:this.resources.items.ragnarok_map,normalMap:this.resources.items.ragnarok_normal,envMapIntensity:6,metalness:.45,roughness:.55,flatShading:!0,transparent:!0,opacity:1,depthWrite:!1,depthTest:!1}),"normal-weapon":new y.MeshStandardMaterial({transparent:!0,color:"#feb2b2",envMapIntensity:3}),"hel-weapon":new y.MeshStandardMaterial({transparent:!0,color:"#38761d",envMapIntensity:3}),steal:new y.SpriteMaterial({map:this.resources.items.StealMark,color:7566195,transparent:!0,depthTest:!1,rotation:Math.PI/2}),"health-stone":new y.MeshStandardMaterial({color:65297,bumpScale:0,roughness:.375,transparent:!0,map:this.resources.items.diceArrowTexture,envMapIntensity:2.5}),mjolnir:new y.MeshStandardMaterial({transparent:!0,color:"#00ffff"}),arrowMark:new y.MeshStandardMaterial({map:this.resources.items.ArrowMark,transparent:!0,color:"black",opacity:1}),axeMark:new y.MeshStandardMaterial({map:this.resources.items.AxeMark,transparent:!0,color:"black",opacity:1}),helmetMark:new y.MeshStandardMaterial({map:this.resources.items.HelmetMark,transparent:!0,color:"black",opacity:1}),shieldMark:new y.MeshStandardMaterial({map:this.resources.items.ShieldMark,transparent:!0,color:"black",opacity:1}),tokenMark:new y.MeshStandardMaterial({map:this.resources.items.TokenMark,transparent:!0,opacity:1,envMapIntensity:4}),stealMark:new y.MeshStandardMaterial({map:this.resources.items.StealMark,transparent:!0,color:"black",opacity:1}),banSign:new y.MeshBasicMaterial({map:this.resources.items.ban_sign,transparent:!0,color:8388608}),shootingStar:new y.MeshBasicMaterial({map:i,transparent:!0,color:"orange",depthWrite:!1,depthTest:!1}),healingBall:new y.MeshBasicMaterial({map:i,transparent:!0,color:"#88ff00",depthWrite:!1,depthTest:!1}),"shootingStar-particle":new y.MeshBasicMaterial({transparent:!0,depthWrite:!1,depthTest:!1,onBeforeCompile:e=>{e.vertexShader=e.vertexShader.replace("#include <common>","#include <common>\n                        \n                            attribute float alpha;\n                            varying float vAlpha;"),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","#include <begin_vertex>\n                        \n                            vAlpha = alpha;"),e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n                            varying float vAlpha;"),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","#include <color_fragment>\n                            diffuseColor.w = vAlpha;")}})},this.items.ragnarok_effect.onBeforeCompile=e=>{e.vertexShader=e.vertexShader.replace("#include <common>","\n                    #include <common>\n                    attribute float alpha;\n                    varying float vAlpha;\n                    "),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n                    #include <begin_vertex>\n                    vAlpha = alpha;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n                    varying float vAlpha;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","\n                    #include <color_fragment>\n\n                    float mixf = step(0.15, diffuseColor.x);\n\n                    diffuseColor.x *= mixf;\n                    diffuseColor.y *= mixf;\n                    diffuseColor.z *= mixf;\n                    diffuseColor.w = vAlpha * mixf;\n                    ")},this.items.ragnarok_material.onBeforeCompile=e=>{e.vertexShader=e.vertexShader.replace("#include <common>","\n                    #include <common>\n                    attribute float alpha;\n                    varying float vAlpha;\n                    "),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n                    #include <begin_vertex>\n                    vAlpha = alpha;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n                    varying float vAlpha;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","\n                    #include <color_fragment>\n                    diffuseColor.x *= vAlpha;\n                    diffuseColor.y *= vAlpha;\n                    diffuseColor.z *= vAlpha;\n                    diffuseColor.w *= vAlpha;\n                    ")},this.items.token_effect.onBeforeCompile=e=>{e.vertexShader=e.vertexShader.replace("#include <common>","\n                    #include <common>\n                    attribute float alpha;\n                    varying float vAlpha;\n                    "),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n                    #include <begin_vertex>\n                    vAlpha = alpha;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n                    varying float vAlpha;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","\n                    #include <color_fragment>\n\n                    float mixf = step(0.5, diffuseColor.x);\n                    diffuseColor.w = vAlpha * mixf;\n                    ")},this.items.token_material_side.onBeforeCompile=e=>{e.vertexShader=e.vertexShader.replace("#include <common>","\n                    #include <common>\n                    attribute float alpha;\n                    varying float vAlpha;\n                    "),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n                    #include <begin_vertex>\n                    vAlpha = alpha;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n                    varying float vAlpha;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","\n                    #include <color_fragment>\n                    diffuseColor.x *= vAlpha;\n                    diffuseColor.y *= vAlpha;\n                    diffuseColor.z *= vAlpha;\n                    diffuseColor.w *= vAlpha;\n                    ")},this.items.token_material.uThreshold={value:.48},this.items.token_material.uMixTexture={value:s},this.items.token_material.uOutlineColor={value:new y.Vector4(.3,.3,1,1)},this.items.token_material.uThickness_In={value:.53},this.items.token_material.uThickness_Out={value:.86},this.items.token_material.onBeforeCompile=e=>{let t=this.items.healingBall;e.uniforms.uThreshold=t.uThreshold,e.uniforms.uMixTexture=t.uMixTexture,e.uniforms.uOutlineColor=t.uOutlineColor,e.uniforms.uThickness_In=t.uThickness_In,e.uniforms.uThickness_Out=t.uThickness_Out,e.vertexShader=e.vertexShader.replace("#include <common>","#include <common>\n                    \n                \n                    attribute float time;\n                    attribute float alpha;\n                    attribute vec2 offset;\n\n                    varying float vTime;\n                    varying float vAlpha;\n                    varying vec2 vOffset;\n                    "),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","#include <begin_vertex>\n                \n                    vTime = time;\n                    vAlpha = alpha;\n                    vOffset = offset;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <common>","\n                    #include <common>\n\n                    varying float vTime;\n                    varying float vAlpha;\n                    varying vec2 vOffset;\n                    \n                    uniform sampler2D uMixTexture;\n                    uniform float uThreshold;\n                    uniform float uThickness_Out;\n                    uniform float uThickness_In;\n                    uniform vec4 uOutlineColor;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","#include <color_fragment>\n\n\n                    float mixRatio = vTime;\n\n                    vec2 uv;\n                    uv.x = vUv.x + vOffset.x;\n                    uv.y = vUv.y + vOffset.y;\n\n                    vec4 material_ = diffuseColor;\n                    vec4 empty = vec4(0.0, 0.0, 0.0, 0.0);\n                    vec4 transitionTexel = texture2D(uMixTexture, uv);\n            \n                    float r = mixRatio * (1.0 + uThreshold * 2.0) - uThreshold;\n                    float mixf = clamp((transitionTexel.x  - r)*(1.0/uThreshold), 0.0, 1.0);\n        \n                    vec4 tmp_color;\n                    tmp_color.x = 0.1;\n                    tmp_color.y = 0.1;\n                    tmp_color.z = 0.4;\n                    tmp_color.w = 1.0;\n        \n                    mixf = step(0.5, mixf);\n                    // vec4 mainColor = mix( empty, material_, mixf );\n                    // diffuseColor = mix( empty, material_, mixf );\n                    diffuseColor = mix( tmp_color, material_, mixf );\n                    diffuseColor.x *= vAlpha;\n                    diffuseColor.y *= vAlpha;\n                    diffuseColor.z *= vAlpha;\n                    diffuseColor.w *= vAlpha;\n                    ")},this.items.shootingStar.uTime={value:0},this.items.shootingStar.uThreshold={value:.85},this.items.shootingStar.uMixTexture={value:s},this.items.shootingStar.onBeforeCompile=e=>{let t=this.items.shootingStar;e.uniforms.uTime=t.uTime,e.uniforms.uThreshold=t.uThreshold,e.uniforms.uMixTexture=t.uMixTexture,e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n        \n                    uniform float uTime;\n                    uniform float uThreshold;\n                    uniform sampler2D uMixTexture;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","\n                    #include <color_fragment>\n            \n                    float mixRatio = 0.2;\n        \n                    vec2 uv;\n                    uv.x = vUv.x;\n                    uv.y = vUv.y;\n    \n                    vec2 uv_noise;\n                    uv_noise.x = vUv.x + 0.25;\n                    uv_noise.y = vUv.y - uTime;\n    \n                                    \n                    vec4 transitionTexel = texture(uMixTexture, uv_noise);\n                    vec4 material = diffuseColor;\n                    material.x *= (1.0 - vUv.y);\n                    material.y *= (1.0 - vUv.y);\n                    material.z *= (1.0 - vUv.y);\n                    material.w *= (1.0 - vUv.y);\n                    vec4 empty = vec4(0.0, 0.0, 0.0, 0.0);\n    \n                    float r = mixRatio * (1.0 + uThreshold * 2.0) - uThreshold;\n    \n                    float mixf=clamp((transitionTexel.r - r)*(1.0/uThreshold), 0.0, 1.0);\n    \n                    diffuseColor = mix( empty, material, mixf );\n                    ")},this.items.healingBall.uTime={value:0},this.items.healingBall.uThreshold={value:.85},this.items.healingBall.uMixTexture={value:s},this.items.healingBall.onBeforeCompile=e=>{let t=this.items.healingBall;e.uniforms.uTime=t.uTime,e.uniforms.uThreshold=t.uThreshold,e.uniforms.uMixTexture=t.uMixTexture,e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n        \n                    uniform float uTime;\n                    uniform float uThreshold;\n                    uniform sampler2D uMixTexture;\n                    "),e.fragmentShader=e.fragmentShader.replace("#include <color_fragment>","\n                    #include <color_fragment>\n            \n                    float mixRatio = 0.2;\n        \n                    vec2 uv;\n                    uv.x = vUv.x;\n                    uv.y = vUv.y;\n    \n                    vec2 uv_noise;\n                    uv_noise.x = vUv.x + 0.25;\n                    uv_noise.y = vUv.y - uTime;\n    \n                                    \n                    vec4 transitionTexel = texture(uMixTexture, uv_noise);\n                    vec4 material = diffuseColor;\n                    material.x *= (1.0 - vUv.y);\n                    material.y *= (1.0 - vUv.y);\n                    material.z *= (1.0 - vUv.y);\n                    material.w *= (1.0 - vUv.y);\n                    vec4 empty = vec4(0.0, 0.0, 0.0, 0.0);\n    \n                    float r = mixRatio * (1.0 + uThreshold * 2.0) - uThreshold;\n    \n                    float mixf=clamp((transitionTexel.r - r)*(1.0/uThreshold), 0.0, 1.0);\n    \n                    diffuseColor = mix( empty, material, mixf );\n                    ")}}))}referenceMaterial(e){return this.items[`${e}`]}getMaterial(e){return this.items[`${e}`].clone()}setDebug(){this.debug.active&&(this.folder=this.debug.ui.addFolder("Material"),this.folder.addColor(this.materialColor,"value").onChange((e=>{this.items["normal-weapon"].color.set(e)})))}Update(e){this.items.shootingStar.uTime.value+=1/(15*e),this.items.shootingStar.uTime.value>10&&(this.items.shootingStar.uTime.value-=10),this.items.healingBall.uTime.value+=1/(15*e),this.items.healingBall.uTime.value>10&&(this.items.healingBall.uTime.value-=10)}}function ft(e){let t,i=e.length;for(;0!=i;)t=Math.floor(Math.random()*i),i--,[e[i],e[t]]=[e[t],e[i]];return e}class xt extends k{constructor(e){super(),this.playerType=e,this.experience=new Nt,this.resources=this.experience.resources,this.scene=this.experience.scene,this.resources.on("ready",(()=>{let e=Array.from(Array(15).keys());ft(e);let t=Array.from(Array(15).keys());ft(t);let i=[...e,...t];this.items={resources:this.resources,axe:this.resources.items.axeModel.scenes[0].children[0],helmet:this.resources.items.helmetModel.scenes[0].children[0],arrow:this.resources.items.arrowModel.scenes[0].children[0],shield:this.resources.items.shieldModel.scenes[0].children[0],bow:this.resources.items.bowModel.scenes[0].children[0],steal:null,token:new y.BoxGeometry(1,.075,1,1,1,1),tokenEffect:new y.BoxGeometry(1,.075,1,4,4,4),mjolnir:this.resources.items.mjolnirModel.scenes[0].children[0],health_stone_index:0,get"health-stone"(){let e=i[this.health_stone_index++];return this.resources.items.pebblesModel.scenes[0].children[e].geometry.index__=e%15,this.resources.items.pebblesModel.scenes[0].children[e].geometry.team__=this.health_stone_index<=15?"top":"bottom",this.resources.items.pebblesModel.scenes[0].children[e].geometry}},this.setBow();let s=["axe","helmet","arrow","shield","bow","mjolnir"];s.forEach((e=>{"shield"==e&&this.items[`${e}`].updateMatrix()})),s.forEach((e=>{this.items[`${e}`].material.dispose(),this.items[`${e}`]=this.items[`${e}`].geometry}))}))}getGeometry(e){return this.items[`${e}`]}setBow(){let e=this.items.bow.geometry,t=e.attributes.position.count,i=e.attributes.position.array,s=9999,o=-9999,r=9999,a=-9999,n=9999,h=-9999;for(let e=0;e<t;e++)s=Math.min(i[3*e],s),o=Math.max(i[3*e],o),r=Math.min(i[3*e+1],r),a=Math.max(i[3*e+1],a),n=Math.min(i[3*e+2],n),h=Math.max(i[3*e+2],h)}}class yt extends k{constructor(){super(),this.experience=new Nt,this.resources=this.experience.resources,this.camera=this.experience.camera.instance,this.dice_roll_index=0,this.dice_roll=[],this.pingpong=void 0,this.bgm_played=!1,this.bgm={mute:!1,volume:1},this.sfx={mute:!1,volume:1},this.resources.on("ready",(()=>{this.listener=new y.AudioListener,this.camera.add(this.listener),this.Background_Music=new y.Audio(this.listener),this.Background_Music.setBuffer(this.resources.items.bgm),this.pingpong=new y.Audio(this.listener),this.pingpong.setBuffer(this.resources.items.examples_sounds_ping_pong),this.pingpong.setLoop(!1),this.pingpong.setVolume(1);for(let e=0;e<6;e++){let t=new y.Audio(this.listener);t.setBuffer(this.resources.items[`dice_roll_${e}`]),t.setLoop(!1),t.setVolume(1),this.dice_roll.push(t)}this.flip_coin=new y.Audio(this.listener),this.flip_coin.setBuffer(this.resources.items.coinflip),this.flip_coin.setLoop(!1),this.token_effect=new y.Audio(this.listener),this.token_effect.setBuffer(this.resources.items.token_sound_effect),this.token_effect.setLoop(!1),this.axe_throw=new y.Audio(this.listener),this.axe_throw.setBuffer(this.resources.items.axe_throw),this.axe_throw.setLoop(!1),this.axe_damage=[new y.Audio(this.listener),new y.Audio(this.listener)],this.axe_damage[0].setBuffer(this.resources.items.axe_damage_0),this.axe_damage[1].setBuffer(this.resources.items.axe_damage_1),this.axe_damage.forEach((e=>{e.setLoop(!1)})),this.axe_damage.index__=0,this.axe_damage.date__=Date.now(),this.axe_block=[new y.Audio(this.listener),new y.Audio(this.listener)],this.axe_block[0].setBuffer(this.resources.items.axe_block_0),this.axe_block[1].setBuffer(this.resources.items.axe_block_1),this.axe_block.forEach((e=>{e.setLoop(!1)})),this.axe_block.index__=0,this.axe_block.date__=Date.now(),this.arrow_shot=new y.Audio(this.listener),this.arrow_shot.setBuffer(this.resources.items.arrow_shot_0),this.arrow_shot.setLoop(!1),this.arrow_shot.offset=.04,this.arrow_damage=new y.Audio(this.listener),this.arrow_damage.setBuffer(this.resources.items.arrow_damage),this.arrow_damage.setLoop(!1),this.arrow_block=new y.Audio(this.listener),this.arrow_block.setBuffer(this.resources.items.arrow_block_1),this.arrow_block.setLoop(!1),this.stone_shed=[new y.Audio(this.listener),new y.Audio(this.listener)],this.stone_shed[0].setBuffer(this.resources.items.stone_shed_2),this.stone_shed[1].setBuffer(this.resources.items.stone_shed_3),this.stone_shed.forEach((e=>{e.setLoop(!1)})),this.stone_shed.index__=0,this.stone_shed.date__=Date.now(),this.create_token=new y.Audio(this.listener),this.create_token.setBuffer(this.resources.items.create_token),this.create_token.setLoop(!1),this.steal_token=[new y.Audio(this.listener),new y.Audio(this.listener)],this.steal_token[0].setBuffer(this.resources.items.steal_token_0),this.steal_token[1].setBuffer(this.resources.items.steal_token_2),this.steal_token.forEach((e=>{e.setLoop(!1)})),this.steal_token.index__=0,this.steal_token.date__=Date.now(),this.dice_hover=[new y.Audio(this.listener),new y.Audio(this.listener),new y.Audio(this.listener),new y.Audio(this.listener),new y.Audio(this.listener),new y.Audio(this.listener)],this.dice_hover[0].setBuffer(this.resources.items.dice_hover_0),this.dice_hover[1].setBuffer(this.resources.items.dice_hover_1),this.dice_hover[2].setBuffer(this.resources.items.dice_hover_2),this.dice_hover[3].setBuffer(this.resources.items.dice_hover_3),this.dice_hover[4].setBuffer(this.resources.items.dice_hover_4),this.dice_hover[5].setBuffer(this.resources.items.dice_hover_5),this.dice_hover.forEach((e=>{e.setLoop(!1)})),this.dice_hover.index__=0,this.dice_move=[new y.Audio(this.listener),new y.Audio(this.listener)],this.dice_move[0].setBuffer(this.resources.items.dice_move_0),this.dice_move[1].setBuffer(this.resources.items.dice_move_1),this.dice_move.forEach((e=>{e.setLoop(!1)})),this.dice_move.index__=0,this.dice_move.data__=Date.now(),this.dice_take=[new y.Audio(this.listener),new y.Audio(this.listener)],this.dice_take[0].setBuffer(this.resources.items.dice_take_0),this.dice_take[1].setBuffer(this.resources.items.dice_take_1),this.dice_take.forEach((e=>{e.setLoop(!1)})),this.dice_take.index__=0,this.dice_take.date__=Date.now(),this.group_roll=[new y.Audio(this.listener),new y.Audio(this.listener),new y.Audio(this.listener),new y.Audio(this.listener),new y.Audio(this.listener),new y.Audio(this.listener)],this.group_roll[0].setBuffer(this.resources.items.group_roll_0),this.group_roll[1].setBuffer(this.resources.items.group_roll_1),this.group_roll[2].setBuffer(this.resources.items.group_roll_2),this.group_roll[3].setBuffer(this.resources.items.group_roll_3),this.group_roll[4].setBuffer(this.resources.items.group_roll_4),this.group_roll[5].setBuffer(this.resources.items.group_roll_5),this.group_roll.forEach((e=>{e.setLoop(!1)})),this.group_roll.index__=0,this.group_roll.date__=Date.now(),this.godfavor_power=[new y.Audio(this.listener),new y.Audio(this.listener)],this.godfavor_power.forEach((e=>{e.setBuffer(this.resources.items.godfavor_power),e.setLoop(!1)})),this.godfavor_power.index__=0,this.sound_thor=[new y.Audio(this.listener),new y.Audio(this.listener)],this.sound_thor.forEach((e=>{e.setBuffer(this.resources.items.sound_thor),e.setLoop(!1)})),this.sound_thor.index__=0,this.sound_victory=new y.Audio(this.listener),this.sound_victory.setBuffer(this.resources.items.Victory),this.sound_victory.setLoop(!1),this.card_landing=new y.Audio(this.listener),this.card_landing.setBuffer(this.resources.items.card_sound_landing),this.card_landing.setLoop(!1),this.card_take=new y.Audio(this.listener),this.card_take.setBuffer(this.resources.items.card_sound_take),this.card_take.setLoop(!1),this.card_throw=new y.Audio(this.listener),this.card_throw.setBuffer(this.resources.items.card_sound_throw),this.card_throw.setLoop(!1)}))}BGM_Toggle(){return this.bgm.mute=!this.bgm.mute,this.Background_Music.setVolume(this.Get_BGM_Volume()),this.bgm.mute}BGM_Set(e){this.bgm.volume=e/100,this.Background_Music.setVolume(this.Get_BGM_Volume())}SFX_Toggle(){return this.sfx.mute=!this.sfx.mute,this.sfx.mute}SFX_Set(e){this.sfx.volume=e/100}Get_BGM_Volume(){return!this.bgm.mute*this.bgm.volume*.75}Get_SFX_Volume(e){let t=0;return t="game"==window.screen_mode?1:0,e*!this.sfx.mute*this.sfx.volume*.5*t}Play_FlipCoin(){this.flip_coin.setVolume(this.Get_SFX_Volume(1)),this.flip_coin.play(0)}Play_TokenEffect(){this.token_effect.setVolume(this.Get_SFX_Volume(.4)),this.token_effect.play(0)}Play_AxeThrow(){this.axe_throw.setVolume(this.Get_SFX_Volume(.8)),this.axe_throw.play(0)}Play_AxeDamage(){if(Date.now()-this.axe_damage.date__<500)return;this.axe_damage.date__=Date.now();let e=this.axe_damage.index__;this.axe_damage[e].offset=.1,this.axe_damage[e].setVolume(this.Get_SFX_Volume(1)),this.axe_damage[e].play(0),this.axe_damage.index__++,this.axe_damage.index__==this.axe_damage.length&&(this.axe_damage.index__=0)}Play_AxeBlock(){if(Date.now()-this.axe_block.date__<500)return;this.axe_block.date__=Date.now();let e=this.axe_block.index__;this.axe_block[e].setVolume(this.Get_SFX_Volume(1)),this.axe_block[e].play(0),this.axe_block.index__++,this.axe_block.index__==this.axe_block.length&&(this.axe_block.index__=0)}Play_ArrowThrow(){this.arrow_shot.setVolume(this.Get_SFX_Volume(1)),this.arrow_shot.play(0)}Play_ArrowDamage(){this.arrow_damage.setVolume(this.Get_SFX_Volume(1)),this.arrow_damage.play(0)}Play_ArrowBlock(){this.arrow_block.setVolume(this.Get_SFX_Volume(1)),this.arrow_block.play(0)}Play_StoneShed(){if(Date.now()-this.stone_shed.date__<500)return;this.stone_shed.date__=Date.now();let e=this.stone_shed.index__;this.stone_shed[e].setVolume(this.Get_SFX_Volume(1)),this.stone_shed[e].play(.15),this.stone_shed.index__++,this.stone_shed.index__==this.stone_shed.length&&(this.stone_shed.index__=0)}Play_CreateToken(){this.create_token.setVolume(this.Get_SFX_Volume(1)),this.create_token.play(0)}Play_StealToken(){if(Date.now()-this.steal_token.date__<500)return;this.steal_token.date__=Date.now();let e=this.steal_token.index__;0==e?this.steal_token[e].setVolume(this.Get_SFX_Volume(.85)):this.steal_token[e].setVolume(this.Get_SFX_Volume(1.4)),this.steal_token[e].play(0),this.steal_token.index__++,this.steal_token.index__==this.steal_token.length&&(this.steal_token.index__=0)}Play_DiceHover(){let e=this.dice_hover.index__;this.dice_hover[e].setVolume(this.Get_SFX_Volume(1)),this.dice_hover[e].play(0),this.dice_hover.index__++,this.dice_hover.index__==this.dice_hover.length&&(this.dice_hover.index__=0)}Play_DiceMove(){if(Date.now()-this.dice_move.date__<120)return;this.dice_move.date__=Date.now();let e=this.dice_move.index__;this.dice_move[e].setVolume(this.Get_SFX_Volume(1)),this.dice_move[e].play(0),this.dice_move.index__++,this.dice_move.index__==this.dice_move.length&&(this.dice_move.index__=0)}Play_DiceTake(){if(Date.now()-this.dice_take.date__<120)return;this.dice_take.date__=Date.now();let e=this.dice_take.index__;this.dice_take[e].setVolume(this.Get_SFX_Volume(1)),this.dice_take[e].play(0),this.dice_take.index__++,this.dice_take.index__==this.dice_take.length&&(this.dice_take.index__=0)}Play_GroupRoll(){if(Date.now()-this.group_roll.date__<1500)return;this.group_roll.date__=Date.now();let e=this.group_roll.index__;this.group_roll[e].setVolume(this.Get_SFX_Volume(1)),this.group_roll[e].play(0),this.group_roll.index__++,this.group_roll.index__==this.group_roll.length&&(this.group_roll.index__=0)}Play_Victory(){this.sound_victory.setVolume(this.Get_SFX_Volume(1)),this.sound_victory.play(0)}Play_CardLanding(){this.card_landing.setVolume(this.Get_SFX_Volume(1)),this.card_landing.play(0)}Play_CardTake(){this.card_take.setVolume(this.Get_SFX_Volume(1)),this.card_take.play(0)}Play_CardThrow(){this.card_throw.setVolume(this.Get_SFX_Volume(1)),this.card_throw.play(0)}Play_GodfavorPower(){let e=this.godfavor_power.index__;this.godfavor_power[e].setVolume(this.Get_SFX_Volume(1)),this.godfavor_power[e].play(0),this.godfavor_power.index__++,this.godfavor_power.index__==this.godfavor_power.length&&(this.godfavor_power.index__=0)}Play_SoundThor(){let e=this.sound_thor.index__;this.sound_thor[e].setVolume(this.Get_SFX_Volume(1)),this.sound_thor[e].play(0),this.sound_thor.index__++,this.sound_thor.index__==this.sound_thor.length&&(this.sound_thor.index__=0)}AddSoundBuffer_Dice(e,t,i){let s=new y.Audio(this.listener);s.setBuffer(this.resources.items.dice_roll_1),s.setLoop(!1),s.setVolume(1),t.sound_play=()=>{s.setVolume(i*this.Get_SFX_Volume(1)),s.play(0)}}AddSoundBuffer(e,t,i=1){let s=new y.Audio(this.listener);s.setBuffer(this.resources.items[`${e}`]),s.setLoop(!1),s.setVolume(i),t.sound_play=()=>{s.setVolume(this.Get_SFX_Volume(1)),s.play(0)}}DeleteSoundBuffer(e){}PlayBGM(){1!=this.bgm_played&&(this.bgm_played=!0,this.Background_Music.setLoop(!0),this.Background_Music.setVolume(this.Get_BGM_Volume()),this.Background_Music.play())}StopBGM(){if(0==this.bgm_played)return;this.bgm_played=!1;let e=b.default.timeline();e.to({},{ease:"none",duration:1,onUpdate:()=>{this.Background_Music.setVolume((1-e.time())*this.Get_BGM_Volume())},onComplete:()=>{this.Background_Music.stop(),this.Background_Music.offset=0}})}DiceRolling(){let e=this.dice_roll[this.dice_roll_index];e.isPlaying,e.currentTime=.15,this.pingpong.play(0),this.dice_roll_index=(this.dice_roll_index+1)%this.dice_roll.length}GameOver(){}}const vt="https://storage.orlog.io";let wt=`<img class="img-inside-text" src="${vt}/textures/dice/Axe.png">`,bt=`<img class="img-inside-text" src="${vt}/textures/dice/Arrow.png">`,kt=`<img class="img-inside-text" src="${vt}/textures/dice/Helmet.png">`,Mt=`<img class="img-inside-text" src="${vt}/textures/dice/Shield.png">`,St=`<img class="img-inside-text" src="${vt}/textures/dice/Steal.png">`,Tt='<span class="token-text">⌘</span>';wt='<span class = "img-inside-text-wrapper">'+wt+"</span>",bt='<span class = "img-inside-text-wrapper">'+bt+"</span>",kt='<span class = "img-inside-text-wrapper">'+kt+"</span>",Mt='<span class = "img-inside-text-wrapper">'+Mt+"</span>",St='<span class = "img-inside-text-wrapper">'+St+"</span>";const Dt={axe:{en:`Deal 1 ${wt} damage`,kr:`${wt} 피해를 1 입힙니다.`},arrow:{en:`Deal 1 ${bt} damage`,kr:`${bt} 피해를 1 입힙니다.`},helmet:{en:`Block 1 ${wt} damage`,kr:`${wt} 를 1 차단합니다.`},shield:{en:`Block 1 ${bt} damage`,kr:`${bt} 를 1 차단합니다.`},steal:{en:`Steal 1 ${Tt} from the opponent`,kr:`${Tt} 를 1개 훔칩니다.`}};class At extends k{constructor(){super(),this.experience=new Nt,this.camera=this.experience.camera,this.sizes=this.experience.sizes,this.phase="Roll",this.godFavorActivation=null,this.godFavorActivation_level=null,this.sound_manager=this.experience.sound,this.notice_opacity=1,this.alert_opacity=0,this.description_opacity=0,this.infoUIdom=document.getElementsByClassName("info-ui")[0],this.infoUItextdom=document.getElementsByClassName("info-ui-txt")[0],this.topGodFavorUIDom=document.getElementById("top-player"),this.topGodFavorUItextDom=document.getElementById("top-player").children[0],this.bottomGodFavorUIDom=document.getElementById("bottom-player"),this.bottomGodFavorUItextDom=document.getElementById("bottom-player").children[0],this.scoreUIcontainer=document.getElementById("score-ui"),this.scoreUItxt=document.getElementById("score-ui-txt"),this.scoreUIchange=document.getElementById("score-ui-change-txt"),this.scoreUIchange_wrapper=document.getElementById("score-ui-change"),this.scoreUIchange_sign=document.getElementById("score-ui-change-sign"),window.addEventListener("keydown",(e=>{"ArrowDown"==e.key?this.ScoreChange(-17):"ArrowUp"==e.key&&this.ScoreChange(8)})),this.topGodFavorUIButton=[],this.bottomGodFavorUIButton=[];for(let e=0;e<3;e++){let t=this.bottomGodFavorUItextDom.children[3].children[e];this.bottomGodFavorUIButton.push(t);let i=this.topGodFavorUItextDom.children[3].children[e];this.topGodFavorUIButton.push(i)}this.r2_url="https://storage.orlog.io";var e=this.infoUIdom.children[0].children[2],t=document.createElement("img");t.classList.add("img-token"),t.src=`${this.r2_url}/textures/dice/Token.png`,t.setAttribute("crossorigin","anonymous"),e.children[1].appendChild(t.cloneNode()),e.children[3].appendChild(t.cloneNode()),e.children[4].appendChild(t.cloneNode()),e.children[5].appendChild(t.cloneNode()),e.children[7].appendChild(t.cloneNode()),e.children[10].appendChild(t.cloneNode()),this.noticeUIDom=document.getElementById("notice-ui-txt"),this.noticeUIShowKeyframe=[{opacity:0},{opacity:1,offset:.15},{opacity:1,offset:.85},{opacity:0}],this.descriptionUIDom=document.getElementById("description-ui-txt"),this.descriptionText={godfavor:"Select a God Favor, or Skip"},this.alertUIDom=document.getElementById("alert-ui-txt"),this.selectedGodFavor=null,this.godFavorInfo=null,this.activated_godFavor_level=null,this.infoUIanchor=new y.Vector3(5,0,0),this.experience.resources.on("ready",(()=>{let e=document.getElementById("top-tag"),t=document.getElementById("bottom-tag");this.tags={top:{name:e.children[0].children[1],score:e.children[1]},bottom:{name:t.children[0].children[1],score:t.children[1]}},this.clock=this.experience.world.clock,this.diceDescriptionCellDom=this.infoUItextdom.children[0].children[0],this.diceTokenDescriptioncellDom=this.infoUItextdom.children[0].children[1];let i=this.infoUItextdom.children[2].children,s=[1,3,4,5,7,10],o=["top","left","front","right","bottom","back"];this.diceBlueprintCellDoms={};for(let e=0;e<6;e++){let t=s[e],r=o[e];this.diceBlueprintCellDoms[`${r}`]={};let a=this.diceBlueprintCellDoms[`${r}`];a.weapon=i[t],a.token=i[t].children[0]}for(let e=0;e<3;e++)this.bottomGodFavorUItextDom.children[3].children[e].addEventListener("click",(()=>{let t=this.experience.controller.ObjectSelected(this.selectedGodFavor),i=t.index,s=t.avatar,o=t.info;this.activated_godFavor_level=e,this.trigger("god_favor_action",[i,e,s,o])}));this.Setup_Guide()})),this.surrender_box=document.getElementById("notice-block"),this.ui_button_surrender=document.getElementById("surrender-button"),this.ui_button_bgm=document.getElementById("bgm-button"),this.ui_button_sfx=document.getElementById("sfx-button");let i=document.getElementById("notice-buttons");this.surrender_yes=i.children[0],this.surrender_no=i.children[1],this.ui_button_surrender.children[0].addEventListener("click",(()=>{this.Surrender_On()})),this.surrender_yes.addEventListener("click",(()=>{this.experience.controller.Surrender(),this.Surrender_Off()})),this.surrender_no.addEventListener("click",(()=>{this.Surrender_Off()})),this.ui_button_bgm.children[0].addEventListener("click",(()=>{1==this.sound_manager.BGM_Toggle()?(this.ui_button_bgm.classList.remove("on"),this.ui_button_bgm.classList.add("off")):(this.ui_button_bgm.classList.remove("off"),this.ui_button_bgm.classList.add("on"))})),this.ui_button_bgm.children[1].addEventListener("input",(e=>{this.sound_manager.BGM_Set(e.target.value)})),this.ui_button_sfx.children[0].addEventListener("click",(()=>{1==this.sound_manager.SFX_Toggle()?(this.ui_button_sfx.classList.remove("on"),this.ui_button_sfx.classList.add("off")):(this.ui_button_sfx.classList.remove("off"),this.ui_button_sfx.classList.add("on"))})),this.ui_button_sfx.children[1].addEventListener("input",(e=>{this.sound_manager.SFX_Set(e.target.value)}))}get ui_scale_weight(){return.85*this.camera.ui_scale_weight}update(){}resize(){}Score_Show(){this.scoreUIcontainer.style.display="flex",this.scoreUIcontainer.animate([{opacity:0},{opacity:1}],{duration:800})}Score_Hide(){this.scoreUIcontainer.animate([{opacity:1},{opacity:0}],{duration:800}).finished.then((()=>{this.scoreUIcontainer.style.display="none"}))}ScoreViewSet(e,t){let i=Math.abs(t);this.scoreUItxt.innerText=e,this.scoreUIchange.innerText=i;let s=Math.sign(t);s>0?(this.scoreUIchange_wrapper.style.color="#00ff00",this.scoreUIchange_sign.innerText="+"):s<0&&(this.scoreUIchange_wrapper.style.color="#ff0000",this.scoreUIchange_sign.innerText="-")}ScoreChange(e){let t=this.scoreUItxt.innerText;t=parseInt(t);let i=this.scoreUIchange.innerText;i=parseInt(i);let s=[,{transform:"translateY(-3px)"},{transform:"translateY(0px)"}],o=Math.abs(e);this.scoreUIchange.innerText=o;let r=Math.sign(e);r>0?(this.scoreUIchange_wrapper.style.color="#00ff00",this.scoreUIchange_sign.innerText="+"):r<0&&(this.scoreUIchange_wrapper.style.color="#ff0000",this.scoreUIchange_sign.innerText="-");let a=1500/o;for(let e=1;e<o+1&&!(t+e*r<100&&r<0);e++)setTimeout((()=>{this.scoreUItxt.innerText=t+e*r,this.scoreUIchange.innerText=o-e,this.scoreUItxt.animate(s,{duration:80,iterations:1})}),a*e)}Surrender_On(){0==this.experience.controller.surrender&&this.surrender_box.classList.add("visible")}Surrender_Off(){this.surrender_box.classList.remove("visible")}RollDice(e,t){"roll"===this.phase&&this.clock.Light(e,t,!1)}GodFavorPowerUI_Deactivate(){null!=this.godFavorActivation&&(this.topGodFavorUItextDom.style.transform="scale(0.0)",this.godFavorActivation_level>=0&&this.topGodFavorUIButton[this.godFavorActivation_level].classList.remove("highlight")),this.godFavorActivation=null,this.godFavorActivation_level=null}GodFavorPowerUI_Activate(e,t){null!=this.godFavorActivation&&this.GodFavorPowerUI_Deactivate(),this.godFavorActivation=e,this.godFavorActivation_level=t,this.godFavorHovered(e,this.topGodFavorUItextDom,!1),this.topGodFavorUItextDom.style.transform=`scale(${this.ui_scale_weight})`,this.godFavorActivation_level>=0&&this.topGodFavorUIButton[this.godFavorActivation_level].classList.add("highlight")}click(e,t){e instanceof le&&"godfavor"==this.phase&&(this.selectedGodFavor=e,this.godFavorInfo=t,this.bottomGodFavorUItextDom.classList.add("unfold"),this.bottomGodFavorUItextDom.style.transform=`scale(${this.ui_scale_weight})`)}emptyclick(){this.bottomGodFavorUItextDom.classList.remove("unfold"),this.bottomGodFavorUItextDom.style.transform="scale(0.0)",this.selectedGodFavor=null}GameOver(e,t,i){this.noticeUIDom.innerHTML=e,this.noticeUIDom.animate(this.noticeUIShowKeyframe,{delay:200,duration:7447}),this.hideDescription(),this.ScoreViewSet(t,i),setTimeout((()=>{this.Score_Show()}),1500),setTimeout((()=>{this.ScoreChange(i)}),3e3),setTimeout((()=>{this.Score_Hide()}),6500)}viewDescriptionDuration(e,t){this.showDescription(e),setTimeout((()=>{this.hideDescription()}),1e3*t+500)}phaseEnd(e){switch(e){case"godfavor":this.hideDescription();break;case"resolution":this.activated_godFavor_level=null,this.godFavorInfo=null}}phaseStart(e){switch(this.showNotice(e),this.phase=e,e){case"godfavor":this.showPhaseChangeDescription(e);break;case"roll":this.clock.RoundEnd(),this.selectedGodFavor=null}}WriteOnNotice(e){return this.noticeUIDom.innerHTML=e,this.noticeUIDom.animate(this.noticeUIShowKeyframe,{delay:200,duration:2200}),setTimeout((()=>{}),2200)}showNotice(e){let t=e.charAt(0),i=e.slice(1),s=t.toUpperCase()+i+" phase";this.noticeUIDom.innerHTML=s,this.noticeUIDom.animate(this.noticeUIShowKeyframe,{delay:200,duration:2200})}showDescription(e){this.descriptionUIDom.innerText=e,this.descriptionUIDom.animate([{opacity:this.description_opacity},{opacity:1}],{fill:"forwards",duration:500}),this.description_opacity=1}showPhaseChangeDescription(e){this.descriptionUIDom.innerText=this.descriptionText[`${e}`],this.descriptionUIDom.animate([{opacity:0},{opacity:1}],{fill:"forwards",delay:2200,duration:500}),this.description_opacity=1}showAlert(e){this.alertUIDom.innerText=e,this.alertUIDom.animate([{opacity:this.alert_opacity},{opacity:1}],{fill:"forwards",duration:500}),this.alert_opacity=1}hideAlert(){this.alertUIDom.animate([{opacity:this.alert_opacity},{opacity:0}],{fill:"forwards",duration:500}),this.alert_opacity=0}showAlertDuration(e,t){this.showAlert(e),setTimeout((()=>{this.hideAlert()}),1e3*t+500)}hideDescription(){this.descriptionUIDom.animate([{opacity:this.description_opacity},{opacity:0}],{fill:"forwards",duration:500}),this.description_opacity=0}hover_on(e){let t=this.experience.world.gameObjects[`${e}`];null!=t&&null!=t&&(t instanceof q?"weapon"===t.diceType&&(this.diceHovered(t),this.infoUItextdom.classList.add("visible")):t instanceof le&&(null!=this.godFavorActivation_level&&this.godFavorActivation_level>=0&&this.bottomGodFavorUIButton[this.godFavorActivation_level].classList.remove("highlight"),null!=this.selectedGodFavor&&(this.selectedGodFavor=t),this.godFavorHovered(t,this.bottomGodFavorUItextDom,!0),this.bottomGodFavorUItextDom.style.transform=`scale(${this.ui_scale_weight})`))}hover_off(){this.infoUItextdom.classList.remove("visible"),0==this.bottomGodFavorUItextDom.classList.contains("unfold")&&(this.bottomGodFavorUItextDom.style.transform="scale(0.0)")}godFavorPhaseOn(){this.phase="GodFavor"}godFavorPhaseOff(){this.hover_off()}diceHovered(e){this.diceDescriptionCellDom.innerHTML=Dt[`${e.getWeapon()}`][`${window.lang_}`],e.isToken()?this.diceTokenDescriptioncellDom.style.display="block":this.diceTokenDescriptioncellDom.style.display="none";let t={axe:"Axe",shield:"Shield",arrow:"Arrow",helmet:"Helmet",steal:"StealFavor"},i=e.getFaces();Object.keys(i).forEach((s=>{let o=i[`${s}`],r=o.weaponType,a=t[`${r}`],n=this.diceBlueprintCellDoms[`${s}`];n.weapon.style.backgroundImage=`url("${this.r2_url}/textures/dice/ACV-${a}Orlog.webp")`,n.weapon.style.overflow="hidden",e.getUpDir()==s?n.weapon.style.filter="brightness(100%)":n.weapon.style.filter="brightness(30%)",o.isToken?n.token.style.visibility="visible":n.token.style.visibility="hidden"}))}godFavorHovered(e,t,i){let s=t.children[0],o=t.children[1].children[0],r=t.children[1].children[1].children[0],a=t.children[1].children[1].children[1],n=t.children[1].children[2],h=[];for(let e=0;e<3;e++){var l={};l.cost=t.children[3].children[e].children[0].children[0],l.effect=t.children[3].children[e].children[0].children[1],!0===i&&t.children[3].children[e].classList.remove("highlight"),h.push(l)}s.innerText=e.info.title[`${window.lang_}`];let c=e.info.description[`${window.lang_}`];c=this.TextConvertToIcon(c,!1),o.innerHTML=c,"en"==window.lang_?(r.innerText="Invoke : "+(e.info.afterDecision?"After ⚠️":"Before"),a.innerText="Priority : "+e.info.priority):(r.innerText="발동 : "+(e.info.afterDecision?"After ⚠️":"Before"),a.innerText="우선순위 : "+e.info.priority),null!=e.info.extraInput?n.style.display="block":n.style.display="none";for(let t=0;t<3;t++){h[t].cost.innerHTML=e.info.cost[t]+' <span class="token-text-small">⌘</span>';let i=e.info[`spec_${window.lang_}`](t);i=this.TextConvertToIcon(i,!0),h[t].effect.innerHTML=i}1==i&&null!=this.godFavorInfo&&this.godFavorInfo.avatar===e.avatar&&this.godFavorInfo.info==e.info&&!0===Number.isInteger(this.activated_godFavor_level)&&this.activated_godFavor_level>=0&&this.activated_godFavor_level<=2&&t.children[3].children[this.activated_godFavor_level].classList.add("highlight")}TextConvertToIcon(e,t=!0){let i=["ARROW","AXE","HELMET","SHIELD","STEAL"],s=["Arrow","Axe","Helmet","Shield","Steal"],o="";t&&(o="-small");for(let t=0;t<5;t++)e=e.replaceAll(`{${i[t]}}`,`<span class = "img-inside-text-wrapper${o}"><img class="img-inside-text${o}" src="${this.r2_url}/textures/dice/${s[t]}.png"></span>`);return e.replaceAll("⌘",`<span class="token-text${o}">⌘</span>`)}Setup_Guide(){let e=window.guide_page_dom.querySelector(".guide-godfavor-cards"),t=window.guide_page_dom.querySelector("#guide-godfavor-info"),i=this.experience.godFavorsInfo;const s=Object.keys(i);for(let o=0;o<20;o++){let r=document.createElement("div"),a=Ct.replace("{NAME}",s[o]);r.classList.add("guide-godfavor-cards-cell-wrapper"),r.innerHTML=a;const n={info:i[`${s[o]}`]};r.childNodes[0].addEventListener("mouseover",(e=>{t.children[0].style.transform="scale(1.0) translateX(-100%)",this.godFavorHovered(n,t.children[0],!1)})),r.childNodes[0].addEventListener("mouseout",(e=>{t.children[0].style.transform="scale(0.0) translateX(-100%)"})),r.childNodes[0].card_name_=s[o],e.appendChild(r)}}Set_Tag(e,t){this.tags.top.name.innerText=e.name,this.tags.top.score.innerText=e.score,this.tags.bottom.name.innerText=t.name,this.tags.bottom.score.innerText=t.score}}const Ct=`<img src="${vt}/textures/godfavor/map/ACV_Orlog_{NAME}.webp">`;class Pt{constructor(){this.experience=new Nt,this.scene=this.experience.scene,this.resources=this.experience.resources,this.geometry=new y.BoxGeometry(1,1,1,9,9,9),this.radius=.15,this.vertexCnt=this.geometry.attributes.position.count;let e=this.geometry.attributes.position.array,t=this.geometry.attributes.normal.array,i=this.geometry.attributes.uv.array,s=new y.Vector3,o=(new y.Vector3,new y.Vector3),r=new y.Vector3,a=new y.Vector3,n=new y.Vector3,h=[{u:new y.Vector3(0,0,-1),v:new y.Vector3(0,1,0)},{u:new y.Vector3(0,0,1),v:new y.Vector3(0,1,0)},{u:new y.Vector3(1,0,0),v:new y.Vector3(0,0,-1)},{u:new y.Vector3(1,0,0),v:new y.Vector3(0,0,1)},{u:new y.Vector3(1,0,0),v:new y.Vector3(0,1,0)},{u:new y.Vector3(-1,0,0),v:new y.Vector3(0,1,0)}],l={u:new y.Vector3,v:new y.Vector3},c={u:new y.Vector3,v:new y.Vector3},d=new y.Vector3,u=new y.Vector3(0,0,0),m=new y.Vector2,p=new y.Vector3,_=(new y.Vector3(0,0,0),new y.Vector3);for(let g=0;g<this.vertexCnt;g++){let f=Math.floor(g/(this.vertexCnt/6));switch(s.set(e[3*g],e[3*g+1],e[3*g+2]),f){case 0:o.set(1,0,0);break;case 1:o.set(-1,0,0);break;case 2:o.set(0,1,0);break;case 3:o.set(0,-1,0);break;case 4:o.set(0,0,1);break;case 5:o.set(0,0,-1)}o.set(t[3*g],t[3*g+1],t[3*g+2]),r.x=e[3*g]>0?1:-1,r.y=e[3*g+1]>0?1:-1,r.z=e[3*g+2]>0?1:-1,a.set(.5-this.radius,.5-this.radius,.5-this.radius),p.copy(r),d.copy(p.multiply(a)),l.u.copy(h[f].u),l.v.copy(h[f].v),u.copy(s),u.multiplyScalar(2*this.radius),_.copy(a),c.u.copy(h[f].u),c.v.copy(h[f].v),m.set(l.u.dot(d)+c.u.dot(u)+.5,l.v.dot(d)+c.v.dot(u)+.5),i[2*g]=m.x,i[2*g+1]=m.y,s.normalize(),e[3*g]=r.x*a.x+s.x*this.radius,e[3*g+1]=r.y*a.y+s.y*this.radius,e[3*g+2]=r.z*a.z+s.z*this.radius,a.distanceToSquared(s)<.108?n.copy(o):n.copy(s),t[3*g]=n.x,t[3*g+1]=n.y,t[3*g+2]=n.z}this.geometry.computeVertexNormals()}createMesh(){this.textures=[],this.textures.push(this.resources.items.diceArrowTexture),this.textures.push(this.resources.items.diceAxeTexture),this.textures.push(this.resources.items.diceHelmetTexture),this.textures.push(this.resources.items.diceShieldTexture),this.textures.push(this.resources.items.diceGodFavorTexture),this.textures.push(this.resources.items.diceStealTexture),this.textures.forEach((e=>{e.encoding=y.sRGBEncoding})),this.materials=[new y.MeshStandardMaterial({map:this.textures[0]}),new y.MeshStandardMaterial({map:this.textures[1]}),new y.MeshStandardMaterial({map:this.textures[2]}),new y.MeshStandardMaterial({map:this.textures[3]}),new y.MeshStandardMaterial({map:this.textures[4]}),new y.MeshStandardMaterial({map:this.textures[5]})],this.materials.forEach((e=>{e.flatShading=!1})),this.mesh=new y.Mesh(this.geometry,this.materials),this.mesh.position.y=1.5,this.mesh.receiveShadow=!0,this.scene.add(this.mesh),this.mesh.material.flatShading=!0,this.mesh.geometry.computeVertexNormals()}}let Ft=new y.CylinderGeometry(1,1,1);Ft.rotateX(Math.PI/2);class Gt{constructor(e){this.experience=new Nt,this.scene=this.experience.scene,this.world=this.experience.world,this.material_manager=this.experience.material,this.parent=e,this.Init()}get instance(){return this.effect_obj.instance}get id(){return this.effect_obj.instance.id}Init(){this.particle_params=[{fire_type:"stream",burst_cnt:null,particle_geometry:new y.TorusGeometry(.125/3,.075/3,5,16),particle_material:this.material_manager.referenceMaterial("shootingStar-particle"),particle_texture:"none",mainbody_lifetime:null,colors:[new y.Color("#00ffff"),new y.Color("#00ffff"),new y.Color("#00ffff"),new y.Color("#ffffff")],origin_position:new y.Vector3(0,0,-.5),direction_heritaged:!1,direction_theta:Math.PI/4,regen_area_type:!1,regen_area:Ft,create_interval_time:10,create_interval_time_random:0,rotation_angle_random:Math.PI/6,particle_life_time:250,particle_life_time_random:20,speed:3,speed_end:0,speed_random:.1},{fire_type:"burst",burst_cnt:40,particle_geometry:new y.BoxGeometry(.1,.1,.1),particle_material:this.material_manager.referenceMaterial("shootingStar-particle"),particle_texture:"none",mainbody_lifetime:null,colors:[new y.Color("#00dddd"),new y.Color("#88dddd")],origin_position:new y.Vector3(0,0,.5),direction_heritaged:!0,direction_theta:null,regen_area_type:!1,regen_area:new y.BoxGeometry(1,1,1,1,1,1),create_interval_time:null,create_interval_time_random:null,rotation_angle_random:Math.PI/6,particle_life_time:600,particle_life_time_random:0,speed:4.5,speed_end:0,speed_random:4}],this.effect_obj=new K(this.particle_params,[]),this.world.Add_AnimationObject(this.id,this)}Fire(){}Inactive(){this.effect_obj.Inactive("particle",0),this.effect_obj.Inactive("trail",0)}SetUpdateFilter(e,t){this.effect_obj.SetUpdateFilter(e,t)}Explode(){this.effect_obj.Burst(1),this.Destroy()}Destroy(){let e=this.effect_obj.Get_Max_Life();setTimeout((()=>{this.world.Remove_AnimationObject(this.id),this.effect_obj.Destroy()}),e)}Update(e){1==this.parent.active_&&(this.instance.position.copy(this.parent.position),this.instance.quaternion.copy(this.parent.quaternion)),this.effect_obj.Update(e)}}function Ot(e){e.layers.enable(1)}const Bt={axe:{material:"normal-weapon",geometry:"axe",setMesh:e=>{e.rotateX(Math.PI/2),Ot(e)},Action:(e,t)=>e.Throw(t),GetTarget:e=>e.GetTargetHealthStone("axe",!0),AnimationShooting:function(e,t,i,s){let o=new y.Vector3(0,1.5,-1.5);e.localToWorld(o);let r=t.clone(),a=o.clone().sub(r).normalize().multiplyScalar(.6);r.add(a),a.normalize();let n={value:0};return i.to(e.position,{duration:.3,ease:"Power2.easeOut",x:o.x,y:o.y,z:o.z}).to(n,{duration:.3,ease:"Power2.easeOut",value:1,onUpdate:()=>{e.rotateX(-.05*(1-n.value))}},"<").to(e.position,{duration:.35,ease:"none",x:r.x,y:r.y,z:r.z,onStart:()=>{s.Play_AxeThrow()},onUpdate:()=>{e.rotateX(.35)},onComplete:()=>{e.lookAt(t),e.rotateX(Math.PI/4)}}),i}},arrow:{material:"normal-weapon",geometry:"arrow",setMesh:e=>{Ot(e)},Action:(e,t)=>e.Throw(t),GetTarget:e=>e.GetTargetHealthStone("arrow",!0),AnimationShooting:function(e,t,i,s){let o=new y.Vector3(0,.5,-.5);e.localToWorld(o);let r=t.clone(),a=o.clone().sub(r).normalize().multiplyScalar(.5);return r.add(a),i.to(e.position,{duration:.3,ease:"Power2.easeOut",x:o.x,y:o.y,z:o.z}).to(e.position,{duration:.25,ease:"Power3.easeIn",x:r.x,y:r.y,z:r.z,onStart:()=>{s.Play_ArrowThrow()}})}},mjolnir:{material:"mjolnir",geometry:"mjolnir",setMesh:e=>{Ot(e)},Action:(e,t)=>e.Throw(t),GetTarget:e=>e.GetTargetHealthStone("godfavor",!0),AnimationShooting:(e,t,i,s)=>{let o=new y.Vector3(0,.5,-.5);e.localToWorld(o);let r=t.clone(),a=o.clone().sub(r).normalize().multiplyScalar(.5);return r.add(a),i.to(e.position,{duration:.65,ease:"none",x:r.x,y:r.y,z:r.z})},effects:function(e){return new Gt(e)}},helmet:{material:"normal-weapon",geometry:"helmet",setMesh:e=>{Ot(e)},Action:(e,t,i)=>(i.eventEmitter.trigger(`${i.index}-block-axe`),e.AnimationAppearance()),Action_End:(e,t,i)=>{i.Play_AxeBlock(),t.eventEmitter.trigger(`${t.index}-block-axe-anim`,[e.GetPosition()])}},shield:{material:"normal-weapon",geometry:"shield",setMesh:e=>{Ot(e)},Action:(e,t,i)=>(i.eventEmitter.trigger(`${i.index}-block-arrow`),e.AnimationAppearance()),Action_End:(e,t,i)=>{i.Play_ArrowBlock(),t.eventEmitter.trigger(`${t.index}-block-arrow-anim`,[e.GetPosition()])}},steal:{material:"steal",geometry:"steal",setMesh:()=>{},Action:(e,t,i)=>{let s=e.mesh,o=i.GetNextTokenPosition(),r=e.AnimationAppearance();e.AnimationShooting(s,t,r),r.add(e.AnimationDisappearance(.45,0)),r.add(t.slideMove(o),"<"),r.addLabel("moveend","-=0.6");let a=i.AddOtherToken(t);return r.add(a.Appear(o),"moveend"),r},GetTarget:(e,t)=>t.Check_Token_FreeSpace()?e.GetTargetToken():null,AnimationShooting:(e,t,i,s)=>{let o=t.GetPosition().clone();return i.to(e.position,{duration:.4,ease:"none",x:o.x,y:o.y,z:o.z})}},"health-stone":{material:"health-stone",geometry:"health-stone",setMesh:e=>{let t=Math.random()-.5;e.rotateY(t)},Action:e=>{}}};class It{constructor(){this.experience=new Nt,this.materialManager=this.experience.material,this.geometryManager=this.experience.geometry,this.scene=this.experience.scene}CreateModel(e){let t=this.geometryManager.getGeometry(Bt[`${e}`].geometry),i=this.materialManager.getMaterial(Bt[`${e}`].material),s=null;return"steal"===e?(s=new y.Sprite(i),s.renderOrder=5):s=new y.Mesh(t,i),Bt[`${e}`].setMesh(s),this.scene.add(s),s.AnimationShooting=Bt[`${e}`].AnimationShooting,s.GetTarget=Bt[`${e}`].GetTarget,s.Action=Bt[`${e}`].Action,s.Action_End=Bt[`${e}`].Action_End,s.active_=!0,Bt[`${e}`].effects&&(s.effects=Bt[`${e}`].effects.call(this,s)),s}}const Et=[0,0,1,1,0,1];let Vt=["top","bottom"];const Rt=["Baldr","Bragi","Brunhild","Freyja","Freyr","Frigg","Heimdall","Hel","Idun","Loki","Mimir","Odin","Skadi","Skuld","Thor","Thrymr","Tyr","Ullr","Var","Vidar"];class zt{constructor(){this.experience=new Nt,this.physics=this.experience.physics,this.ui=this.experience.ui,this.inputAdmin,this.camera=this.experience.camera,this.sound=this.experience.sound,this.extraPickedDiceCnt=-1,this.double_cube=null,this.surrender=!1,this.avatars={top:{},bottom:{},get 0(){return this[`${Vt[0]}`]},get 1(){return this[`${Vt[1]}`]}},this.godFavorCards,this.godFavorCardsState=[],this.chosenGodFavorCardsCnt=0,this.messageQueue=[],this.caller={StartRound:(...e)=>{this._StartRound(...e)},ResetRound:(...e)=>{this._ResetRound(...e)},InitialGame:(...e)=>{this._InitialGame(...e)},Liberty:(...e)=>{this._Liberty(...e)},Draft:(...e)=>{this._Draft(...e)},BanPickCardMove:(...e)=>{this._BanPickCardMove(...e)},SpecialRollDices:(...e)=>{this._RollDices(...e)},RollDices:(...e)=>{this._RollDices(...e)},DicesToWaiting:(...e)=>{this._DicesToWaiting(...e)},SetDiceFormation:(...e)=>{this._SetDiceFormation(...e)},GetToken:(...e)=>{this._GetToken(...e)},GetToken_Modern:(...e)=>{this._GetToken_Modern(...e)},DiceBattle:(...e)=>{this._DiceBattle(...e)},Sleep:(...e)=>{this._Sleep(...e)},PhaseChange:(...e)=>{this._PhaseChange(...e)},WaitForEmpty:(...e)=>{this._WaitForEmpty(...e)},PickGodfavor:(...e)=>{this._PickGodfavor(...e)},ChooseDice:(...e)=>{this._ChooseDice(...e)},CancleDice:(...e)=>{this._CancleDice(...e)},ClickDice:(...e)=>{this._ClickDice(...e)},ClickDice_Token:(...e)=>{this._ClickDice_Token(...e)},ExtraClickDice:(...e)=>{this._ExtraClickDice(...e)},NeedSwap:(...e)=>{this._NeedSwap(...e)},SelectGodFavorPower:(...e)=>{this._SelectGodFavorPower(...e)},GodFavorAction:(...e)=>{this._GodFavorAction(...e)},GodFavorExtraAction:(...e)=>{this._GodFavorExtraAction(...e)},BanDices:(...e)=>{this._BanDices(...e)},GameStart:(...e)=>{this._GameStart(...e)},GameOver:(...e)=>{this._GameOver(...e)},CheckReady:(...e)=>{this._CheckReady(...e)},BellPush:(...e)=>{this._BellPush(...e)},ExtraInputBegin:(...e)=>{this._ExtraInputBegin(...e)},DoubleGame:(...e)=>{this._DoubleGame(...e)},Ragnarok:(...e)=>{this._Ragnarok(...e)},Frostbite:(...e)=>{this._Frostbite(...e)},UserTag:(...e)=>{this._UserTag(...e)}},this.stopTimer=["BanPickCardMove","GameStart","DicesToWaiting","PhaseChange","GodFavorExtraAction"],this.callbacksOnRoundReset=[],this.godFavorExtraAction=null,this.state=!1,this.phase="roll",this.game_mode,this.eventEmitter=new k,this.banned_card={authorization:!1,index:-1,instance:null},this.picked_card={authorization:!1,index:-1,instance:null},this.banned_card_cnt=0,this.picked_card_cnt=[0,0],this.no_signal_callback=null,this.experience.resources.on("ready",(()=>{this.time=this.experience.time,this.debug=this.experience.debug,this.setDebug()}))}MessageEnqueue(e,t,i){if("ForceSync"==e)this.ForceSync(...t);else{let s=new k;t.push(s),this.messageQueue.push({func:e,params:t,timer:i})}}MessageDequeue(){if(this.messageQueue.length>0){let e=this.messageQueue.shift();this.state=!1,null!=this.no_signal_callback&&(clearTimeout(this.no_signal_callback),this.no_signal_callback=null),e.timer>0&&(this.ui.hideAlert(),this.time.SetTimer(e.timer,!1)),this.stopTimer.includes(e.func)&&this.experience.time.StopTimer(),this.caller[`${e.func}`](...e.params)}}ClearMessageQueue(){this.messageQueue.length=0}update(){this.EventLoop()}EventLoop(){1==this.state&&this.MessageDequeue()}FinishGame(e){this.state=!0}_GameStart(e,t,i){let s=new Promise((e=>{e(0)}));"liberty"!=t&&"draft"!=t||(s=this.SetupTable()),s.then((()=>{this.phase="roll",this.state=!0,this.avatars[`${Vt[0]}`].eventEmitter=this.eventEmitter,this.avatars[`${Vt[0]}`].index=0,this.avatars[`${Vt[0]}`].InitialGame(e.player[0]),this.experience.world.AddThing(this.avatars[`${Vt[0]}`],e.player[0],Vt[0]),this.avatars[`${Vt[1]}`].eventEmitter=this.eventEmitter,this.avatars[`${Vt[1]}`].index=1,this.avatars[`${Vt[1]}`].InitialGame(e.player[1]),this.experience.world.AddThing(this.avatars[`${Vt[1]}`],e.player[1],Vt[1]),this.experience.world.GameStart()}))}_GameOver(e,t,i){let s,o;this.ClearMessageQueue(),"bottom"==Vt[e]?(s="WIN",o=window.PageAdmin.ChangeScore_Single(t,i)):"top"==Vt[e]?(s="DEFEAT",o=window.PageAdmin.ChangeScore_Single(-t,i),t=-t):s="DRAW",this.ui.GameOver(s,o,t),this.experience.GameOver(),this.sound.StopBGM(),this.sound.Play_Victory(),setTimeout((()=>{this.AfterGameOver()}),8300)}AfterGameOver(){this._ResetRound(),setTimeout((()=>{this.godFavorExtraAction=null,this.phase="roll",this.camera.IsometricView(),this.avatars[0].GameOver(),this.avatars[1].GameOver(),this.state=!1,this.experience.world.GameOver(),this.surrender=!1,Vt=["top","bottom"]}),2e3)}Clear(){}_NeedSwap(){Vt[0]="bottom",Vt[1]="top",this.flipCoin.PlayerSwap(),this.state=!0}_SelectGodFavorCard(e){}_PhaseChange(e,t,i){"resolution"===t&&(i.forEach(((e,t)=>{-1!=e.godfavorIndex&&setTimeout((()=>{this.avatars[`${Vt[t]}`].godFavors[e.godfavorIndex].Highlight_On()}),1e3)})),this.double_cube.StartResolutionPhase()),this.ui.phaseEnd(e),this.ui.phaseStart(t),this.phase=t,this.avatars.top.PhaseStart(this.phase),this.avatars.bottom.PhaseStart(this.phase),setTimeout((()=>{this.state=!0}),1500)}OrganizeTable(e){return this.avatars.top.OrganizeTable(),this.avatars.bottom.OrganizeTable(),this.experience.world.SetupTable(),this.experience.world.ArrangeCards(e)}SetupTable(){return new Promise((e=>{this.ui.hideDescription(),this.ui.showAlertDuration("Ban & Pick Complete",2.5),setTimeout((()=>{e(1)}),2500)})).then((()=>this.experience.world.OrganizeCards())).then((()=>{this.avatars.top.SetupTable(),this.avatars.bottom.SetupTable(),this.experience.world.OrganizeTable(),this.camera.IsometricView()}))}_InitialGame(e,t,i,s){this.callbacksOnRoundReset=[],this.banned_card_cnt=0,this.picked_card_cnt=[0,0],this.phase="roll",this.game_mode=i,this.game_style=s,this.eventEmitter.reset(),this.inputAdmin.InitialGame(),this.flipCoin.SetFirstPlayer(t),this.experience.world.clock.Turn_Toggle(Vt[t]),this.avatars[`${Vt[0]}`].eventEmitter=this.eventEmitter,this.avatars[`${Vt[0]}`].index=0,this.avatars[`${Vt[0]}`].InitialGame(e.player[0]),this.avatars[`${Vt[1]}`].eventEmitter=this.eventEmitter,this.avatars[`${Vt[1]}`].index=1,this.avatars[`${Vt[1]}`].InitialGame(e.player[1]),this.godFavorCards=this.experience.world.godFavors.bottom,this.godFavorCardsState=new Array(Object.keys(this.godFavorCards).length).fill("tray"),this.chosenGodFavorCardsCnt=0,this.flipCoin.Flip(t,1).then((()=>{let e=`${Vt[t]} player is First`;switch(this.ui.viewDescriptionDuration(e,1.5),i){case"constant":this.Ready_Constant();break;case"liberty":this.Ready_Liberty();break;case"draft":this.Ready_Draft()}}))}Ready_Constant(){this.phase="roll",setTimeout((()=>{this.state=!0}),1500)}Ready_Liberty(){this.phase="cardselect",new Promise((e=>{setTimeout((()=>{e(1)}),2300)})).then((()=>(this.camera.Topview(),this.OrganizeTable("liberty")))).then((()=>(this.state=!0,null)))}Ready_Draft(){this.phase="cardselect",new Promise((e=>{setTimeout((()=>{e(1)}),2300)})).then((()=>(this.camera.Topview(),this.OrganizeTable("draft")))).then((()=>(this.state=!0,this.ui.WriteOnNotice("Pick & Ban"))))}PrepareCard(e){setTimeout((()=>{setTimeout((()=>{this.camera.Topview().then((()=>this.OrganizeTable())).then((()=>(this.inputAdmin.Trigger({trigger:"CardSelect"}),this.state=!0,this.ui.WriteOnNotice("Pick & Ban"))))}),2300)}),1e3)}_StartRound(){setTimeout((()=>{this.sound.PlayBGM(),this.state=!0}),750)}_DiceBattle(e,t,i){this.ui.GodFavorPowerUI_Deactivate();let s=async function(e,t,i,s){let o=i[0],r=i[1],a=s[`${i[0]}`],n=s[`${i[1]}`],h=a.GetDiceMarks(),l=n.GetDiceMarks(),c=a.GetSortedDiceForBattle(),d=0,u=n.GetSortedDiceForBattle(),m=0,p=0,_=0,g=[],f=[];setTimeout((()=>{g.forEach((e=>{e.Destroy()})),f.forEach((e=>{e.Destroy()}))}),3e4),h.forEach((e=>{let t=e.InstantiateWeapon();g.push(t)})),l.forEach((e=>{let t=e.InstantiateWeapon();f.push(t)}));let x=0,y=0,v=[],w=!1;for(let i=0;i<6;i++){let s,b,k,M,S,T,D,A,C,P,F,G;0==Et[i]?(k=g,M=f,s=0,b=1,S=x,T=y,D=a,A=n,C=h,P=l,F=o,G=r):(k=f,M=g,s=1,b=0,S=y,T=x,D=n,A=a,C=l,P=h,F=r,G=o);let O=e[s][i][0],B=(e[b][i][0],[]);for(;O>0;O--){let e=M[T].GetPosition(),t=k[S].GetPosition();C[S].TurnOnLight(),P[T].TurnOnLight(),B.push(k[S].Action(e)),B.push(M[T].Action(t,A)),S++,T++}await Promise.all(B).then((e=>{e.forEach((e=>{v.push(e())}))})),w&&(w=!1,await new Promise((e=>{setTimeout((()=>{e(!0)}),220)}))),T+=e[b][i][1];let I=e[s][i][1],E=[],V=S+(I-1);for(;I>0;I--){let e=k[V].GetTarget(A,D);null!=e&&(C[V].TurnOnLight(),E.push(k[V].Action(e,D))),V--,S++}if(await Promise.all(E).then((e=>{e.forEach((e=>{v.push(e())}))})),A.GetHealth()<=0)return F;w&&(w=!1,await new Promise((e=>{setTimeout((()=>{e(!0)}),220)})));let R=t[0][i][0]+t[0][i][1],z=t[1][i][0]+t[1][i][1];for(let e=0;e<R;e++){let e=c[d];null==a.DiceToActionEnd(e,d-p)&&p++,d++}for(let e=0;e<z;e++){let e=u[m];null==n.DiceToActionEnd(e,m-_)&&_++,m++}0==Et[i]?(x=S,y=T):(y=S,x=T)}return await Promise.all(v),g.forEach((e=>{e.Destroy()})),f.forEach((e=>{e.Destroy()})),"none"}(e,i,t,this.avatars);s.then((e=>{this.state=!0}))}_ResetRound(){this.ui.GodFavorPowerUI_Deactivate(),this.ui.phaseEnd("resolution"),this.eventEmitter.reset(),setTimeout((()=>{this.callbacksOnRoundReset.forEach((e=>{e()})),this.flipCoin.FlyToNextAnchor(),this.state=!0,this.callbacksOnRoundReset=[]}),400),this.avatars.top.ResetRound(),this.avatars.bottom.ResetRound(),this.inputAdmin.ResetRound(),this.double_cube.ResetRound(),this.godFavorExtraAction=null}_PickGodfavor(e,t){let i=Rt[e],s=this.godFavorCards[`${i}`],o=this.godFavorCardsState[e];switch(this.game_mode){case"liberty":this._PickGodfavor_Liberty(e,o,s);break;case"draft":this._PickGodfavor_Draft(e,o,s,t)}}_PickGodfavor_Liberty(e,t,i){let s=null;switch(t){case"tray":this.chosenGodFavorCardsCnt<3&&(this.godFavorCardsState[e]="chosen",s=i.moveSlide(2),this.chosenGodFavorCardsCnt++);break;case"chosen":this.godFavorCardsState[e]="tray",s=i.moveSlide(-2),this.chosenGodFavorCardsCnt--}null!=s?s.then((()=>this.state=!0)):this.state=!0}_PickGodfavor_Draft(e,t,i,s){"waiting"!=t&&(s?this._PickGodfavor_Draft_Ban(e,t,i):this._PickGodfavor_Draft_Pick(e,t,i))}_PickGodfavor_Draft_Pick(e,t,i){if(this.state=!0,!this.picked_card.authorization)return;if("waiting"==i.state||"banned_sign"==i.state)return;this.banned_card.index==e&&(this.banned_card.instance.Ban_Off(),this.banned_card.instance.state="tray",this.banned_card.index=-1,this.banned_card.instance=null);let s=this.picked_card.index;-1!=this.picked_card.index&&(this.picked_card.instance.Highlight_Off(),this.picked_card.instance.state="tray",this.picked_card.index=-1,this.picked_card.instance=null),s!=e&&(i.Highlight_On(),i.state="chosen",this.picked_card.index=e,this.picked_card.instance=i)}_PickGodfavor_Draft_Ban(e,t,i){if(this.state=!0,!this.banned_card.authorization)return;if("waiting"==i.state||"banned_sign"==i.state)return;this.picked_card.index==e&&(this.picked_card.instance.Highlight_Off(),this.picked_card.instance.state="tray",this.picked_card.index=-1,this.picked_card.instance=null);let s=this.banned_card.index;-1!=this.banned_card.index&&(this.banned_card.instance.Ban_Off(),this.banned_card.instance.state="tray",this.banned_card.index=-1,this.banned_card.instance=null),s!=e&&(i.Ban_On(),i.state="banned",this.banned_card.index=e,this.banned_card.instance=i)}_Liberty(){this.experience.world.clock.Turn_Toggle("bottom"),this.ui.WriteOnNotice("Free Choice"),setTimeout((()=>{this.ui.showDescription("Select 3 God favor cards."),this.inputAdmin.Trigger({trigger:"CardSelect"}),this.state=!0}),2500)}_Draft(e,t,i,s){let o;this.inputAdmin.Trigger({trigger:"Draft",user:Vt[e]}),o=0==t?"Ban (right click)":6==t?"Pick (left click)":"Ban (right click) & Pick (left click)","bottom"==Vt[e]?(this.picked_card.index=-1,this.banned_card.index=-1,this.picked_card.instance=null,this.banned_card.instance=null,this.picked_card.authorization=i,this.banned_card.authorization=s,this.ui.showDescription(`Select for ${o}`)):this.ui.showDescription(`Opponent in ${o}`),this.state=!0}_BanPickCardMove(e,t,i){this.ui.hideDescription();let s=Vt[1-e];this.experience.world.clock.Turn_Toggle(s);let o=Vt[e],r=new Promise((e=>{e(1)}));null!=t&&(r=this.experience.world.CardPickMove(o,t,this.picked_card_cnt[e]),this.picked_card_cnt[e]++);let a=new Promise((e=>{null!=i?r.then((()=>{let t=this.experience.world.CardBanMove(o,i,this.banned_card_cnt);this.banned_card_cnt++,t.then((()=>{e(1)}))})):e(1)}));Promise.all([r,a]).then((()=>{this.state=!0}))}_ChooseDice(e,t){this.avatars[`${e}`].ChooseDice(t,this.phase).then((()=>{this.state=!0}))}_CancleDice(e,t){this.avatars[`${e}`].CancleDice(t).then((()=>{this.state=!0}))}_ClickDice(e,t){this.avatars[`${e}`].ClickDice(t,this.phase).then((e=>{this.state=!0}))}_ClickDice_Token(e,t){this.avatars[`${e}`].ClickDice_Token(t,this.phase).then((e=>{this.state=!0}))}_ExtraClickDice(e,t){let i=this.avatars[`${e}`].GetDiceState(t);if("waiting"===i){if(this.extraPickedDiceCnt<=0)return void(this.state=!0);this.extraPickedDiceCnt--}else"levitation"===i&&this.extraPickedDiceCnt++;this._ClickDice(e,t)}_RollDices(e,t,i,s){let o;o="top"==Vt[e]?0:1;let r=Math.floor(this.inputAdmin.rollDicesCnt/2);this.ui.RollDice(Vt[e],r),"roll"==this.phase&&this.experience.world.clock.Turn_Toggle(Vt[e]);let a=i;null!=s[0]&&a++,null!=s[1]&&a++,this.GetRollDicesSimulation(a,e).then((i=>{!function(e){let t,i=e.length;for(;0!=i;)t=Math.floor(Math.random()*i),i--,[e[i],e[t]]=[e[t],e[i]]}(i);let o=this.avatars[`${e}`].RollDices(t,i,s);Promise.all(o).then((()=>{this.state=!0,this.inputAdmin.Trigger({trigger:"RollDice",user:Vt[e],game_style:this.game_style})}))}))}_ExtraInputDice(e,t,i){}_ExtraInputHealth(){}GetAvatarsIndex(){return Vt}_BanDices(e,t){this.avatars[e].BanDices(t).then((()=>{this.state=!0}))}_GodFavorExtraAction(e){this.ui.hideDescription(),null!=this.godFavorExtraAction?this.godFavorExtraAction(e).then((()=>{this.state=!0})):this.state=!0}_SelectGodFavorPower(){this.experience.world.clock.Turn_Toggle("bottom"),this.inputAdmin.Trigger({trigger:"GodFavor"}),this.state=!0}_GodFavorAction(e){let t,i=e.user,s=e.level,o=e.godfavorIndex,r=this.avatars[i],a=this.avatars[1-i],n=r.godFavors[o];this.ui.GodFavorPowerUI_Activate(n,s),r.tokens.length>=e.cost_?(r.SpendToken(e.cost_),s>=0?(this.sound.Play_GodfavorPower(),t=n.power(s,r,a,e),n.extraPower&&(this.godFavorExtraAction=t=>n.extraPower(s,r,a,e,t)),t.then((e=>{e&&(e[0]&&this.callbacksOnRoundReset.push(...e[0]),e[1]&&e[1].forEach((e=>{this.cb=e,this.cb()}))),this.state=!0}))):(t=n.Blink(),t.then((()=>{this.state=!0})))):(t=n.Blink(),t.then((()=>{this.state=!0})))}GetRollDicesSimulation(e,t){return this.physics.DiceRollSimulation(e,this.avatars[`${t}`].anchorSign)}GetDiceState(e,t){return this.avatars[e].dices[t].GetDiceState()}_DicesToWaiting(e,t,i){let s=this.avatars[`${e}`].DicesToWaiting(t,i);Promise.all(s).then((()=>{this.state=!0}))}_SetDiceFormation(e,t){let i=[...this.avatars[`${e[0]}`].SetDiceFormation(t[0],this.game_style),...this.avatars[`${e[1]}`].SetDiceFormation(t[1],this.game_style)];Promise.all(i).then((()=>{this.state=!0}))}_GetToken(e,t){let i=[];0==t[0].length&&0==t[1].length||this.sound.Play_CreateToken(),e.forEach(((e,s)=>{let o=this.avatars[`${e}`].GetToken(t[s]);i.push(...o)})),Promise.all(i).then((()=>{this.state=!0}))}_GetToken_Modern(e){let t=Vt[0],i=Vt[1],s=[this.avatars[`${t}`].GetToken_Modern(e[0]),this.avatars[`${i}`].GetToken_Modern(e[1])];Promise.all(s).then((()=>{this.state=!0}))}__checkSelectedObject(e){let t=this.experience.world.checkSelectedObject(e),i=this.avatars.top.checkSelectedObject(e),s=this.avatars.bottom.checkSelectedObject(e);return null!=t||null!=t?t:null!=i||null!=i?(i.avatar="top"==Vt[0]?0:1,i.isBottom=!1,i):null!=s||null!=s?(s.avatar="bottom"==Vt[0]?0:1,s.isBottom=!0,s):null}__FindFromDictionary(e){let t=this.experience.world.FindFromDictionary(e),i=this.avatars.top.FindFromDictionary(e),s=this.avatars.bottom.FindFromDictionary(e);return null!=t||null!=t?t:null!=i||null!=i?(i.avatar="top"==Vt[0]?0:1,i.isBottom=!1,i):null!=s||null!=s?(s.avatar="bottom"==Vt[0]?0:1,s.isBottom=!0,s):null}ObjectSelected(e){return this.__checkSelectedObject(e)}EnableExtraInputDice(e){"bottom"==e.user?(this.inputAdmin.TurnOffAmbigious(e),this.ui.showDescription(this.experience.godFavorsNotice[`${e.godfavor}`])):this.ui.showDescription("Wait for opponent's input")}_Sleep(e){setTimeout((()=>{this.state=!0}),e)}_WaitForEmpty(){this.state=!0}CreateItem(e,t){if("dice"===e)return this.experience.world.CreateDice(t)}GetPhase(){return this.phase}GetAvatarsInfo(){return[this.avatars[0].GetAvatarInfo(),this.avatars[1].GetAvatarInfo()]}SetExtraPickedDiceCnt(e){this.extraPickedDiceCnt=e}_CheckReady(){this.state=!0,this.experience.SendCheck(),this.no_signal_callback=setTimeout((()=>{this.ui.showAlert("No signal from opponent")}),2500)}_BellPush(){this.experience.mouseManager.BellPush(!0),this.state=!0}_ExtraInputBegin(){this.state=!0}_DoubleGame(e,t){this.inputAdmin.DeactivateDoubleCube(),this.double_cube.DoubleGame(Vt[e],t),this.state=!0}_Ragnarok(){this.ui.WriteOnNotice("Ragnarok"),setTimeout((()=>{this.state=!0}),2500)}_Frostbite(e,t){let i=Vt[e];this.experience.world.Take_FrostBite(i,t).then((()=>{this.state=!0}))}_UserTag(e,t,i,s){let o,r,a={name:e,score:i},n={name:t,score:s};"top"==Vt[0]?(o=a,r=n):(o=n,r=a),this.ui.Set_Tag(o,r),this.state=!0}ForceSync(e){this.avatars[0].ForceSync(e.player[0]),this.avatars[1].ForceSync(e.player[1]),this.state=!0}Surrender(){0==this.surrender&&(this.experience.Surrender(),this.surrender=!0)}_DBG_RollDices(){this._RollDices(1,["right","left","top","bottom","front","back"],6,[null,null])}_DBG_ForceSync(){this.ForceSync(this.situation_config)}_DBG_InitialGame(){this.experience.online={active:!0},this.avatars[0].eventEmitter=this.eventEmitter,this.avatars[0].index=0,this.avatars[0].InitialGame(this.situation_config.player[0]),this.avatars[1].eventEmitter=this.eventEmitter,this.avatars[1].index=1,this.avatars[1].InitialGame(this.situation_config.player[1])}setDebug(){if(this.debug.active){this.situation_config={turnNum:0,phase:"roll",order:0,player:[]};let e={health:15,token:0,dices:[],godFavors:[0,1,2]},t={dir:"up",state:"tray"};this.situation_config.player=[JSON.parse(JSON.stringify(e)),JSON.parse(JSON.stringify(e))];for(let e=0;e<6;e++)this.situation_config.player[0].dices.push(JSON.parse(JSON.stringify(t))),this.situation_config.player[1].dices.push(JSON.parse(JSON.stringify(t)));this.debugFolder=this.debug.ui.addFolder("controller"),this.debugFolder.add(this,"_DBG_InitialGame").name("InitialGame"),this.debugFolder.add(this,"_DBG_ForceSync").name("ForceSync"),this.debugFolder.add(this,"_DBG_RollDices").name("RollDices"),this.debugFolder.add(this.situation_config,"turnNum",0,5,1),this.debugFolder.add(this.situation_config,"phase",["roll","godfavor","resolution"]),this.debugFolder.add(this.situation_config,"order",0,1,1);let i=["right","left","top","bottom","front","back"],s=["tray","waiting","ban"];this.debugFolder_avatar=[this.debug.ui.addFolder("Avatar 0"),this.debug.ui.addFolder("Avatar 1")];for(let e=0;e<2;e++){this.debugFolder_avatar[e].add(this.situation_config.player[e],"health",1,15,1).name(`hp-${e}`),this.debugFolder_avatar[e].add(this.situation_config.player[e],"token",0,50,1).name(`token-${e}`);for(let t=0;t<6;t++)this.debugFolder_avatar[e].add(this.situation_config.player[e].dices[t],"dir",i).name(`dir-${t}`),this.debugFolder_avatar[e].add(this.situation_config.player[e].dices[t],"state",s).name(`dir-${t}`)}}}}class $t{constructor(){this.socket,this.game,this.messageQueue=[],this.state=!0,this.flag=[!1,!1]}MessageEnqueue(e,t){let i=!1;"InitialGame"!=e&&"GameStart"!=e||(i=!0);let s=JSON.stringify([e,t]);this.messageQueue.push({needSync:i,data:s}),this.MessageDequeue()}MessageDequeue(){if(this.state&&0!=this.messageQueue.length)if(1==this.messageQueue[0].needSync)this.messageQueue[0].needSync=!1,this.socket.send(JSON.stringify(["CheckReady",[]])),this.flag[0]=!1,this.flag[1]=!1,this.state=!1;else for(;this.messageQueue.length>0;){let e=this.messageQueue.shift();this.socket.send(e)}}WorkComplete(e){this.flag[e]=!0,this.flag[0]&&this.flag[1]&&(this.state=!0,this.flag[0]=!1,this.flag[1]=!1),this.MessageDequeue()}Transport(e,t){let i=JSON.parse(e),s={func:i[0],params:i[1]};"CheckReady"==func?this.WorkComplete(t):this.game.MessageEnqueue(s.func,s.params)}}class jt{constructor(){this.socket,this.controller}MessageEnqueue(e,t){let i=JSON.stringify([e,t]);this.socket.send(i)}Transport(e){let t=JSON.parse(e),i={func:t[0],params:t[1],timer:t[2]};"GameOver"==i.func&&this.socket.send("Check_GameOver"),this.controller.MessageEnqueue(i.func,i.params,i.timer)}}class Ut{constructor(){this.othersocket,this.partnerbird}send(e){this.othersocket.onmessage(e)}onmessage(e){this.partnerbird.Transport(e)}}class Lt{constructor(){this.experience=new Nt,this.debug=this.experience.debug,this.controller=this.experience.controller,this.setDebug()}setDebug(){if(this.debug.active){this.situationViewerDom=document.getElementById("situation-viewer"),this.situationViewerHeader=document.getElementById("situation-header"),this.situationViewerTop=document.getElementById("situation-top"),this.situationViewerBottom=document.getElementById("situation-bottom");let e=["top","bottom"];this.info={top:{turnOndiceColor:()=>{this._DBG_TurnOnDiceColor("top")},turnOffdiceColor:()=>{this._DBG_TurnOffDiceColor("top")},turnOnFaceColor:()=>{this._DBG_TurnOnFaceColor("top")},turnOffFaceColor:()=>{this._DBG_TurnOffFaceColor("top")}},bottom:{turnOndiceColor:()=>{this._DBG_TurnOnDiceColor("bottom")},turnOffdiceColor:()=>{this._DBG_TurnOffDiceColor("bottom")},turnOnFaceColor:()=>{this._DBG_TurnOnFaceColor("bottom")},turnOffFaceColor:()=>{this._DBG_TurnOffFaceColor("bottom")}}},e.forEach((e=>{this.debugFolder=this.debug.ui.addFolder(`${e}`),this.debugFolder.add(this.info[`${e}`],"turnOndiceColor").name("[Visual] Turn On Dice Color"),this.debugFolder.add(this.info[`${e}`],"turnOffdiceColor").name("[Visual] Turn Off Dice Color"),this.debugFolder.add(this.info[`${e}`],"turnOnFaceColor").name("[Visual] Turn On Face Color"),this.debugFolder.add(this.info[`${e}`],"turnOffFaceColor").name("[Visual] Turn Off Face Color")}))}}printSituation(e,t){let i="";if("object"==typeof e)for(const[s,o]of Object.entries(e))i+=`\n${t}${s} : `,i+=this.printSituation(o,t+"　　"),i+=" ";else if(Array.isArray(e))e.forEach((e=>{i+=this.printSituation(e,t+", ")}));else if("function"!=typeof e)return e;return i}_DBG_ConsoleReset(){this.situationViewerHeader.innerText=`\n            phase : ${superVisor.Situation.phase}\n            turnNum : ${superVisor.Situation.turnNum}\n            order : ${superVisor.Situation.order}\n        `,this.situationViewerTop.innerText=this.printSituation(superVisor.Situation.player.top,""),this.situationViewerBottom.innerText=this.printSituation(superVisor.Situation.player.bottom,"")}_DBG_ConsoleFold(){this.situationViewerDom.classList.remove("visible")}_DBG_ConsoleUnfold(){this.situationViewerDom.classList.add("visible")}_DBG_TurnOnDiceColor(e){let t=this.controller.avatars[`${e}`];for(const e of Array(t.dices.length).keys()){let i=e/t.dices.length;t.SetDiceMaterialColor(e,[i,1,.75])}}_DBG_TurnOffDiceColor(e){let t=this.controller.avatars[`${e}`];for(const e of Array(t.dices.length).keys())t.ResetDiceMaterialColor(e)}_DBG_TurnOnFaceColor(e){let t=this.controller.avatars[`${e}`];for(const e of Array(t.dices.length).keys())t._DBG_SetDiceFaceColor(e)}_DBG_TurnOffFaceColor(e){let t=this.controller.avatars[`${e}`];for(const e of Array(t.dices.length).keys())t._DBG_ResetDiceFaceColor(e)}}let Ht=null;class Nt{constructor(e){if(Ht)return Ht;Ht=this,this.canvas=e,this.debug=new z,this.sizes=new $,this.scene=new y.Scene,this.physics=new V,this.resources=new Ze(Je),this.godFavorsInfo=Ke,this.godFavorsAction=tt,this.godFavorsNotice=it,this.camera=new H,this.renderer=new N,this.geometry=new xt,this.material=new gt,this.sound=new yt,this.modelDictionary=new It,this.controller=new zt,this.world=new qe,this.time=new U,this.mouseManager=new st,this.postProcessor=new _t(this.renderer.instance),this.inputAdmin=new ot,this.controller.inputAdmin=this.inputAdmin,this.redbird=new jt,this.curvedCube=new Pt,window.OnlineMode=e=>{this.OnlineMode(e)},this.resources.on("ready",(()=>{this.RegisterEventsOfGame(),this.dbg_ui=new Lt})),this.ui=new At,this.controller.ui=this.ui,this.sizes.on("resize",(()=>{this.resize()})),this.time.on("tick",(e=>{this.update(e)})),this.mouseManager.on("hover_on",((e,t)=>{let i=this.controller.__FindFromDictionary(t);null!=i&&i.Hover_On(),this.postProcessor.hover_on(e),this.ui.hover_on(t)})),this.mouseManager.on("hover_off",(e=>{if(e){let t=e.id,i=this.controller.__FindFromDictionary(t);null!=i&&i.Hover_Off()}this.postProcessor.hover_off(),this.ui.hover_off()})),this.mouseManager.on("empty",(e=>{this.ui.emptyclick()}))}resize(){this.camera.resize(),this.renderer.resize(),this.postProcessor.resize(),this.ui.resize()}update(e){this.ui.update(),"visible"==document.visibilityState&&this.postProcessor.update(),this.controller.update(),this.mouseManager.update(e),this.material.Update(e)}destroy(){this.sizes.off("resize"),this.time.off("tick"),this.mouseManager.off("hover_on"),this.mouseManager.off("hover_off"),this.mouseManager.off("deactive_objects"),this.mouseManager.off("active_object"),this.scene.traverse((e=>{if(e instanceof y.Mesh){e.geometry.dispose();for(const t in e.material){const i=e.material[t];i&&"function"==typeof i.dispose&&i.dispose()}}})),this.camera.controls.dispose(),this.renderer.instance.dispose(),this.debug.active&&this.debug.ui.destroy()}GameOver(){this.time.GameOver(),setTimeout((()=>{this.redSocket.SetState("waiting"),window.BlackOn().then((()=>{window.GameScreenOff(),window.BlackOff()}))}),7e3)}Surrender(){this.redbird.MessageEnqueue("Surrender",[])}OfflineMode(){this.redbird=new jt,this.bluebird=new $t,this.redSocket=new Ut,this.blueSocket=new Ut,this.redSocket.othersocket=this.blueSocket,this.redSocket.partnerbird=this.redbird,this.blueSocket.othersocket=this.redSocket,this.blueSocket.partnerbird=this.bluebird,this.redbird.socket=this.redSocket,this.bluebird.socket=this.blueSocket,this.redbird.controller=this.controller,this.bluebird.game=this.game,this.RegisterEventsOfGame(),this.orangebird=new jt}OnlineMode(e){this.online={active:!0},this.redSocket=e,this.redbird.socket=this.redSocket,this.redSocket.partnerbird=this.redbird,this.redbird.controller=this.controller,window.BlackOn(),setTimeout((()=>{window.GameScreenOn(),window.BlackOff(),setTimeout((()=>{this.controller.state=!0}),1500)}),2500)}ProposeDoubleGame(){this.inputAdmin.ProposeDoubleGame()}BellPush(e,t){"godfavor"==this.controller.GetPhase()&&(this.controller.avatars.bottom.HealthStonesInteractOff(),this.ui.showDescription("Waiting for opponent")),this.inputAdmin.BellPush(e,t)}SendCheck(){this.redbird.MessageEnqueue("CheckReady",[])}BellPush_Liberty(e,t){let i=[],s=this.controller.avatars.bottom.index;this.controller.godFavorCardsState.forEach(((e,t)=>{"chosen"==e&&i.push(t)})),t?this.BellPush(e,{user:s,godfavors:i}):e==this.controller.avatars.bottom.index?this.BellPush(e,{user:e,godfavors:i}):"client"==e?3==i.length?(this.BellPush(e,{user:s,godfavors:i}),this.ui.showDescription("Waiting opponent's choice")):this.ui.showAlertDuration("Select not completed.",2):this.BellPush(e,{user:e,godfavors:[3*e,3*e+1,3*e+2]})}BellPush_Draft(e){let t=this.controller.picked_card,i=this.controller.banned_card,s=t.authorization?t.index:null,o=i.authorization?i.index:null;if(e)return this.BellPush("client",{pick:s,ban:o}),t.authorization=!1,void(i.authorization=!1);t.authorization&&-1==t.index||i.authorization&&-1==i.index?this.ui.showAlertDuration("Ban & pick not completed.",2):(this.BellPush("client",{pick:s,ban:o}),t.authorization=!1,i.authorization=!1)}ClickHealthStone(e,t,i){i.index=this.controller.avatars[e].health-t,this.BellPush(e,i),this.controller.avatars[e].HealthStonesInteractOff()}RegisterEventsOfGame(){this.mouseManager.on("button-push",((e,t)=>{if("cardselect"===this.controller.GetPhase()){let i=this.controller.game_mode;"liberty"===i?this.BellPush_Liberty(e,t):"draft"===i&&this.BellPush_Draft(t)}else this.BellPush(e,null)})),this.mouseManager.on("select",(e=>{let t=this.world.gameObjects[`${e}`],i=this.inputAdmin.ObjectSelected(t,!1);i&&"healthstone"===i.type&&this.ClickHealthStone(i.avatar,i.index,i)})),this.mouseManager.on("contextmenu",(e=>{let t=this.world.gameObjects[`${e}`];this.inputAdmin.ObjectSelected(t,!0)})),this.ui.on("god_favor_action",((e,t,i,s)=>{this.controller.avatars.bottom.godFavors[e].Highlight_On(),this.ui.emptyclick(),this.ui.hideDescription(),s.extraInput?new Promise((e=>{setTimeout((()=>{e(!0)}),700)})).then((()=>{this.controller.SetExtraPickedDiceCnt(s.effectValue[t]),this.inputAdmin.TmpStorageInputInfo(e,t),this.controller.EnableExtraInputDice(s.extraInput)})):(this.BellPush(i,{godFavorIndex:e,level:t}),this.ui.emptyclick())}))}}new Nt(document.querySelector("canvas.webgl")),window.experience=new Nt;